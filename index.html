<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Maths Quest: Infinity</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Russo+One&display=swap" rel="stylesheet">
<style>
    /* --- VARIABLES --- */
    :root { --bg-dark: #050414; --bg-mid: #1a1a38; --accent: #00d2d3; --text: #ffffff; --gold: #f1c40f; }
    
    /* FONDS */
    body { margin: 0; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); font-family: 'Montserrat', sans-serif; color: var(--text); overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; min-height: 100vh; padding-bottom: 100px; transition: background 1s ease; }
    body.unlock-mode { background: radial-gradient(circle at center, #3a2e05 0%, #050414 90%); }
    body.prestige-mode { background: radial-gradient(circle at center, #4b3d04 0%, #000000 90%); }
    
    /* PRESTIGE STYLES */
    body.prestige-mode .world-card-global { border-color: #ffd700; box-shadow: 0 0 35px rgba(255, 215, 0, 0.4); }
    body.prestige-mode .world-title-global { color: #ffd700; }
    body.prestige-mode .lvl-btn.current { background: #ffd700; color: #000; box-shadow: 0 0 30px #ffd700; }
    
    /* BOUTONS LEGEND (MONDE 26) */
    .lvl-btn.legend { border-color: #ffd700; color: #ffd700; background: rgba(0,0,0,0.8); font-size: 0.9rem; letter-spacing: 1px; width: 90px; height: 90px; }
    .lvl-btn.legend.completed { background: linear-gradient(135deg, #ffd700, #e67e22); color: #000; text-shadow: none; box-shadow: 0 0 25px #ffd700; border: 2px solid #fff; }
    .lvl-btn.legend.current { animation: legendPulse 1.5s infinite; background: rgba(255, 215, 0, 0.2); }
    @keyframes legendPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

    /* --- BOUTON VERS L'INFINI --- */
    .energy-gate {
        width: 90%; max-width: 450px; margin: 0 auto 80px auto; padding: 30px;
        background: rgba(20, 20, 30, 0.9); border: 3px solid #555; border-radius: 25px;
        text-align: center; position: relative; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        transition: all 0.3s ease; z-index: 50; cursor: default;
    }
    .energy-gate.locked { opacity: 0.8; filter: grayscale(100%); }
    .energy-gate.ready {
        background: linear-gradient(135deg, #000 0%, #2c2502 100%);
        border: 4px solid #ffd700; cursor: pointer;
        box-shadow: 0 0 60px rgba(255, 215, 0, 0.6), inset 0 0 20px #ffd700;
        transform: scale(1.05); animation: gateShake 2s infinite ease-in-out;
    }
    .energy-gate.ready:active { transform: scale(0.95); }
    @keyframes gateShake { 0% { transform: scale(1.05); } 50% { transform: scale(1.08); box-shadow: 0 0 80px rgba(255, 215, 0, 1); } 100% { transform: scale(1.05); } }
    .energy-title { font-family: 'Russo One'; font-size: 1.4rem; color: #aaa; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 3px; }
    .energy-val { font-size: 1.6rem; font-weight: 900; color: #fff; }
    .energy-gate.ready .energy-title { color: #fff; text-shadow: 0 0 10px #fff; }
    .energy-gate.ready .energy-val { color: var(--gold); text-shadow: 0 0 20px var(--gold); font-size: 2.2rem; }

    /* --- √âCRAN DE VICTOIRE (CORRIG√â) --- */
    #victory-screen {
        position: fixed; 
        top: 0; 
        left: 0;
        right: 0; /* FORCE LA LARGEUR MAX */
        bottom: 0; /* FORCE LA HAUTEUR MAX */
        width: 100%; 
        height: 100dvh; /* HAUTEUR DYNAMIQUE MOBILE */
        
        background: linear-gradient(45deg, #2c003e, #000046, #1cb5e0, #8e44ad, #f39c12);
        background-size: 400% 400%; 
        animation: nebulaBg 20s ease infinite;
        
        z-index: 30000; /* AU-DESSUS DE TOUT (HUD = 20000) */
        
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 1.5s ease-in-out, visibility 0s linear 1.5s;
        overflow: hidden; 
        touch-action: none;
    }
    #victory-screen.active { opacity: 1; visibility: visible; pointer-events: all; transition: opacity 1.5s ease-in-out; }
    @keyframes nebulaBg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .victory-content { text-align: center; width: 90%; max-width: 600px; transform: scale(0.8); opacity: 0; transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s; z-index: 10002; position: relative; }
    #victory-screen.active .victory-content { transform: scale(1); opacity: 1; }
    
    .vic-icon { font-size: 6rem; margin-bottom: 20px; animation: floatIcon 3s ease-in-out infinite; text-shadow: 0 0 50px #ffd700; }
    .vic-title { font-family: 'Russo One'; font-size: 3.5rem; line-height: 1.1; background: linear-gradient(to bottom, #fff, #ffd700, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px; text-transform: uppercase; filter: drop-shadow(0 0 20px rgba(255,215,0,0.8)); }
    .vic-text { font-size: 1.3rem; color: #eee; margin-bottom: 50px; font-family: 'Montserrat'; line-height: 1.5; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    .btn-legend-action { background: linear-gradient(90deg, #f1c40f, #e67e22, #f1c40f); background-size: 200%; color: white; border: 3px solid white; padding: 20px 40px; font-family: 'Russo One'; font-size: 1.3rem; border-radius: 50px; cursor: pointer; box-shadow: 0 0 50px rgba(241, 196, 15, 0.5); animation: shineBtn 3s infinite linear; text-transform: uppercase; -webkit-tap-highlight-color: transparent; }
    .btn-legend-action:active { transform: scale(0.95); }
    @keyframes floatIcon { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(5deg); } }
    @keyframes shineBtn { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }

    /* ELEMENTS COMMUNS */
    #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
    .flash-overlay.active { opacity: 1; }
    /* Z-INDEX IMPORTANT POUR QUE LE MENU RESTE CLIQUABLE */
    #main-menu { padding: 15px; padding-top: 130px; width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; position: relative; z-index: 10; }
    #grid-container { display: flex; flex-direction: column; align-items: center; width: 100%; }

    /* CARTE MONDE */
    .world-card-global { position: relative; margin-bottom: 80px; width: 90%; max-width: 400px; aspect-ratio: 14 / 9; background-color: var(--bg-mid); background-size: cover; background-position: center; border-radius: 35px; box-shadow: 0 30px 70px rgba(0,0,0,0.9); border: 2px solid rgba(255,255,255,0.08); overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: transform 0.3s, filter 0.3s, box-shadow 0.3s; cursor: pointer; box-sizing: border-box; flex-shrink: 0; z-index: 10; }
    .world-card-global:active { filter: brightness(0.8); transition: none; }
    .world-card-global:nth-of-type(odd) { margin-right: auto; margin-left: 15%; transform: rotate(-1.5deg); }
    .world-card-global:nth-of-type(odd):hover { transform: rotate(-1.5deg) scale(1.08); z-index: 20; box-shadow: 0 40px 90px rgba(0,0,0,1); }
    .world-card-global:nth-of-type(even) { margin-left: auto; margin-right: 15%; transform: rotate(1.5deg); }
    .world-card-global:nth-of-type(even):hover { transform: rotate(1.5deg) scale(1.08); z-index: 20; box-shadow: 0 40px 90px rgba(0,0,0,1); }
    .world-card-global::before { content: ""; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(5, 4, 20, 0.3); z-index: 1; transition: all 0.5s; }
    .world-card-global.locked-next::before { background: rgba(10, 12, 25, 0.95); backdrop-filter: blur(20px) grayscale(90%); }
    .world-info-global { position: relative; z-index: 5; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
    .world-title-global { font-family: 'Russo One'; font-size: 1.7rem; text-transform: uppercase; color: #fff; text-shadow: 0 4px 15px rgba(0,0,0,0.9); margin-bottom: 8px; text-align: center; line-height: 1.2; }
    .world-status-global { font-size: 1.3rem; color: var(--gold); font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,1); display: block; }
    
    .gate-locked { margin: auto; z-index: 10; width: 85%; height: 90px; padding: 0; background: transparent; border: none; pointer-events: auto; }
    .btn-unlock-world { width: 100%; height: 100%; border-radius: 25px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(180deg, rgba(60, 60, 70, 0.8) 0%, rgba(30, 30, 40, 0.9) 100%); backdrop-filter: blur(15px); border: 2px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); font-family: 'Russo One'; font-size: 1.3rem; text-transform: uppercase; letter-spacing: 2px; cursor: not-allowed; transition: all 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
    .btn-unlock-world .req-stars { font-size: 1rem; margin-top: 5px; font-weight: 700; color: #fab1a0; font-family: 'Russo One', sans-serif; display: flex; align-items: center; gap: 8px; }
    .btn-unlock-world.ready { background: linear-gradient(135deg, #f1c40f 0%, #e67e22 100%); border: 3px solid #fff; color: #fff; cursor: pointer; box-shadow: 0 0 60px rgba(241, 196, 15, 0.6); transform: scale(1.05); animation: pulseGold 2s infinite; }
    .btn-unlock-world.ready:hover { transform: scale(1.1); box-shadow: 0 0 80px rgba(241, 196, 15, 0.8); }

    /* DETAIL & JEU */
    #world-detail-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-dark); background-size: cover; background-position: center; z-index: 60; display: flex; flex-direction: column; transform: scale(1.2); opacity: 0; pointer-events: none; transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s; }
    #world-detail-screen.active { transform: scale(1); opacity: 1; pointer-events: all; }
    #world-detail-screen::before { content: ""; position: absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(to bottom, rgba(5,4,20,0.9) 0%, rgba(5,4,20,0.6) 50%, rgba(5,4,20,0.95) 100%); z-index: 0; }
    .detail-scroll-area { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; overflow-x: hidden; z-index: 2; display: flex; flex-direction: column; align-items: center; padding-top: 150px; padding-bottom: 100px; scrollbar-width: none; }
    .btn-back-world { position: absolute; top: 110px; left: 30px; z-index: 70; background: rgba(255,255,255,0.1); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .lvl-btn { width: 80px; height: 80px; border-radius: 50%; margin: 25px 0; flex-shrink: 0; background: rgba(30, 30, 45, 0.9); border: 2px solid rgba(255,255,255,0.3); color: white; font-family: 'Russo One', sans-serif; font-size: 1.8rem; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; box-shadow: 0 15px 30px rgba(0,0,0,0.7); backdrop-filter: blur(5px); transition: transform 0.3s; }
    .lvl-btn.current { background: #00cec9; border-color: #fff; color: #000; box-shadow: 0 0 50px #00cec9; transform: scale(1.3); z-index: 3; }
    .lvl-btn.locked { background: rgba(15,15,25,0.8); border-color: #444; color: #555; pointer-events: none; }
    .lvl-btn:nth-child(4n+1) { transform: translateX(0); } .lvl-btn:nth-child(4n+2) { transform: translateX(80px); } .lvl-btn:nth-child(4n+3) { transform: translateX(0); } .lvl-btn:nth-child(4n+4) { transform: translateX(-80px); }
    .stars-icon { font-size: 0.8rem; position: absolute; bottom: -18px; color: #fdcb6e; background: rgba(0,0,0,0.9); padding: 4px 10px; border-radius: 15px; box-shadow: 0 2px 5px black; }
    /* UI FIXES */
    .frac { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; font-size: 0.6em; margin: 0 4px; }
    .frac sup { position: static; border-bottom: 2px solid white; padding-bottom: 1px; line-height: 1; }
    .frac sub { position: static; padding-top: 1px; line-height: 1; }
    
    .hud-top { position: fixed; top: 0; left: 0; width: 100%; height: 90px; background: linear-gradient(to bottom, rgba(0,0,0,1), transparent); z-index: 20000; display: grid; grid-template-columns: 60px 1fr 60px; align-items: center; justify-items: center; padding: 0 15px; box-sizing: border-box; text-shadow: 0 2px 5px black; pointer-events: auto; }
    .stat-val { font-family: 'Russo One', sans-serif; font-size: 1.4rem; color: #fff; display:block;} 
    .stat-label { font-size: 0.7rem; opacity:0.8; text-transform: uppercase; font-weight: 700; }
    .stars-display { justify-self: end; text-align: right; }
    .settings-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: white; z-index: 91; transition: transform 0.3s; } 
    .settings-btn:hover { transform: rotate(90deg) scale(1.1); }
    .hearts-wrapper { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .heart-icons { font-size: 1.2rem; letter-spacing: 2px; }
    .heart-lost { opacity: 0.2; filter: none; } 
    .regen-timer { font-size: 0.7rem; color: #fab1a0; font-weight: 700; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; margin-top: 2px; }
    .infinity-lives { font-size: 2rem; color: #ffd700; font-weight: bold; text-shadow: 0 0 10px #ffd700; animation: pulseLives 1.5s infinite; }
    @keyframes pulseLives { 50% { transform: scale(1.3); } }
    .penalty-float { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #d63031; font-weight: 900; font-size: 4rem; pointer-events: none; z-index: 200; animation: floatUp 0.8s ease-out forwards; text-shadow: 0 0 10px white; }
    @keyframes floatUp { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); } }
    #result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 300; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(8px); }
    #result-modal.active { opacity: 1; pointer-events: all; }
    .modal-card { background: #1e1e2e; padding: 40px 30px; border-radius: 30px; text-align: center; width: 85%; max-width: 350px; border: 2px solid rgba(255,255,255,0.1); transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
    #result-modal.active .modal-card { transform: scale(1); }
    .modal-emoji { font-size: 4rem; margin-bottom: 10px; display: block; }
    .modal-title { font-family: 'Russo One', sans-serif; font-size: 2rem; color: white; margin-bottom: 5px; text-transform: uppercase; }
    .modal-subtitle { font-size: 1.1rem; color: #a29bfe; margin-bottom: 30px; font-weight: bold; }
    .modal-hint { font-size: 1rem; color: #fdcb6e; margin-bottom: 20px; font-style: italic; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; display: none; }
    .modal-hint.show { display: block; }
    .btn-modal { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: white; border: none; padding: 15px 30px; font-family: 'Russo One', sans-serif; font-size: 1.2rem; border-radius: 50px; cursor: pointer; width: 100%; box-shadow: 0 10px 20px rgba(0, 184, 148, 0.4); transition: transform 0.2s; }
    .btn-modal:hover { transform: scale(1.05); }
    .btn-modal.fail { background: linear-gradient(135deg, #d63031 0%, #ff7675 100%); box-shadow: 0 10px 20px rgba(214, 48, 49, 0.4); }
    /* --- ECRAN DE JEU (CORRECTIF SCROLL & HAUTEUR) --- */
    #game-screen { 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; 
        height: 100dvh; /* Force la hauteur r√©elle sans barre de nav */
        
        background: rgba(10, 8, 25, 0.95); 
        backdrop-filter: blur(10px); 
        z-index: 25000; /* Au-dessus du HUD */
        
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: flex-start; /* Aligne en haut */
        padding-top: 90px; /* Espace pour la barre du haut */
        box-sizing: border-box; 
        
        transform: translateY(100%); 
        visibility: hidden; /* CRUCIAL : Rend l'√©l√©ment inexistant quand ferm√© */
        
        /* Transition : on attend que l'anim finisse pour cacher la visibilit√© */
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), visibility 0s linear 0.3s;
        
        /* Emp√™che le zoom et le scroll √©lastique sur le jeu */
        touch-action: none; 
        overscroll-behavior: none;
    }

    #game-screen.active { 
        transform: translateY(0); 
        visibility: visible; 
        transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), visibility 0s linear 0s;
    }
    #game-screen.error-flash { animation: flashRed 0.4s ease-out; } @keyframes flashRed { 0%, 100% { background: rgba(10, 8, 25, 0.85); } 50% { background: rgba(100, 30, 30, 0.85); } }
    .q-display { font-family: 'Russo One', sans-serif; font-size: 3.5rem; margin: 15px 0; text-align: center; color: #fff; text-shadow: 0 2px 10px black; } .inp-display { font-family: 'Russo One', sans-serif; font-size: 3rem; min-width: 240px; padding: 0 25px; margin-bottom: 25px; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.1); border-radius: 16px; text-align: center; color: #00d2d3; height: 80px; line-height: 80px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
    .numpad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 95%; max-width: 380px; } .key { padding: 18px 0; font-size: 1.5rem; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; font-family: 'Montserrat', sans-serif; background: #383a45; color: #fff; box-shadow: 0 4px 0 #222; transition: all 0.1s; } .key:hover { background: #4a4d5a; } .key:active { transform: translateY(4px); box-shadow: 0 0 0 #222; } .k-ok { background: #00b894; color: white; grid-column: span 4; margin-top: 10px; box-shadow: 0 4px 0 #00796b; font-family: 'Russo One', sans-serif; } .k-del { background: #d63031; } .k-op { background: #0984e3; } .k-frac { background: #e17055; } /* Croix descendue √† 100px pour passer sous la barre du haut (90px) */
    .k-close { 
        position: absolute; 
        top: 100px; 
        right: 20px; 
        background: rgba(255,255,255,0.1); 
        border: none; 
        border-radius: 50%; 
        width: 45px; 
        height: 45px; 
        color: white; 
        font-size: 2rem; 
        cursor: pointer; 
        transition: all 0.2s; 
        z-index: 101; /* Pour √™tre s√ªr qu'elle soit au-dessus du contenu du jeu */
    }
    .k-close:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }
    .bars-container { width: 85%; max-width: 380px; margin-bottom: 10px; } .timer-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-bottom: 10px; overflow: hidden; } .timer-bar-fill { height: 100%; background: #00d2d3; width: 100%; transition: width 1s linear, background 0.3s; } .timer-bar-fill.medium { background: #fdcb6e; } .timer-bar-fill.low { background: #d63031; } .level-progress-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; } .level-progress-fill { height: 100%; background: #6c5ce7; width: 0%; transition: width 0.3s; } .progress-text { font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 5px; font-weight: 700; text-align: right; }
    #settings-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; } #settings-screen.active { opacity: 1; pointer-events: all; }
    .settings-content { background: #2d3436; padding: 40px; border-radius: 25px; width: 85%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.1); } .setting-row { margin: 20px 0; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; font-weight: bold; } .switch { position: relative; display: inline-block; width: 60px; height: 34px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #00cec9; } input:checked + .slider:before { transform: translateX(26px); } .btn-toggle-creative { background: #6c5ce7; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; } .btn-danger { background: #d63031; color: white; border: none; padding: 12px; width: 100%; margin-top: 25px; cursor: pointer; border-radius: 8px; font-weight: bold; } .btn-close-settings { background: #b2bec3; color: #2d3436; border: none; padding: 12px; width: 100%; margin-top: 15px; cursor: pointer; border-radius: 8px; font-weight: bold; }
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; } @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
/* --- OPTIMISATION MOBILE (RESPONSIVE) --- */
    /* --- OPTIMISATION MOBILE FINALE (RESPONSIVE) --- */
    /* --- OPTIMISATION MOBILE FINALE --- */
    @media (max-width: 480px) {
        /* Emp√™che le scroll horizontal et √©lastique sur tout le site */
        html, body { 
            overflow-x: hidden; 
            overscroll-behavior: none; 
            height: 100dvh; 
        }

        /* 1. D√âZOOM DU MENU */
        #grid-container {
            zoom: 0.8; /* R√©duit √† 80% */
            width: 100%;
            padding-bottom: 150px;
        }

        /* 2. ADAPTATION JEU (ANTI-D√âBORDEMENT) */
        #game-screen { 
            padding-top: 80px; 
            justify-content: space-evenly; /* R√©partit l'espace verticalement */
            padding-bottom: 20px;
        }

        /* R√©duction des textes pour √©viter que √ßa sorte */
        .q-display { font-size: 2.5rem; margin: 0; text-shadow: 0 2px 5px black; }
        .inp-display { height: 55px; line-height: 55px; font-size: 2rem; min-width: 160px; margin-bottom: 10px; }
        #g-instr { min-height: 20px; margin: 5px 0; font-size: 0.85rem; }

        /* Clavier compact */
        .numpad { gap: 8px; width: 94%; max-height: 45vh; }
        .key { padding: 10px 0; font-size: 1.4rem; border-radius: 12px; }

        /* Barre du haut compacte */
        .hud-top { height: 70px; padding: 0 5px; z-index: 26000; /* Au-dessus du jeu */ }
        .stat-val { font-size: 0.9rem; }
        .stat-label { font-size: 0.6rem; }
        .settings-btn { font-size: 1.4rem; }
        .heart-icons { font-size: 1rem; letter-spacing: 1px; }

        /* Croix de fermeture bien plac√©e */
        .k-close { top: 80px; right: 10px; width: 40px; height: 40px; font-size: 1.5rem; }
            width: 50px; height: 50px; 
            background: rgba(255, 50, 50, 0.3); border: 1px solid rgba(255,255,255,0.2);
            z-index: 27000;
        }
        
        /* Victoire */
        .vic-title { font-size: 11vw; }
        .vic-icon { font-size: 4rem; }
    }
    
    /* S√©curit√© petits iPhone (SE) */
    @media (max-height: 670px) {
        .q-display { font-size: 2rem; }
        .key { padding: 6px 0; font-size: 1.2rem; }
        .inp-display { height: 45px; line-height: 45px; margin-bottom: 5px; }
        .bars-container { margin-bottom: 5px; transform: scale(0.9); }
        .world-card-global { margin-bottom: 30px; }
    }
        
        /* Barre du haut (HUD) plus fine */
        .hud-top { height: 70px; padding: 0 10px; }
        .stat-val { font-size: 1.1rem; }
        .settings-btn { font-size: 1.5rem; }
        .heart-icons { font-size: 1rem; }
        
        /* On remonte le jeu car la barre du haut est plus petite */
        #game-screen { padding-top: 85px; } 
        
        /* Question et r√©ponse plus petites pour ne pas d√©border */
        .q-display { font-size: 2.5rem; margin: 10px 0; }
        .inp-display { height: 60px; line-height: 60px; font-size: 2.2rem; min-width: 200px; margin-bottom: 15px; }
        
        /* Clavier num√©rique plus compact */
        .numpad { gap: 8px; width: 92%; }
        .key { padding: 12px 0; font-size: 1.3rem; border-radius: 10px; }
        
        /* On remonte la croix pour qu'elle soit accessible */
        .k-close { top: 80px; right: 15px; width: 40px; height: 40px; font-size: 1.5rem; }

        /* Boutons de niveaux l√©g√®rement r√©duits */
        .lvl-btn { width: 70px; height: 70px; font-size: 1.4rem; margin: 15px 0; }
        /* Ajustement de la courbe du serpentin pour petits √©crans */
        .lvl-btn:nth-child(4n+2) { transform: translateX(60px); }
        .lvl-btn:nth-child(4n+4) { transform: translateX(-60px); }
    }
    
    /* S√©curit√© suppl√©mentaire pour les √©crans peu hauts (ex: iPhone SE) */
    @media (max-height: 650px) {
        .q-display { margin: 5px 0; font-size: 2rem; }
        .key { padding: 8px 0; }
        .inp-display { margin-bottom: 10px; }
        .bars-container { margin-bottom: 5px; }
        #g-instr { min-height: 20px; font-size: 0.9rem; margin: 5px 0 10px 0; }
    }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div class="flash-overlay" id="flash-effect"></div>

<div id="victory-screen">
    <canvas id="victory-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index: 10001; pointer-events:none;"></canvas>
    <div class="victory-content">
        <div class="vic-icon">üèÜ</div>
        <div class="vic-title">F√âLICITATIONS</div>
        <div class="vic-text">Tu as ma√Ætris√© l'infini et termin√© Maths Quest.</div>
        <button class="btn-legend-action" onclick="window.finishGame()">ENTRER DANS LA L√âGENDE</button>
    </div>
</div>

<div class="hud-top">
    <button class="settings-btn" style="justify-self: start;" onclick="window.settings.open()">‚öôÔ∏è</button>
    <div class="hearts-wrapper"><div id="ui-hearts" class="heart-icons">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><span id="ui-life-timer" class="regen-timer">MAX</span></div>
    <div class="stars-display"><span class="stat-val">‚≠ê <span id="ui-stars">0</span></span><span class="stat-label">TOTAL</span></div>
</div>

<div id="settings-screen">
    <div class="settings-content">
        <h2 style="font-family:'Russo One'" onclick="window.settings.triggerSecret()">PARAM√àTRES</h2>
        <div class="setting-row"><span>üì≥ Vibrations</span><label class="switch"><input type="checkbox" id="toggle-vib" onchange="window.settings.save()"><span class="slider"></span></label></div>
        <button id="btn-exit-dev" class="btn-toggle-creative" style="display:none; background:#e17055;" onclick="window.settings.exitDevMode()">D√âSACTIVER MODE DEV</button>
        <hr style="border-color:rgba(255,255,255,0.1); margin: 25px 0;">
        <button class="btn-danger" onclick="window.settings.resetData()">üóëÔ∏è R√©initialiser</button>
        <button class="btn-close-settings" onclick="window.settings.close()">Fermer</button>
    </div>
</div>

<div id="result-modal">
    <div class="modal-card">
        <div id="res-emoji" class="modal-emoji">üèÜ</div>
        <div id="res-title" class="modal-title">BRAVO !</div>
        <div id="res-sub" class="modal-subtitle">+3 √âtoiles</div>
        <div id="res-hint" class="modal-hint"></div>
        <button id="res-btn" class="btn-modal" onclick="window.game.closeFromModal()">CONTINUER</button>
    </div>
</div>

<div id="main-menu">
    <div id="grid-container"></div>
</div>

<div id="world-detail-screen">
    <button class="btn-back-world" onclick="window.game.closeWorld()">‚Üê</button>
    <div class="detail-scroll-area" id="detail-scroll-area"></div>
</div>

<div id="game-screen">
    <button class="k-close" onclick="window.game.close()">√ó</button>
    <div style="color:rgba(255,255,255,0.4); font-weight:bold; letter-spacing:2px; text-transform:uppercase; font-size:0.8rem;">Niveau <span id="g-lvl-num" style="color:white; font-size:1.2rem;">1</span></div>
    <div id="g-instr" style="color:#fdcb6e; font-size:1.1rem; margin: 10px 0 20px 0; font-style:italic; min-height:25px; text-align:center; padding:0 20px; font-weight:500;"></div>
    <div class="bars-container">
        <div class="timer-bar-container"><div class="timer-bar-fill" id="g-timer-bar"></div></div>
        <div class="level-progress-container"><div class="level-progress-fill" id="g-prog-bar"></div></div>
        <div class="progress-text"><span id="g-prog-txt">0</span> / <span id="g-target-txt">20</span></div>
    </div>
    <div class="q-display" id="g-quest">?</div>
    <div class="inp-display" id="g-inp"></div>
    <div class="numpad">
        <button class="key" onclick="window.game.tap('7')">7</button><button class="key" onclick="window.game.tap('8')">8</button><button class="key" onclick="window.game.tap('9')">9</button>
        <button class="key k-frac" onclick="window.game.tap('/')">√∑</button>
        <button class="key" onclick="window.game.tap('4')">4</button><button class="key" onclick="window.game.tap('5')">5</button><button class="key" onclick="window.game.tap('6')">6</button><button class="key k-op">√ó</button>
        <button class="key" onclick="window.game.tap('1')">1</button><button class="key" onclick="window.game.tap('2')">2</button><button class="key" onclick="window.game.tap('3')">3</button><button class="key k-op">-</button>
        <button class="key" onclick="window.game.tap('0')">0</button><button class="key" onclick="window.game.tap('.')">,</button><button class="key k-del" onclick="window.game.tap('DEL')">‚å´</button><button class="key k-op">+</button>
        <button class="key k-ok" onclick="window.game.validate()">VALIDER</button>
    </div>
</div>

<script>
    function generateProblem(lvl) {
        let themeIdx = (lvl - 1) % 20; 
        let world = Math.ceil(lvl / 20); 
        let rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        let n1, n2, ans, op;
        let instr = "Calcule :", hint = "", format = 'any';

        switch(themeIdx) {


// ==============================================
// ‚¨áÔ∏è INS√àRE ICI LA PARTIE 2 (LES CAS 0 √Ä 19) ‚¨áÔ∏è
// ==============================================













case 0: // COMPLEMENTS
                // --- MONDES 1 √† 5 : BASES (PRIMAIRE) ---
                if (world == 1) { 
                    n1 = rand(1, 9);
                    ans = 10 - n1;
                    op = `10 - ${n1}`;
                    instr = "Compl√©ment √† 10 :";
                    hint = "Cherche l'ami pour faire 10.";
                } 
                else if (world == 2) { 
                    n1 = rand(11, 19);
                    ans = 20 - n1;
                    op = `20 - ${n1}`;
                    instr = "Compl√®te √† 20 :";
                    hint = "Regarde l'unit√©, compl√®te √† 10.";
                } 
                else if (world == 3) { 
                    n1 = rand(21, 89);
                    if (n1 % 10 === 0) n1++; 
                    let sup = Math.ceil(n1 / 10) * 10;
                    ans = sup - n1;
                    op = `${n1} pour aller √† ${sup} ?`;
                    instr = "Dizaine sup√©rieure :";
                    hint = "Combien d'unit√©s manquent ?";
                } 
                else if (world == 4) { 
                    n1 = rand(2, 19) * 5; 
                    ans = 100 - n1;
                    op = `100 - ${n1}`;
                    instr = "Compl√®te √† 100 :";
                    hint = "Compte par pas de 5.";
                } 
                else if (world == 5) { 
                    n1 = rand(11, 89);
                    ans = 100 - n1;
                    op = `100 - ${n1}`;
                    instr = "Soustraction :";
                    hint = "Unit√©s=10, Dizaines=9.";
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (TEMPS & D√âCIMAUX) ---
                else if (world == 6) { 
                    n1 = rand(15, 55);
                    ans = 60 - n1;
                    op = `1h00 - 0h${n1}`;
                    instr = "Minutes restantes :";
                    hint = "Compl√©ment √† 60.";
                } 
                else if (world == 7) { 
                    n1 = rand(123, 876);
                    ans = 1000 - n1;
                    op = `1000 - ${n1}`;
                    instr = "Compl√®te le millier :";
                    hint = "Dernier chiffre fait 10, les autres 9.";
                } 
                else if (world == 8) { 
                    let v = rand(1, 9);
                    n1 = v / 10;
                    ans = parseFloat((1 - n1).toFixed(1));
                    op = `1 - ${n1}`;
                    instr = "Compl√®te l'unit√© :";
                    hint = "Comme 10 - " + v + ".";
                } 
                else if (world == 9) { 
                    let v = rand(11, 89);
                    if (v % 10 === 0) v++; 
                    n1 = v / 100;
                    ans = parseFloat((1 - n1).toFixed(2));
                    op = `1 - ${n1}`;
                    instr = "Rendu de monnaie sur 1‚Ç¨ :";
                    hint = "Calcule 100 - " + v + ".";
                } 
                else if (world == 10) { 
                    let ent = rand(1, 50);
                    let dec = rand(1, 9);
                    n1 = parseFloat(ent + "." + dec);
                    ans = parseFloat((1 - (dec/10)).toFixed(1));
                    op = `${n1} pour aller √† ${ent + 1}`;
                    instr = "Entier suivant :";
                    hint = "Regarde uniquement apr√®s la virgule.";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (RETENUES & CONVERSION) ---
                else if (world == 11) { 
                    let v = rand(10, 80);
                    let d = rand(1, 9);
                    n1 = parseFloat(v + "." + d);
                    ans = parseFloat((100 - n1).toFixed(1));
                    op = `100 - ${n1}`;
                    instr = "Attention √† la virgule :";
                    hint = "Pense 100,0 - " + n1;
                } 
                else if (world == 12) { 
                    n1 = rand(12, 88) * 10; 
                    ans = 10000 - n1; 
                    op = `10 000 - ${n1}`;
                    instr = "Gros √©cart :";
                    hint = "Compte les milliers et centaines.";
                } 
                else if (world == 13) { 
                    let hStart = rand(8, 16);
                    let gap = rand(2, 5);
                    let m = rand(12, 48);
                    n1 = `${hStart}h${m}`;
                    let targetH = hStart + gap;
                    let resM = 60 - m;
                    let resH = gap - 1;
                    ans = resH * 60 + resM; 
                    op = `De ${n1} √† ${targetH}h00`;
                    instr = "R√©ponse en minutes totales :";
                    hint = `${resH}h et ${resM}min... convertis tout en min.`;
                } 
                else if (world == 14) { 
                    let v = rand(111, 889);
                    n1 = v / 1000;
                    ans = parseFloat((1 - n1).toFixed(3));
                    op = `1 - ${n1}`;
                    instr = "Milli√®mes :";
                    hint = "1000 - " + v;
                } 
                else if (world == 15) { 
                    let ent = rand(1, 35);
                    n1 = ent + 0.5;
                    ans = 50 - n1;
                    op = `50 - ${n1}`;
                    instr = "Le compte est bon :";
                    hint = "Enl√®ve le 0.5 d'abord.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (CHARGES MENTALES) ---
                else if (world == 16) { 
                    let ent = rand(10, 85);
                    let dec = rand(11, 89);
                    n1 = parseFloat(ent + "." + dec);
                    ans = parseFloat((100 - n1).toFixed(2));
                    op = `100 - ${n1}`;
                    instr = "Double retenue :";
                    hint = "99, 9 et 10.";
                } 
                else if (world == 17) { 
                    n1 = rand(1234, 8765);
                    ans = 10000 - n1;
                    op = `10 000 - ${n1}`;
                    instr = "4 chiffres √† g√©rer :";
                    hint = "Tout √† 9, le dernier √† 10.";
                } 
                else if (world == 18) { 
                    let u = rand(1, 8);
                    let d = rand(1, 9);
                    n1 = parseFloat((990 + u + d/10).toFixed(1)); 
                    ans = parseFloat((1000 - n1).toFixed(1));
                    op = `1000 - ${n1}`;
                    instr = "Tout petit √©cart :";
                    hint = "Visualise 1000,0";
                } 
                else if (world == 19) { 
                    let min = rand(10, 50);
                    let sec = rand(10, 50);
                    op = `De 0h ${min}m ${sec}s √† 1h 00m 00s`;
                    ans = (59 - min) * 60 + (60 - sec);
                    instr = "R√©ponse en secondes :";
                    hint = `Il manque ${59-min} min et ${60-sec} s. Convertis tout.`;
                } 
                else if (world == 20) { 
                    let a = rand(100, 500) / 10; 
                    let b = rand(100, 500) / 10; 
                    n1 = b;
                    ans = parseFloat((a + b).toFixed(1));
                    op = `? - ${b} = ${a}`;
                    instr = "Retrouve le total :";
                    hint = "C'est une addition cach√©e.";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (SATURATION COGNITIVE) ---
                else if (world == 21) { 
                    let ent = rand(100, 800);
                    let dec = rand(15, 95);
                    n1 = parseFloat(ent + "." + dec);
                    ans = parseFloat((1000 - n1).toFixed(2));
                    op = `1000 - ${n1}`;
                    instr = "Remplis le millier :";
                    hint = "999, 9 et 10.";
                } 
                else if (world == 22) { 
                    let v = rand(12345, 87654);
                    n1 = v / 100000; 
                    ans = parseFloat((1 - n1).toFixed(5));
                    op = `1 - ${n1}`;
                    instr = "Pr√©cision max (5 d√©cimales) :";
                    hint = "La r√®gle du 9 s'applique 4 fois, puis 10.";
                } 
                else if (world == 23) { 
                    n1 = rand(123456, 876543);
                    ans = 1000000 - n1;
                    let n1Display = n1.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    op = `1 000 000 - ${n1Display}`;
                    instr = "Le million :";
                    hint = "Il faut retenir 6 chiffres.";
                } 
                else if (world == 24) { 
                    let start = rand(100, 200); 
                    n1 = parseFloat((start + 0.02).toFixed(2)); 
                    let sub = parseFloat((0.05 + rand(1,4)/100).toFixed(2)); 
                    ans = parseFloat((n1 - sub).toFixed(2));
                    op = `${n1} - ${sub}`;
                    instr = "Passe la barre :";
                    hint = "Attention, on descend sous l'entier.";
                } 
            // --- MONDE 25 : BOSS FINAL ---
                else if (world == 25) { 
                    let ent = rand(1000, 4000);
                    let dec = rand(11, 99);
                    n1 = parseFloat(ent + "." + dec);
                    ans = parseFloat((5000 - n1).toFixed(2));
                    op = `5000 - ${n1}`;
                    instr = "CALCUL ULTIME :";
                    hint = "G√®re les retenues sur 4000, 900, 90, 9 et 10.";
                }
                // --- MONDE 26 : L√âGENDE ---
                else {
                    let c0_base = rand(1, 10);
                    let c0_val = rand(123, 987);
                    n1 = c0_val / 100000;
                    ans = parseFloat((c0_base - n1).toFixed(5));
                    op = `${c0_base} - ${n1}`;
                    instr = "Pr√©cision chirurgicale :";
                    hint = "G√®re les 9 successifs jusqu'au dernier chiffre.";
                }
                break;

            case 1: // ADDITION
                // --- MONDES 1 √† 5 : BASES (PRIMAIRE) ---
                if (world == 1) { 
                    n1 = rand(1, 5); 
                    n2 = rand(1, 4); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Additionne :"; 
                    hint = "Compte sur tes doigts si besoin."; 
                } 
                else if (world == 2) { 
                    n1 = rand(5, 9); 
                    n2 = rand(5, 9); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Passe 10 :"; 
                    hint = "Compl√®te √† 10, puis ajoute le reste."; 
                } 
                else if (world == 3) { 
                    n1 = rand(2, 9) * 10; 
                    n2 = rand(1, 9); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Assemble :"; 
                    hint = "Colle les unit√©s √† la dizaine."; 
                } 
                else if (world == 4) { 
                    n1 = rand(1, 4) * 10; 
                    n2 = rand(1, 5) * 10; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Additionne les dizaines :"; 
                    hint = "Comme 2+3, mais avec un 0."; 
                } 
                else if (world == 5) { 
                    n1 = rand(12, 58); 
                    n2 = rand(5, 9); 
                    if ((n1 % 10) + n2 < 10) n2 = 10 - (n1 % 10) + rand(1, 5);
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Passe la dizaine sup√©rieure :"; 
                    hint = "√áa va changer le chiffre des dizaines."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (ASTUCES & D√âCIMAUX SIMPLES) ---
                else if (world == 6) { 
                    n1 = rand(25, 85); 
                    n2 = 9; 
                    ans = n1 + n2; 
                    op = `${n1} + 9`; 
                    instr = "Ajoute 9 :"; 
                    hint = "Fais +10 puis -1."; 
                } 
                else if (world == 7) { 
                    n1 = rand(35, 150); 
                    let base = rand(1, 3); 
                    n2 = base * 10 - 1; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Astuce :"; 
                    hint = `Fais +${base * 10} puis -1.`; 
                } 
                else if (world == 8) { 
                    let a = rand(1, 9);
                    let c = 10 - a; 
                    let b = rand(2, 9); 
                    ans = a + b + c; 
                    op = `${a} + ${b} + ${c}`; 
                    instr = "Groupe intelligemment :"; 
                    hint = "Cherche les amis de 10 d'abord."; 
                } 
                else if (world == 9) { 
                    let e1 = rand(1, 10);
                    let e2 = rand(1, 10);
                    n1 = e1 + 0.5;
                    n2 = e2 + 0.5;
                    ans = n1 + n2;
                    op = `${n1} + ${n2}`;
                    instr = "Les demis :"; 
                    hint = "0.5 + 0.5 = 1."; 
                } 
                else if (world == 10) { 
                    n1 = rand(1, 5) * 100 + rand(5, 9) * 10; 
                    n2 = rand(3, 8) * 10; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Passe la centaine :"; 
                    hint = "Concentre-toi sur les dizaines."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (RELATIFS & D√âCIMAUX) ---
                else if (world == 11) { 
                    n1 = rand(25, 75);
                    n2 = parseFloat((rand(1, 99) / 100).toFixed(2)); 
                    ans = parseFloat((n1 + n2).toFixed(2));
                    op = `${n1} + ${n2}`;
                    instr = "Ne m√©lange pas tout :";
                    hint = "L'entier reste, le d√©cimal s'ajoute.";
                } 
                else if (world == 12) { 
                    n1 = rand(15, 30);
                    n2 = rand(5, 12);
                    ans = n1 - n2;
                    op = `${n1} + (-${n2})`;
                    instr = "Ajouter un n√©gatif :";
                    hint = "C'est comme une soustraction.";
                } 
                else if (world == 13) { 
                    n1 = rand(5, 20);
                    n2 = rand(5, 20);
                    ans = -(n1 + n2);
                    op = `(-${n1}) + (-${n2})`;
                    instr = "Cumul de dettes :";
                    hint = "Le r√©sultat est encore plus n√©gatif.";
                } 
                else if (world == 14) { 
                    let d1 = rand(1, 9);
                    let d2 = rand(10 - d1, 9); 
                    n1 = parseFloat((rand(1, 10) + d1 / 10).toFixed(1));
                    n2 = parseFloat((rand(1, 10) + d2 / 10).toFixed(1));
                    ans = parseFloat((n1 + n2).toFixed(1));
                    op = `${n1} + ${n2}`;
                    instr = "Passe l'unit√© :";
                    hint = "Les dixi√®mes forment une unit√©.";
                } 
                else if (world == 15) { 
                    let u = rand(1, 8);
                    let d = rand(u + 1, 9); 
                    n1 = d * 10 + u;
                    n2 = u * 10 + d;
                    ans = n1 + n2;
                    op = `${n1} + ${n2}`;
                    instr = "Additionne :";
                    hint = "Additionne les chiffres, r√©sultat = x11 (souvent).";
                }
                // --- MONDES 16 √† 20 : LYC√âE (GYMNASTIQUE MENTALE) ---
                else if (world == 16) { 
                    n1 = rand(12, 35);
                    n2 = rand(12, 35);
                    let n3 = rand(12, 35);
                    ans = n1 + n2 + n3;
                    op = `${n1} + ${n2} + ${n3}`;
                    instr = "Triple addition :";
                    hint = "Fais les deux premiers, puis le troisi√®me.";
                } 
                else if (world == 17) { 
                    let neg = rand(40, 90);
                    let pos = rand(10, 30);
                    ans = -neg + pos;
                    op = `(-${neg}) + ${pos}`;
                    instr = "Remboursement partiel :";
                    hint = "Fais la diff√©rence, garde le signe moins.";
                } 
                else if (world == 18) { 
                    let h = rand(1, 10);
                    let m1 = rand(35, 55);
                    let m2 = rand(15, 40);
                    op = `${h}h${m1} + ${m2}min`;
                    let totalM = m1 + m2;
                    let finalH = h + Math.floor(totalM / 60);
                    let finalM = totalM % 60;
                    ans = finalH * 60 + finalM; 
                    instr = "Total en minutes :";
                    hint = `√áa fera ${finalH} heures et des poussi√®res...`;
                } 
                else if (world == 19) { 
                    let ent = rand(10, 50);
                    n1 = parseFloat((ent + 0.5).toFixed(1));
                    n2 = parseFloat((rand(1, 9) + 0.25 + rand(0, 1) * 0.5).toFixed(2));
                    ans = parseFloat((n1 + n2).toFixed(2));
                    op = `${n1} + ${n2}`;
                    instr = "Alignement :";
                    hint = "Attention : 0.5 = 0.50";
                } 
                else if (world == 20) { 
                    n1 = rand(15, 45) * 1000; 
                    n2 = rand(123, 987);
                    ans = n1 + n2;
                    op = `${n1} + ${n2}`;
                    instr = "Fusionne :";
                    hint = "Pas de calcul, juste de la lecture.";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (CHARGE LOURDE) ---
                else if (world == 21) { 
                    n1 = parseFloat((rand(1, 9) + rand(5, 9) / 10).toFixed(1));
                    n2 = parseFloat((rand(1, 9) + rand(5, 9) / 10).toFixed(1));
                    let n3 = parseFloat((rand(1, 9) + rand(5, 9) / 10).toFixed(1));
                    ans = parseFloat((n1 + n2 + n3).toFixed(1));
                    op = `${n1} + ${n2} + ${n3}`;
                    instr = "Cha√Æne de retenues :";
                    hint = "Additionne les dixi√®mes d'abord.";
                } 
                else if (world == 22) { 
                    n1 = rand(1000, 9999);
                    n2 = parseFloat((rand(1, 99) / 1000).toFixed(3)); 
                    ans = parseFloat((n1 + n2).toFixed(3));
                    op = `${n1} + ${n2}`;
                    instr = "Ne touche √† rien :";
                    hint = "Colle le d√©cimal √† l'entier.";
                } 
                else if (world == 23) { 
                    let neg = rand(300, 600);
                    let pos = rand(100, 250);
                    ans = -neg + pos;
                    op = `(-${neg}) + ${pos}`;
                    instr = "R√©duis la dette :";
                    hint = "Soustraction : Grand - Petit, signe du grand.";
                } 
                else if (world == 24) { 
                    n1 = parseFloat((rand(10, 80) + 0.8 + rand(0, 1) / 10).toFixed(1)); 
                    n2 = parseFloat((0.2 + rand(1, 5) / 10).toFixed(1));
                    ans = parseFloat((n1 + n2).toFixed(1));
                    op = `${n1} + ${n2}`;
                    instr = "Domino :";
                    hint = "La retenue va faire basculer l'entier.";
                } 
                else if (world == 25) { 
                    n1 = rand(5000, 8999);
                    n2 = rand(2000, 4999);
                    ans = n1 + n2;
                    op = `${n1} + ${n2}`;
                    instr = "ADDITION TOTALE :";
                    hint = "Retenues sur unit√©s, dizaines et centaines.";
                }
                else {
                    let c1_a = rand(10, 99);
                    let c1_b = rand(10, 99) / 10;
                    let c1_c = rand(10, 99) / 100;
                    let c1_d = rand(10, 99) / 1000;
                    ans = parseFloat((c1_a + c1_b + c1_c + c1_d).toFixed(3));
                    op = `${c1_a} + ${c1_b} + ${c1_c} + ${c1_d}`;
                    instr = "Alignement vertical :";
                    hint = "Additionne colonne par colonne mentalement.";
                }
                break;

            case 2: // DOUBLES & MOITI√âS
                // --- MONDES 1 √† 5 : BASES (PRIMAIRE) ---
                if (world == 1) { 
                    n1 = rand(1, 10); 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    instr = "Double :"; 
                    hint = "Table de 2."; 
                } 
                else if (world == 2) { 
                    ans = rand(1, 10); 
                    n1 = ans * 2; 
                    op = `Moiti√© de ${n1}`; 
                    instr = "Partage en 2 :"; 
                    hint = "Combien pour faire ce nombre ?"; 
                } 
                else if (world == 3) { 
                    n1 = rand(11, 19); 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    instr = "Double :"; 
                    hint = "Double 10, puis double l'unit√©."; 
                } 
                else if (world == 4) { 
                    n1 = rand(2, 9) * 10; 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    instr = "Calcule :"; 
                    hint = "Double le premier chiffre."; 
                } 
                else if (world == 5) { 
                    ans = rand(1, 4) * 10; 
                    n1 = ans * 2; 
                    op = `Moiti√© de ${n1}`; 
                    instr = "Divise :"; 
                    hint = "Moiti√© des dizaines."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (RECOMPOSITION) ---
                else if (world == 6) { 
                    let d = rand(2, 4);
                    let u = rand(1, 4);
                    n1 = d * 10 + u;
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    instr = "Calcule :";
                    hint = "Double chaque chiffre s√©par√©ment.";
                } 
                else if (world == 7) { 
                    let d = rand(2, 4) * 2; 
                    let u = rand(1, 4) * 2; 
                    n1 = d * 10 + u;
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    instr = "Divise :";
                    hint = "Coupe chaque chiffre en 2.";
                } 
                else if (world == 8) { 
                    n1 = rand(1, 8) * 10 + 5; 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    instr = "√áa finit par un z√©ro :"; 
                    hint = "Le 5 devient une dizaine."; 
                } 
                else if (world == 9) { 
                    let d = [3, 5, 7, 9][rand(0, 3)];
                    n1 = d * 10; 
                    ans = n1 / 2; 
                    op = `Moiti√© de ${n1}`; 
                    instr = "√áa finit par un 5 :"; 
                    hint = `Moiti√© de ${(d-1)*10} + Moiti√© de 10.`; 
                } 
                else if (world == 10) { 
                    n1 = rand(3, 12);
                    ans = n1 * 4;
                    op = `Quadruple de ${n1}`;
                    instr = "Multiplie par 4 :";
                    hint = "Double du double.";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (D√âCIMAUX & N√âGATIFS) ---
                else if (world == 11) { 
                    let e = rand(1, 15);
                    n1 = e + 0.5;
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    instr = "Entier + Demi :";
                    hint = "La virgule dispara√Æt (0.5 + 0.5 = 1).";
                } 
                else if (world == 12) { 
                    n1 = rand(11, 29);
                    if (n1 % 2 === 0) n1++; 
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    instr = "Nombre √† virgule :";
                    hint = "Divise le nombre pair juste avant, ajoute 0.5.";
                } 
                else if (world == 13) { 
                    n1 = rand(12, 45);
                    ans = -n1 * 2;
                    op = `Double de (-${n1})`;
                    instr = "Garde le signe :";
                    hint = "C'est juste une multiplication par 2.";
                } 
                else if (world == 14) { 
                    n1 = rand(2, 20) * 4; 
                    ans = n1 / 4;
                    op = `Le quart de ${n1}`;
                    instr = "Divise par 4 :";
                    hint = "Moiti√© de la moiti√©.";
                } 
                else if (world == 15) { 
                    n1 = [300, 500, 700, 900][rand(0, 3)];
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    instr = "Gros partage :";
                    hint = "Moiti√© de 30, 50... avec un z√©ro de plus.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (GYMNASTIQUE VIRGULES) ---
                else if (world == 16) { 
                    let d = rand(6, 9);
                    n1 = d / 10;
                    ans = parseFloat((n1 * 2).toFixed(1));
                    op = `Double de ${n1}`;
                    instr = "Passe l'unit√© :";
                    hint = `2 fois ${d}, place la virgule.`;
                } 
                else if (world == 17) { 
                    n1 = rand(0, 1) ? 1.5 : 0.5;
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    instr = "Pr√©cision 0.25 :";
                    hint = "C'est du quart d'unit√© (0.25 ou 0.75).";
                } 
                else if (world == 18) { 
                    let d = rand(2, 8); 
                    if (d % 2 !== 0) d++;
                    n1 = d / 10;
                    ans = parseFloat((n1 / 2).toFixed(2));
                    op = `Moiti√© de ${n1}`;
                    instr = "Divise :";
                    hint = "Moiti√© de chiffre.";
                } 
                else if (world == 19) { 
                    let e = rand(10, 40);
                    let d = rand(1, 4);
                    n1 = parseFloat(e + "." + d);
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    instr = "Double tout :";
                    hint = "Partie enti√®re et d√©cimale s√©par√©es.";
                } 
                else if (world == 20) { 
                    let powers = [64, 128, 256];
                    n1 = powers[rand(0, 2)];
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    instr = "Puissance suivante :";
                    hint = "M√©moire RAM (256, 512, 1024...).";
                }
                // --- MONDES 21 √† 25 : EXPERT (SURCHARGE COGNITIVE) ---
                else if (world == 21) { 
                    n1 = rand(30, 90);
                    if (n1 % 2 === 0) n1++;
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    instr = "Divise l'impair :";
                    hint = "Trouve le pair en dessous, ajoute 0.5.";
                } 
                else if (world == 22) { 
                    let e = rand(10, 50);
                    if (e % 2 !== 0) e++; 
                    n1 = e + 0.5;
                    ans = parseFloat((n1 / 2).toFixed(3)); 
                    op = `Moiti√© de ${n1}`;
                    instr = "Coupe en deux :";
                    hint = "La moiti√© de 0.50 est 0.25.";
                } 
                else if (world == 23) { 
                    let e = rand(10, 99);
                    let d = rand(55, 99);
                    n1 = parseFloat(e + "." + d);
                    ans = parseFloat((n1 * 2).toFixed(2));
                    op = `Double de ${n1}`;
                    instr = "Cha√Æne de retenues :";
                    hint = "Double la fin, remonte vers le d√©but.";
                } 
                else if (world == 24) { 
                    n1 = rand(100, 250) * 4; 
                    ans = n1 / 4;
                    op = `Le quart de ${n1}`;
                    instr = "Divise par 4 :";
                    hint = "Divise par 2, puis encore par 2.";
                } 
		else if (world == 25) { 
                    let e = rand(31, 99);
                    if (e % 2 === 0) e++;
                    let d = rand(1, 9);
                    if (d % 2 === 0) d++;
                    n1 = parseFloat(e + "." + d);
                    ans = parseFloat((n1 / 2).toFixed(3));
                    op = `Moiti√© de ${n1}`;
                    instr = "MOITI√â ULTIME :";
                    hint = "D√©compose : Entier pair, reste, d√©cimale.";
                }
                else {
                    let c2_pow = rand(10, 14);
                    n1 = Math.pow(2, c2_pow);
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    instr = "M√©moire binaire :";
                    hint = "C'est une puissance de 2 sup√©rieure.";
                }
                break;

            case 3: // SOUSTRACTION
                // --- MONDES 1 √† 5 : BASES (PRIMAIRE) ---
                if (world == 1) { 
                    let n2 = rand(1, 4);
                    ans = rand(1, 5); 
                    n1 = ans + n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Soustrais :"; 
                    hint = "Compte √† rebours ou monte."; 
                } 
                else if (world == 2) { 
                    n1 = rand(11, 18); 
                    let u = n1 % 10;
                    n2 = rand(u + 1, 9); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Calcule :"; 
                    hint = "Enl√®ve jusqu'√† 10, puis le reste."; 
                } 
                else if (world == 3) { 
                    n2 = rand(11, 19); 
                    n1 = 20; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Le reste de 20 :"; 
                    hint = "Compl√©ment √† 20."; 
                } 
                else if (world == 4) { 
                    n1 = rand(3, 9) * 10; 
                    n2 = rand(1, 2) * 10; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Enl√®ve les dizaines :"; 
                    hint = "Comme 5 - 2, avec un z√©ro."; 
                } 
                else if (world == 5) { 
                    ans = rand(1, 4); 
                    n2 = rand(30, 80); 
                    n1 = n2 + ans; 
                    op = `${n1} - ${n2}`; 
                    instr = "√âcart :"; 
                    hint = "Compte en montant de " + n2 + " vers " + n1 + "."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (ASTUCES) ---
                else if (world == 6) { 
                    n1 = rand(3, 9) * 10; 
                    n2 = rand(1, 9); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Soustrais :"; 
                    hint = "Amis de 10."; 
                } 
                else if (world == 7) { 
                    let base = rand(2, 8) * 10;
                    let below = rand(1, 4);
                    let above = rand(1, 4);
                    n1 = base + above;
                    n2 = base - below;
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "√âcart :";
                    hint = `Distance entre ${n2} et ${base}, plus ${above}.`;
                } 
                else if (world == 8) { 
                    n1 = rand(25, 85); 
                    n2 = 9; 
                    ans = n1 - n2; 
                    op = `${n1} - 9`; 
                    instr = "Enl√®ve 9 :"; 
                    hint = "-10 puis +1."; 
                } 
                else if (world == 9) { 
                    n1 = rand(45, 150); 
                    let d = rand(1, 3);
                    n2 = d * 10 - 1; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Astuce :"; 
                    hint = `Enl√®ve ${d*10}, rajoute 1.`; 
                } 
                else if (world == 10) { 
                    n2 = rand(31, 89);
                    n1 = 100;
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "Reste de 100 :";
                    hint = "Compl√©ment : unit√©=10, dizaine=9.";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (RELATIFS & D√âCIMAUX) ---
                else if (world == 11) { 
                    let v = rand(1, 9);
                    n2 = v / 10;
                    ans = parseFloat((1 - n2).toFixed(1));
                    op = `1 - ${n2}`;
                    instr = "Soustrais :";
                    hint = "Compl√©ment √† l'unit√© (comme 10 - " + v + ").";
                } 
                else if (world == 12) { 
                    n1 = rand(5, 15);
                    n2 = n1 + rand(1, 9);
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "On descend sous z√©ro :";
                    hint = "Fais l'√©cart, mets un moins.";
                } 
                else if (world == 13) { 
                    n1 = rand(5, 20);
                    n2 = rand(2, 9);
                    ans = n1 + n2; 
                    op = `${n1} - (-${n2})`;
                    instr = "R√®gle des signes :";
                    hint = "Moins par moins √©gale plus.";
                } 
                else if (world == 14) { 
                    n1 = 10;
                    let e = rand(1, 8);
                    n2 = e + 0.5;
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "Rendu de monnaie :";
                    hint = "Enl√®ve l'entier, puis encore 0.5.";
                } 
                else if (world == 15) { 
                    n1 = 60;
                    n2 = rand(15, 55);
                    ans = n1 - n2;
                    op = `1h00 - 0h${n2}`;
                    instr = "Minutes restantes :";
                    hint = "Compl√©ment √† 60.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (PI√àGES & PR√âCISION) ---
                else if (world == 16) { 
                    n1 = parseFloat((rand(3, 9) + 0.5).toFixed(2)); 
                    n2 = parseFloat((rand(1, 2) + 0.25).toFixed(2)); 
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "Attention aux trous :";
                    hint = "Pense 4.50 - 1.25";
                } 
                else if (world == 17) { 
                    n1 = 1000;
                    n2 = rand(123, 876);
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "Compl√©ment √† 1000 :";
                    hint = "999 et 10 √† la fin.";
                } 
                else if (world == 18) { 
                    n1 = rand(5, 20);
                    n2 = -rand(5, 20);
                    ans = n1 - n2; 
                    op = `${n1} - (${n2})`;
                    instr = "Distance :";
                    hint = "Moins moins = Plus. Additionne les distances.";
                } 
                else if (world == 19) { 
                    let base = rand(3, 8);
                    n1 = parseFloat((base + 0.1).toFixed(2)); 
                    n2 = parseFloat((base - 0.05).toFixed(2)); 
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "Petit √©cart :";
                    hint = "Passe par l'entier rond (3.00).";
                } 
                else if (world == 20) { 
                    n1 = rand(1, 9) * 10;
                    n2 = rand(2, 8) * 100;
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "Grand plongeon :";
                    hint = "Calcule l'√©cart, le r√©sultat est n√©gatif.";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (CHARGE MENTALE) ---
                else if (world == 21) { 
                    n1 = rand(2, 5) * 1000 + rand(1, 5); 
                    n2 = rand(150, 950);
                    ans = n1 - n2;
                    op = `${n1} - ${n2}`;
                    instr = "Passe les milliers :";
                    hint = "Recule par √©tapes.";
                } 
                else if (world == 22) { 
                    let v = rand(1234, 9876);
                    n2 = v / 10000; 
                    ans = parseFloat((1 - n2).toFixed(4));
                    op = `1 - ${n2}`;
                    instr = "4 d√©cimales :";
                    hint = "9, 9, 9, 10.";
                } 
                else if (world == 23) { 
                    let target = rand(15, 85);
                    let diff = rand(15, 85);
                    n1 = target + diff; 
                    ans = n1;
                    op = `x - ${diff} = ${target}`;
                    instr = "Trouve x :";
                    hint = "Fais l'op√©ration inverse (Addition).";
                } 
                else if (world == 24) { 
                    n1 = 100;
                    let dec = rand(1000, 9000);
                    n2 = parseFloat((rand(1, 9) + dec/10000).toFixed(4));
                    ans = parseFloat((n1 - n2).toFixed(4));
                    op = `${n1} - ${n2}`;
                    instr = "Pr√©cision chirurgicale :";
                    hint = "Visualise 100,0000";
                } 
                else if (world == 25) { 
                    n1 = 10000;
                    let ent = rand(1000, 5000);
                    let dec = rand(11, 99);
                    n2 = parseFloat(ent + "." + dec);
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "SOUSTRACTION ULTIME :";
                    hint = "Tout √† 9 (9999), fin √† 10.";
                }
                else {
                    let c3_dec = rand(111, 999);
                    n2 = parseFloat((999 + c3_dec/1000).toFixed(3));
                    ans = parseFloat((1000 - n2).toFixed(3));
                    op = `1000 - ${n2}`;
                    instr = "Survivant :";
                    hint = "Tout s'annule sauf la fin (compl√©ment √† 1000).";
                }
                break;

            case 4: // MULTIPLICATION
                // --- MONDES 1 √† 5 : BASES (TABLES) ---
                if (world == 1) { 
                    let t = [2, 5, 10][rand(0, 2)]; 
                    n1 = t; 
                    n2 = rand(1, 10); 
                    ans = n1 * n2; 
                    op = `${n1} √ó ${n2}`; 
                    instr = "Multiplie :"; 
                    hint = "Tables faciles."; 
                } 
                else if (world == 2) { 
                    n1 = rand(3, 4); 
                    n2 = rand(1, 10); 
                    ans = n1 * n2; 
                    op = `${n1} √ó ${n2}`; 
                    instr = "Calcule :"; 
                    hint = "Compte par sauts si besoin."; 
                } 
                else if (world == 3) { 
                    n1 = rand(6, 7); 
                    n2 = rand(1, 10); 
                    ans = n1 * n2; 
                    op = `${n1} √ó ${n2}`; 
                    instr = "Multiplie :"; 
                    hint = "Les tables difficiles."; 
                } 
                else if (world == 4) { 
                    n1 = rand(8, 9); 
                    n2 = rand(1, 10); 
                    ans = n1 * n2; 
                    op = `${n1} √ó ${n2}`; 
                    instr = "Calcule :"; 
                    hint = "Pour 9 : x10 moins le nombre."; 
                } 
                else if (world == 5) { 
                    n1 = rand(2, 10); 
                    ans = n1 * n1; 
                    op = `${n1} √ó ${n1}`; 
                    instr = "Le Carr√© :"; 
                    hint = "Le nombre multipli√© par lui-m√™me."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (ZEROS & ASTUCES) ---
                else if (world == 6) { 
                    let p = rand(1, 3); 
                    n1 = Math.pow(10, p);
                    n2 = rand(2, 98);
                    ans = n1 * n2;
                    op = `${n2} √ó ${n1}`;
                    instr = "Ajoute les z√©ros :";
                    hint = "D√©cale tout vers la gauche.";
                } 
                else if (world == 7) { 
                    let d1 = rand(2, 9);
                    let d2 = rand(2, 9);
                    n1 = d1 * 10;
                    n2 = d2 * 10;
                    ans = n1 * n2;
                    op = `${n1} √ó ${n2}`;
                    instr = "Multiplie :";
                    hint = `${d1}x${d2} et remets les deux z√©ros.`;
                } 
                else if (world == 8) { 
                    n1 = rand(11, 18); 
                    n2 = 11;
                    ans = n1 * n2;
                    op = `${n1} √ó 11`;
                    instr = "Fois 11 :";
                    hint = "√âcarte les chiffres et mets leur somme au milieu.";
                } 
                else if (world == 9) { 
                    let d = rand(2, 6);
                    let u = rand(1, 4);
                    n1 = 10 + u;
                    n2 = d;
                    ans = n1 * n2;
                    op = `${n1} √ó ${n2}`;
                    instr = "D√©compose :";
                    hint = `Fais 10x${n2} plus le reste.`;
                } 
                else if (world == 10) { 
                    let sq = [11, 12, 15, 20];
                    n1 = sq[rand(0, 3)];
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Carr√© par c≈ìur :";
                    hint = "√Ä savoir : 121, 144, 225 ou 400.";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (RELATIFS & D√âCIMAUX) ---
                else if (world == 11) { 
                    let p = rand(1, 2); 
                    n1 = 1 / Math.pow(10, p);
                    n2 = rand(12, 450);
                    ans = parseFloat((n2 * n1).toFixed(2));
                    op = `${n2} √ó ${n1}`;
                    instr = "Divise par 10 ou 100 :";
                    hint = "Recule la virgule vers la gauche.";
                } 
                else if (world == 12) { 
                    n1 = rand(2, 9);
                    n2 = rand(2, 9);
                    ans = -n1 * n2;
                    op = `(-${n1}) √ó ${n2}`;
                    instr = "Signe :";
                    hint = "Le r√©sultat est n√©gatif.";
                } 
                else if (world == 13) { 
                    n1 = rand(3, 12);
                    n2 = rand(3, 12);
                    ans = n1 * n2;
                    op = `(-${n1}) √ó (-${n2})`;
                    instr = "Calcule :";
                    hint = "Moins par moins √©gale plus.";
                } 
                else if (world == 14) { 
                    n1 = 0.5;
                    n2 = rand(2, 40);
                    if (n2 % 2 !== 0) n2++; 
                    ans = n2 / 2;
                    op = `${n1} √ó ${n2}`;
                    instr = "Moiti√© :";
                    hint = "Multiplier par 0.5, c'est diviser par 2.";
                } 
                else if (world == 15) { 
                    let u = rand(1, 4);
                    n1 = parseFloat((1 + u/10).toFixed(1)); 
                    n2 = rand(2, 5);
                    ans = parseFloat((n1 * n2).toFixed(1));
                    op = `${n1} √ó ${n2}`;
                    instr = "Calcule :";
                    hint = "Ignore la virgule, calcule, remets-la.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (ASTUCES AVANC√âES) ---
                else if (world == 16) { 
                    n1 = rand(0, 1) ? 5 : 50;
                    n2 = rand(4, 24) * 2; 
                    ans = n1 * n2;
                    op = `${n2} √ó ${n1}`;
                    instr = "Astuce 5 :";
                    hint = "Fais x10 (ou x100) et divise par 2.";
                } 
                else if (world == 17) { 
                    n1 = 25;
                    n2 = rand(1, 8) * 4; 
                    ans = n1 * n2;
                    op = `${n2} √ó ${n1}`;
                    instr = "Astuce 25 :";
                    hint = "Fais x100 et divise par 4.";
                } 
                else if (world == 18) { 
                    let d = rand(2, 9);
                    n1 = d * 10 + 5;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Carr√© en 5 :";
                    hint = `Fais ${d}x${d+1} et colle 25 √† la fin.`;
                } 
                else if (world == 19) { 
                    n1 = 99;
                    n2 = rand(2, 9);
                    ans = n1 * n2;
                    op = `${n1} √ó ${n2}`;
                    instr = "Presque 100 :";
                    hint = `Fais 100x${n2} moins ${n2}.`;
                } 
                else if (world == 20) { 
                    let a = rand(2, 9);
                    let b = rand(2, 9);
                    n1 = a / 10;
                    n2 = b / 10;
                    ans = parseFloat((n1 * n2).toFixed(2));
                    op = `${n1} √ó ${n2}`;
                    instr = "Compte les d√©cimales :";
                    hint = `${a}x${b} avec deux chiffres apr√®s la virgule.`;
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (CHARGE MENTALE MAX) ---
                else if (world == 21) { 
                    let mid = rand(3, 19);
                    ans = mid * 100;
                    op = `4 √ó ${mid} √ó 25`;
                    instr = "Groupe malin :";
                    hint = "Cherche le 100 (4x25).";
                } 
                else if (world == 22) { 
                    let a = rand(2, 9);
                    let b = rand(2, 9);
                    n1 = a / 100; 
                    n2 = b / 1000; 
                    ans = parseFloat((n1 * n2).toFixed(5));
                    op = `${n1} √ó ${n2}`;
                    instr = "Ne te perds pas :";
                    hint = "2 d√©cimales + 3 d√©cimales = 5 d√©cimales.";
                } 
                else if (world == 23) { 
                    n1 = 1.5;
                    n2 = rand(11, 39);
                    if (n2 % 2 === 0) n2++; 
                    ans = parseFloat((n1 * n2).toFixed(1));
                    op = `${n1} √ó ${n2}`;
                    instr = "Une fois et demie :";
                    hint = "Le nombre + sa moiti√© (√ßa fera ,5).";
                } 
                else if (world == 24) { 
                    n1 = rand(3, 6);
                    ans = n1 * n1 * n1;
                    op = `${n1}¬≥`;
                    instr = "Le Cube :";
                    hint = `${n1} x ${n1} x ${n1}.`;
                } 
                else if (world == 25) { 
                    let m = rand(1111, 2222);
                    let x = rand(3, 6);
                    ans = m * x;
                    op = `${x} √ó ${m}`;
                    instr = "MULTIPLICATION ULTIME :";
                    hint = "Distribue : milliers, centaines, dizaines, unit√©s.";
                }
                else {
                    let c4_base = [48, 49, 51, 52, 97, 98, 99, 101, 102, 105, 108][rand(0, 10)];
                    ans = c4_base * c4_base;
                    op = `${c4_base}¬≤`;
                    instr = "Carr√© parfait :";
                    hint = "Utilise l'identit√© remarquable (√©cart √† 50 ou 100).";
                }
                break;
case 5: // PUISSANCES DE 10
                // --- MONDES 1 √† 5 : BASES (PRIMAIRE) ---
                if (world == 1) { 
                    n1 = rand(2, 50); 
                    ans = n1 * 10; 
                    op = `${n1} √ó 10`; 
                    instr = "Multiplie :"; 
                    hint = "Ajoute un z√©ro."; 
                } 
                else if (world == 2) { 
                    n1 = rand(2, 20); 
                    ans = n1 * 100; 
                    op = `${n1} √ó 100`; 
                    instr = "Multiplie :"; 
                    hint = "Ajoute deux z√©ros."; 
                } 
                else if (world == 3) { 
                    n1 = rand(2, 9); 
                    ans = n1 * 1000; 
                    op = `${n1} √ó 1000`; 
                    instr = "Calcule :"; 
                    hint = "Mille fois plus grand."; 
                } 
                else if (world == 4) { 
                    n1 = rand(2, 15) * 10; 
                    ans = n1 / 10; 
                    op = `${n1} √∑ 10`; 
                    instr = "Divise :"; 
                    hint = "Enl√®ve un z√©ro."; 
                } 
                else if (world == 5) { 
                    let e = rand(1, 10);
                    let d = rand(1, 9);
                    n1 = parseFloat(e + "." + d);
                    ans = parseFloat((n1 * 10).toFixed(0)); 
                    op = `${n1} √ó 10`; 
                    instr = "D√©cale la virgule :"; 
                    hint = "La virgule recule d'un rang vers la droite."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (D√âCALAGES) ---
                else if (world == 6) { 
                    let e = rand(1, 9);
                    n1 = parseFloat(e + ".5");
                    ans = n1 * 100; 
                    op = `${n1} √ó 100`; 
                    instr = "Attention au z√©ro :"; 
                    hint = "D√©cale de 2 rangs (un saut + un z√©ro)."; 
                } 
                else if (world == 7) { 
                    n1 = rand(11, 99); 
                    if (n1 % 10 === 0) n1++; 
                    ans = n1 / 10; 
                    op = `${n1} √∑ 10`; 
                    instr = "Divise :"; 
                    hint = "Place la virgule avant le dernier chiffre."; 
                } 
                else if (world == 8) { 
                    n1 = rand(11, 99); 
                    ans = n1 / 100; 
                    op = `${n1} √∑ 100`; 
                    instr = "Divise :"; 
                    hint = "0 virgule le nombre."; 
                } 
                else if (world == 9) { 
                    let p = rand(2, 5);
                    ans = Math.pow(10, p);
                    op = `10^${p}`; 
                    instr = "√âcris le nombre :"; 
                    hint = `Un 1 suivi de ${p} z√©ros.`; 
                } 
                else if (world == 10) { 
                    n1 = rand(2, 9);
                    let p = rand(2, 4);
                    ans = n1 * Math.pow(10, p);
                    op = `${n1} √ó 10^${p}`;
                    instr = "Calcule :"; 
                    hint = `Ajoute ${p} z√©ros.`; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (INVERSES & PETITS NOMBRES) ---
                else if (world == 11) { 
                    n1 = rand(120, 450);
                    ans = n1 / 10;
                    op = `${n1} √ó 0.1`;
                    instr = "Calcule :"; 
                    hint = "x0.1, c'est comme diviser par 10."; 
                } 
                else if (world == 12) { 
                    n1 = rand(100, 900);
                    ans = n1 / 100;
                    op = `${n1} √ó 0.01`;
                    instr = "Calcule :"; 
                    hint = "x0.01, c'est comme diviser par 100."; 
                } 
                else if (world == 13) { 
                    n1 = rand(2, 15);
                    ans = n1 * 10;
                    op = `${n1} √∑ 0.1`;
                    instr = "Inverse :"; 
                    hint = "Diviser par un dixi√®me = Multiplier par 10."; 
                } 
                else if (world == 14) { 
                    n1 = rand(2, 9);
                    ans = n1 * 100;
                    op = `${n1} √∑ 0.01`;
                    instr = "Inverse :"; 
                    hint = "Diviser par un centi√®me = Multiplier par 100."; 
                } 
                else if (world == 15) { 
                    let m = rand(11, 99);
                    let p = rand(2, 4);
                    n1 = m / 10; 
                    ans = Math.round(n1 * Math.pow(10, p));
                    op = `${n1} √ó 10^${p}`;
                    instr = "Notation scientifique :"; 
                    hint = `D√©cale la virgule de ${p} rangs vers la droite.`; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (PUISSANCES N√âGATIVES & CALCULS) ---
                else if (world == 16) { 
                    let p = rand(1, 3);
                    ans = 1 / Math.pow(10, p);
                    op = `10^(-${p})`;
                    instr = "Nombre d√©cimal :"; 
                    hint = `C'est 1 divis√© par 10^${p} (0.0...).`; 
                } 
                else if (world == 17) { 
                    n1 = rand(12, 88);
                    ans = n1 / 10;
                    op = `${n1} √ó 10^(-1)`;
                    instr = "Puissance n√©gative :"; 
                    hint = "10^(-1) vaut 0.1 (divise par 10)."; 
                } 
                else if (world == 18) { 
                    let p1 = rand(2, 5);
                    let p2 = rand(2, 5);
                    n1 = `10^${p1}`;
                    let n2 = `10^${p2}`;
                    ans = p1 + p2;
                    op = `${n1} √ó ${n2} = 10^x`;
                    instr = "Trouve x :"; 
                    hint = "Additionne les exposants."; 
                } 
                else if (world == 19) { 
                    let p2 = rand(2, 4);
                    let p1 = p2 + rand(1, 4); 
                    n1 = `10^${p1}`;
                    let n2 = `10^${p2}`;
                    ans = p1 - p2;
                    op = `${n1} √∑ ${n2} = 10^x`;
                    instr = "Trouve x :"; 
                    hint = "Soustrais les exposants (Haut - Bas)."; 
                } 
                else if (world == 20) { 
                    let v = rand(1, 9);
                    n1 = v / 1000; 
                    ans = v;
                    op = `${n1} √ó 1000`;
                    instr = "Nettoie le nombre :"; 
                    hint = "3 z√©ros annulent 3 d√©cimales."; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (VISUALISATION SPATIALE) ---
                else if (world == 21) { 
                    n1 = rand(1, 9);
                    ans = n1 / 1000;
                    op = `${n1} √∑ 10^3`;
                    instr = "D√©cimal pr√©cis :"; 
                    hint = "Recule de 3 rangs (0.00...)."; 
                } 
                else if (world == 22) { 
                    let v = rand(1, 9);
                    n1 = v / 10; 
                    ans = n1 * 1000; 
                    op = `${n1} √∑ 0.001`;
                    instr = "Gros grossissement :"; 
                    hint = "Diviser par un milli√®me = Multiplier par 1000."; 
                } 
                else if (world == 23) { 
                    let a = rand(2, 4);
                    let b = rand(2, 4);
                    let pa = rand(1, 3);
                    let pb = rand(1, 3);
                    let num = a * b; 
                    let pow = pa + pb; 
                    ans = num * Math.pow(10, pow); 
                    op = `( ${a}√ó10^${pa} ) √ó ( ${b}√ó10^${pb} )`;
                    instr = "Nombre entier final :"; 
                    hint = "Multiplie les nombres, ajoute les puissances."; 
                } 
                else if (world == 24) { 
                    let p1 = rand(1, 2);
                    let p2 = rand(5, 9);
                    let v1 = Math.pow(10, p1);
                    let v2 = Math.pow(10, p2);
                    ans = p2 - p1;
                    let s1 = v1.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    let s2 = v2.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    op = `${s1} √ó 10^x = ${s2}`;
                    instr = "Trouve x (l'√©cart) :"; 
                    hint = "Compte la diff√©rence de z√©ros."; 
                } 
                else if (world == 25) { 
                    let ch = rand(123, 987);
                    let zeros = "0.000";
                    n1 = parseFloat(zeros + ch);
                    ans = parseFloat((n1 * 1000000).toFixed(2));
                    op = `${n1} √ó 1 000 000`;
                    instr = "D√âCALAGE ULTIME :";
                    hint = "6 z√©ros contre 6 positions apr√®s virgule.";
                }
                else {
                    let c5_val = rand(11, 99);
                    let c5_zeros = rand(5, 8); 
                    let c5_pow = rand(c5_zeros + 1, c5_zeros + 3); 
                    let c5_str = "0." + "0".repeat(c5_zeros) + c5_val;
                    n1 = parseFloat(c5_str);
                    ans = n1 * Math.pow(10, c5_pow);
                    op = `${c5_str} √ó 10^${c5_pow}`;
                    instr = "D√©calage quantique :";
                    hint = `Avance la virgule de ${c5_pow} rangs.`;
                }
                break;

            case 6: // DIVISION SIMPLE
                // --- MONDES 1 √† 5 : BASES (PARTAGE) ---
                if (world == 1) { 
                    ans = rand(2, 12); 
                    n1 = ans * 2; 
                    op = `${n1} √∑ 2`; 
                    instr = "Moiti√© :"; 
                    hint = "Partage en 2."; 
                } 
                else if (world == 2) { 
                    ans = rand(2, 20); 
                    n1 = ans * 10; 
                    op = `${n1} √∑ 10`; 
                    instr = "Divise :"; 
                    hint = "Enl√®ve le z√©ro."; 
                } 
                else if (world == 3) { 
                    ans = rand(2, 10); 
                    n1 = ans * 4; 
                    op = `${n1} √∑ 4`; 
                    instr = "Le quart :"; 
                    hint = "Moiti√© de la moiti√©."; 
                } 
                else if (world == 4) { 
                    ans = rand(2, 12);
                    n1 = ans * 5;
                    op = `${n1} √∑ 5`;
                    instr = "Divise par 5 :";
                    hint = "Divise par 10 et multiplie par 2.";
                } 
                else if (world == 5) { 
                    ans = rand(3, 12); 
                    n1 = ans * 3; 
                    op = `${n1} √∑ 3`; 
                    instr = "Divise :"; 
                    hint = "Cherche dans la table de 3."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (D√âCIMAUX) ---
                else if (world == 6) { 
                    n1 = rand(3, 19); 
                    if (n1 % 2 === 0) n1++; 
                    ans = n1 / 2; 
                    op = `${n1} √∑ 2`; 
                    instr = "Moiti√© exacte :"; 
                    hint = "√áa finit par .5"; 
                } 
                else if (world == 7) { 
                    n1 = rand(12, 98); 
                    ans = n1 / 10; 
                    op = `${n1} √∑ 10`; 
                    instr = "Place la virgule :"; 
                    hint = "Un chiffre apr√®s la virgule."; 
                } 
                else if (world == 8) { 
                    n1 = rand(5, 25);
                    if (n1 % 4 === 0) n1++; 
                    ans = n1 / 4;
                    op = `${n1} √∑ 4`;
                    instr = "Le quart :";
                    hint = "Coupe en 2, puis encore en 2.";
                } 
                else if (world == 9) { 
                    n1 = rand(12, 98);
                    ans = n1 / 100;
                    op = `${n1} √∑ 100`;
                    instr = "Divise :";
                    hint = "0 virgule le nombre.";
                } 
                else if (world == 10) { 
                    n1 = rand(2, 9);
                    ans = n1 / 1000;
                    op = `${n1} √∑ 1000`;
                    instr = "Milli√®me :";
                    hint = "0.00x";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (INVERSES) ---
                else if (world == 11) { 
                    n1 = rand(3, 15);
                    ans = n1 * 2;
                    op = `${n1} √∑ 0.5`;
                    instr = "Combien de moiti√©s ?";
                    hint = "Diviser par 0.5 revient √† multiplier par 2.";
                } 
                else if (world == 12) { 
                    n1 = rand(2, 25);
                    ans = n1 * 10;
                    op = `${n1} √∑ 0.1`;
                    instr = "Combien de dixi√®mes ?";
                    hint = "Diviser par 0.1 revient √† multiplier par 10.";
                } 
                else if (world == 13) { 
                    n1 = rand(12, 88);
                    ans = n1 / 5;
                    op = `${n1} √∑ 5`;
                    instr = "Astuce :";
                    hint = "Double le nombre, puis divise par 10.";
                } 
                else if (world == 14) { 
                    let e = rand(1, 9);
                    n1 = parseFloat(e + ".5");
                    ans = n1 / 10;
                    op = `${n1} √∑ 10`;
                    instr = "Recule la virgule :";
                    hint = "Le chiffre passe aux centi√®mes.";
                } 
                else if (world == 15) { 
                    ans = rand(2, 9);
                    let remainder = rand(0, 1) ? 0.5 : 0;
                    ans += remainder; 
                    n1 = ans * 20;
                    op = `${n1} √∑ 20`;
                    instr = "Divise par 20 :";
                    hint = "Coupe le z√©ro, puis prends la moiti√©.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (ASTUCES AVANC√âES) ---
                else if (world == 16) { 
                    n1 = rand(2, 12);
                    ans = n1 * 4;
                    op = `${n1} √∑ 0.25`;
                    instr = "Combien de quarts ?";
                    hint = "Diviser par 0.25 revient √† multiplier par 4.";
                } 
                else if (world == 17) { 
                    n1 = rand(120, 400);
                    ans = n1 / 50;
                    op = `${n1} √∑ 50`;
                    instr = "Divise par 50 :";
                    hint = "Divise par 100, puis double.";
                } 
                else if (world == 18) { 
                    n1 = rand(10, 50);
                    let d = rand(2, 5);
                    n1 = n1 - (n1 % d); 
                    ans = -n1 / d;
                    op = `(-${n1}) √∑ ${d}`;
                    instr = "Signe :";
                    hint = "N√©gatif divis√© par positif reste n√©gatif.";
                } 
                else if (world == 19) { 
                    n1 = rand(3, 15);
                    ans = n1 * 5;
                    op = `${n1} √∑ 0.2`;
                    instr = "Combien de cinqui√®mes ?";
                    hint = "Diviser par 0.2 revient √† multiplier par 5.";
                } 
                else if (world == 20) { 
                    let e = rand(3, 9);
                    if (e % 2 === 0) e++; 
                    n1 = parseFloat(e + ".5");
                    ans = n1 / 2;
                    op = `${n1} √∑ 2`;
                    instr = "Moiti√© pr√©cise :";
                    hint = "Moiti√© de l'entier + Moiti√© de 0.5 (0.25).";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (CHARGE MENTALE) ---
                else if (world == 21) { 
                    let v = rand(1, 9);
                    let d = rand(1, 9);
                    n1 = parseFloat(v + "." + d);
                    ans = Math.round(n1 * 100);
                    op = `${n1} √∑ 0.01`;
                    instr = "Grossissement :";
                    hint = "Diviser par un centi√®me = Multiplier par 100.";
                } 
                else if (world == 22) { 
                    let v = rand(1, 49); 
                    n1 = v / 100; 
                    ans = parseFloat((n1 * 2).toFixed(2));
                    op = `${n1} √∑ 0.5`;
                    instr = "Divise par un demi :";
                    hint = "Cela revient √† doubler le nombre (x2).";
                } 
                else if (world == 23) { 
                    n1 = rand(1, 5);
                    ans = n1 / 8;
                    op = `${n1} √∑ 8`;
                    instr = "Trois moiti√©s :";
                    hint = "Moiti√©, Moiti√©, Moiti√©.";
                } 
                else if (world == 24) { 
                    let e = rand(1, 8);
                    let d = rand(1, 9);
                    if ((d % 2) !== 0) d++; 
                    n1 = parseFloat(e + "." + d);
                    ans = parseFloat((n1 / 5).toFixed(2));
                    op = `${n1} √∑ 5`;
                    instr = "Astuce x2 :";
                    hint = "Double (x2) et divise par 10.";
                } 
                else if (world == 25) { 
                    let list = [{n: 0.75, d: 0.25, r: 3}, {n: 1.25, d: 0.25, r: 5}, {n: 1.5, d: 0.75, r: 2}, {n: 0.12, d: 0.04, r: 3}];
                    let item = list[rand(0, 3)];
                    n1 = item.n;
                    ans = item.r;
                    op = `${n1} √∑ ${item.d}`;
                    instr = "RAPPORT :";
                    hint = "Pense en fractions (ex: 3 quarts divis√© par 1 quart).";
                }
                else {
                    let c6_div = [7, 11, 13, 37, 111][rand(0, 4)];
                    ans = rand(12, 50);
                    n1 = ans * c6_div;
                    op = `${n1} √∑ ${c6_div}`;
                    instr = "Division sacr√©e :";
                    hint = "Cherche l'ordre de grandeur, puis l'unit√©.";
                }
                break;

            case 7: // ASTUCES
                // --- MONDES 1 √† 5 : BASES (PRIMAIRE) ---
                if (world == 1) { 
                    n1 = rand(2, 9); 
                    ans = n1 * 9; 
                    op = `${n1} √ó 9`; 
                    instr = "Astuce :"; 
                    hint = "Fais x10 moins le nombre."; 
                } 
                else if (world == 2) { 
                    n1 = rand(2, 9); 
                    ans = n1 * 11; 
                    op = `${n1} √ó 11`; 
                    instr = "Astuce :"; 
                    hint = "Fais x10 plus le nombre."; 
                } 
                else if (world == 3) { 
                    let pair = rand(2, 8) * 2; 
                    n1 = pair; 
                    ans = n1 * 5; 
                    op = `${n1} √ó 5`; 
                    instr = "Multiplie par 5 :"; 
                    hint = "Prends la moiti√© et ajoute un 0."; 
                } 
                else if (world == 4) { 
                    n1 = rand(12, 25); 
                    ans = n1 * 4; 
                    op = `${n1} √ó 4`; 
                    instr = "Astuce :"; 
                    hint = "Double le nombre deux fois."; 
                } 
                else if (world == 5) { 
                    n1 = rand(2, 12) * 2; 
                    ans = n1 * 50; 
                    op = `${n1} √ó 50`; 
                    instr = "Multiplie par 50 :"; 
                    hint = "Moiti√© du nombre, fois 100."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (CLASSIQUES) ---
                else if (world == 6) { 
                    let d = rand(1, 8);
                    let u = rand(1, 9 - d); 
                    n1 = d * 10 + u;
                    ans = n1 * 11;
                    op = `${n1} √ó 11`;
                    instr = "L'√©cartement :";
                    hint = "√âcarte les chiffres, mets leur somme au milieu.";
                } 
                else if (world == 7) { 
                    let d = rand(4, 9);
                    let u = rand(10 - d, 9); 
                    if (d + u < 10) u = 9; 
                    n1 = d * 10 + u;
                    ans = n1 * 11;
                    op = `${n1} √ó 11`;
                    instr = "Attention retenue :";
                    hint = "La somme d√©passe 10, ajoute +1 au premier chiffre.";
                } 
                else if (world == 8) { 
                    n1 = rand(3, 19);
                    if (n1 % 2 === 0) n1++; 
                    ans = n1 * 5;
                    op = `${n1} √ó 5`;
                    instr = "Nombre impair :";
                    hint = "Moiti√© de l'entier pr√©c√©dent (x10) + 5.";
                } 
                else if (world == 9) { 
                    n1 = rand(4, 20);
                    if (n1 % 2 !== 0) n1++; 
                    ans = n1 * 15;
                    op = `${n1} √ó 15`;
                    instr = "Astuce 15 :";
                    hint = "Le nombre x10, plus sa moiti√©.";
                } 
                else if (world == 10) { 
                    n1 = rand(15, 45);
                    ans = n1 * 9;
                    op = `${n1} √ó 9`;
                    instr = "Pas loin de 10 :";
                    hint = "Fais x10 moins le nombre."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (AVANC√â) ---
                else if (world == 11) { 
                    n1 = rand(2, 12) * 4; 
                    ans = n1 * 25;
                    op = `${n1} √ó 25`;
                    instr = "Le Quart :";
                    hint = "Prends le quart du nombre, ajoute deux 0.";
                } 
                else if (world == 12) { 
                    n1 = rand(3, 15);
                    if (n1 % 4 === 0) n1++; 
                    ans = n1 * 25;
                    op = `${n1} √ó 25`;
                    instr = "Combien de 25 ?";
                    hint = "Chaque unit√© vaut 25. 4 unit√©s font 100.";
                } 
                else if (world == 13) { 
                    n1 = rand(11, 25);
                    ans = n1 * 19;
                    op = `${n1} √ó 19`;
                    instr = "Presque 20 :";
                    hint = "Fais x20 (double et 0) moins le nombre.";
                } 
                else if (world == 14) { 
                    let d = rand(2, 9);
                    n1 = d * 10 + 5;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Carr√© magique :";
                    hint = `Multiplie ${d} par ${d+1}, et colle 25 √† la fin.`;
                } 
                else if (world == 15) { 
                    n1 = rand(12, 60);
                    if (n1 % 2 !== 0) n1++; 
                    ans = n1 * 1.5;
                    op = `${n1} √ó 1.5`;
                    instr = "Un et demi :";
                    hint = "Le nombre plus sa moiti√©.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (VIRGULES & GRANDS NOMBRES) ---
                else if (world == 16) { 
                    n1 = rand(12, 98);
                    ans = n1 * 101;
                    op = `${n1} √ó 101`;
                    instr = "R√©p√©tition :";
                    hint = "x100 + x1. Le nombre se r√©p√®te.";
                } 
                else if (world == 17) { 
                    n1 = rand(12, 98);
                    ans = n1 * 99;
                    op = `${n1} √ó 99`;
                    instr = "Presque 100 :";
                    hint = "x100 moins le nombre.";
                } 
                else if (world == 18) { 
                    let e = rand(2, 12);
                    let d = rand(1, 9);
                    if (d % 2 !== 0) d++; 
                    n1 = parseFloat(e + "." + d);
                    ans = parseFloat((n1 * 5).toFixed(2));
                    op = `${n1} √ó 5`;
                    instr = "Moiti√© x10 :";
                    hint = "Ignore la virgule, ou fais x10 / 2.";
                } 
                else if (world == 19) { 
                    n1 = rand(4, 20) * 4; 
                    ans = n1 * 1.25;
                    op = `${n1} √ó 1.25`;
                    instr = "Ajoute le quart :";
                    hint = "C'est le nombre plus son quart.";
                } 
                else if (world == 20) { 
                    n1 = rand(10, 30) * 4; 
                    ans = n1 * 0.25;
                    op = `${n1} √ó 0.25`;
                    instr = "C'est une division :";
                    hint = "Multiplier par 0.25, c'est diviser par 4.";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (MENTAL PUR) ---
                else if (world == 21) { 
                    let c = rand(1, 4);
                    let d = rand(1, 4);
                    let u = rand(1, 4);
                    n1 = c * 100 + d * 10 + u;
                    ans = n1 * 11;
                    op = `${n1} √ó 11`;
                    instr = "Le grand √©cart :";
                    hint = "Additionne les voisins deux par deux.";
                } 
                else if (world == 22) { 
                    n1 = rand(2, 9) * 8; 
                    ans = n1 * 125;
                    op = `${n1} √ó 125`;
                    instr = "Le huiti√®me :";
                    hint = "Divise par 8, multiplie par 1000.";
                } 
                else if (world == 23) { 
                    n1 = rand(1, 6) * 4; 
                    ans = n1 * 75;
                    op = `${n1} √ó 75`;
                    instr = "Trois quarts :";
                    hint = "Divise par 4, x3, x100.";
                } 
                else if (world == 24) { 
                    let e = rand(1, 8);
                    let d = rand(1, 9 - e);
                    n1 = parseFloat(e + "." + d);
                    ans = parseFloat((n1 * 11).toFixed(2));
                    op = `${n1} √ó 11`;
                    instr = "Virgule magique :";
                    hint = "√âcarte les chiffres autour de la virgule.";
                } 
                else if (world == 25) { 
                    let n = rand(123, 500);
                    n1 = n;
                    ans = n * 999;
                    op = `${n} √ó 999`;
                    instr = "ASTUCE ULTIME :";
                    hint = "Fais x1000 - 1 fois (123000 - 123).";
                }
                else {
                    let c7_prefix = rand(10, 25);
                    n1 = c7_prefix * 10 + 5;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Astuce Ultime en 5 :";
                    hint = `${c7_prefix} x ${c7_prefix+1} ... et colle 25.`;
                }
                break;

            case 8: // D√âCIMAL & ARGENT
                // --- MONDES 1 √† 5 : BASES (DEMIS & UNIT√âS) ---
                if (world == 1) { 
                    n1 = rand(1, 9); 
                    n2 = 0.5; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Additionne :"; 
                    hint = "Ajoute la moiti√©."; 
                } 
                else if (world == 2) { 
                    n1 = rand(1, 5) + 0.5; 
                    n2 = 0.5;
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    instr = "Compl√®te l'entier :"; 
                    hint = "Deux moiti√©s font un entier."; 
                } 
                else if (world == 3) { 
                    n1 = rand(2, 9) + 0.5; 
                    n2 = 0.5; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    instr = "Enl√®ve la virgule :"; 
                    hint = "Il ne reste que l'entier."; 
                } 
                else if (world == 4) { 
                    let base = rand(1, 6);
                    n1 = base + 0.5; 
                    ans = n1 * 2; 
                    op = `${n1} + ${n1}`; 
                    instr = "Double :"; 
                    hint = "0.5 + 0.5 = 1."; 
                } 
                else if (world == 5) { 
                    let d = rand(1, 9);
                    n2 = d / 10;
                    n1 = 1;
                    ans = parseFloat((1 - n2).toFixed(1));
                    op = `1 - ${n2}`;
                    instr = "Compl√©ment √† 1 :"; 
                    hint = "Comme pour aller √† 10."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (MONNAIE SIMPLE) ---
                else if (world == 6) { 
                    let c = rand(15, 85);
                    if (c % 10 === 0) c++;
                    n2 = c / 100;
                    n1 = 1;
                    ans = parseFloat((1 - n2).toFixed(2));
                    op = `1 - ${n2}`;
                    instr = "Rendu sur 1‚Ç¨ :"; 
                    hint = "Compl√©ment √† 100."; 
                } 
                else if (world == 7) { 
                    n1 = 1;
                    n2 = rand(0, 1) ? 0.25 : 0.75;
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "Soustrais :"; 
                    hint = "Pense en quarts (25, 50, 75)."; 
                } 
                else if (world == 8) { 
                    let u = rand(1, 5);
                    n1 = parseFloat((u + rand(6, 9)/10).toFixed(1)); 
                    n2 = 0.5;
                    ans = parseFloat((n1 + n2).toFixed(1));
                    op = `${n1} + ${n2}`;
                    instr = "D√©passe l'entier :"; 
                    hint = "Compl√®te d'abord l'entier."; 
                } 
                else if (world == 9) { 
                    let u = rand(2, 6);
                    n1 = parseFloat((u + rand(1, 4)/10).toFixed(1)); 
                    n2 = 0.5;
                    ans = parseFloat((n1 - n2).toFixed(1));
                    op = `${n1} - ${n2}`;
                    instr = "Descends l'entier :"; 
                    hint = "Recule de 0.2 puis 0.3."; 
                } 
                else if (world == 10) { 
                    let u1 = rand(1, 9);
                    let u2 = rand(1, 9);
                    n1 = u1 + 0.5;
                    n2 = u2 + 0.5;
                    ans = u1 + u2 + 1;
                    op = `${n1} + ${n2}`;
                    instr = "Assemble :"; 
                    hint = "Additionne les entiers, puis ajoute 1."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (PI√àGES D'ALIGNEMENT) ---
                else if (world == 11) { 
                    n1 = 1.5;
                    n2 = 0.25;
                    ans = 1.75;
                    op = `${n1} + ${n2}`;
                    if (rand(0, 1)) { n1 = 2.5; n2 = 0.75; ans = 3.25; }
                    instr = "Ne tombe pas dans le pi√®ge :"; 
                    hint = "1.5 c'est 1.50."; 
                } 
                else if (world == 12) { 
                    let base = [10, 20, 50][rand(0, 2)];
                    n1 = base;
                    n2 = 0.99;
                    ans = parseFloat((base - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "Prix magasin :"; 
                    hint = "Enl√®ve 1, rends 1 centime."; 
                } 
                else if (world == 13) { 
                    n1 = rand(0, 1) ? 10 : 20;
                    let u = rand(1, n1 - 5);
                    n2 = u + 0.5;
                    ans = n1 - n2;
                    op = `${n1} - ${n2}0`; 
                    instr = "Rends la monnaie :"; 
                    hint = "Compl√®te √† l'entier sup, puis au total."; 
                } 
                else if (world == 14) { 
                    let u1 = rand(1, 5);
                    let u2 = rand(1, 5);
                    n1 = u1 + 0.5;
                    n2 = u2 + 0.5;
                    let n3 = 0.5;
                    ans = u1 + u2 + 1.5;
                    op = `${n1} + ${n2} + ${n3}`;
                    instr = "Compte la caisse :"; 
                    hint = "Groupe les 0.5 par deux."; 
                } 
                else if (world == 15) { 
                    n1 = 2.5;
                    let k = rand(2, 6);
                    ans = n1 * k;
                    op = `${n1}0 √ó ${k}`;
                    instr = "Multiplie :"; 
                    hint = "Double = 5. Compte les 5."; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (ALIGNEMENT ET SIGNES) ---
                else if (world == 16) { 
                    let u = rand(1, 8);
                    n1 = parseFloat((u + 0.9).toFixed(1));
                    n2 = 0.2;
                    ans = parseFloat((n1 + n2).toFixed(1));
                    op = `${n1} + ${n2}`;
                    instr = "Additionne :"; 
                    hint = "Passe l'unit√© (9+2 = 11 dixi√®mes)."; 
                } 
                else if (world == 17) { 
                    n1 = 0.75;
                    n2 = 0.75;
                    ans = 1.5;
                    op = `${n1} + ${n2}`;
                    instr = "Additionne :"; 
                    hint = "75 + 75 = 150 centimes."; 
                } 
                else if (world == 18) { 
                    n1 = rand(2, 10);
                    n2 = 0.05;
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "Juste un peu moins :"; 
                    hint = "Pense 5.00 - 0.05."; 
                } 
                else if (world == 19) { 
                    n1 = 50;
                    let u = rand(10, 35);
                    let dec = rand(1, 9) * 10; 
                    n2 = parseFloat((u + dec/100).toFixed(2));
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2.toFixed(2)}`;
                    instr = "Caisse :"; 
                    hint = "Compl√®te √† 100 centimes, puis l'entier."; 
                } 
                else if (world == 20) { 
                    n1 = rand(5, 20);
                    n2 = n1 + 0.5;
                    ans = -0.5;
                    op = `${n1} - ${n2}`;
                    instr = "Dette :"; 
                    hint = "Tu d√©penses plus que tu n'as."; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (PR√âCISION MAXIMALE) ---
                else if (world == 21) { 
                    n1 = 1.05;
                    n2 = 0.9;
                    ans = 1.95;
                    op = `${n1} + ${n2}`;
                    if (rand(0, 1)) { n1 = 2.05; n2 = 0.5; ans = 2.55; }
                    instr = "Alignement strict :"; 
                    hint = "0.9 c'est 0.90."; 
                } 
                else if (world == 22) { 
                    n1 = rand(2, 9);
                    n2 = parseFloat((n1 - 0.001).toFixed(3));
                    ans = 0.001;
                    op = `${n1} - ${n2}`;
                    instr = "Milli√®me :"; 
                    hint = "Tout petit √©cart."; 
                } 
                else if (world == 23) { 
                    let target = rand(10, 50);
                    let known = rand(1, 9) + 0.5;
                    n1 = known;
                    ans = target - known;
                    op = `x + ${n1} = ${target}`;
                    instr = "Trouve x :"; 
                    hint = "Soustraction : Total - Connu."; 
                } 
                else if (world == 24) { 
                    n1 = 100;
                    n2 = 0.01;
                    ans = 99.99;
                    op = `${n1} - ${n2}`;
                    instr = "Pr√©cision :"; 
                    hint = "99 et 100 centimes."; 
                } 
                else if (world == 25) { 
                    n1 = 1000;
                    let u = rand(10, 99);
                    let dec = rand(11, 89);
                    n2 = parseFloat((u + dec/100).toFixed(2));
                    ans = parseFloat((n1 - n2).toFixed(2));
                    op = `${n1} - ${n2}`;
                    instr = "COMPTE FINAL :";
                    hint = "999 pour l'entier, compl√©ment 100 pour d√©cimale.";
                }
                else {
                    let c8_start = rand(1, 9) * 10;
                    ans = parseFloat((c8_start - 1 + 0.1 - 0.01 + 0.001).toFixed(3));
                    op = `${c8_start} - 1 + 0.1 - 0.01 + 0.001`;
                    instr = "Oscillation :";
                    hint = "Calcule en cascade (9... 9.1... 9.09...).";
                }
                break;

            case 9: // TEMPS
                // --- MONDES 1 √† 5 : BASES (CONVERSIONS SIMPLES) ---
                if (world == 1) { 
                    let h = rand(2, 9);
                    ans = h * 60;
                    op = `${h} h en min`;
                    instr = "Convertis :";
                    hint = "1 heure = 60 minutes.";
                } 
                else if (world == 2) { 
                    let h = rand(0, 1) ? 0.5 : 1.5;
                    ans = h * 60;
                    op = `${h} h en min`;
                    instr = "Convertis :";
                    hint = "0.5 h = 30 minutes.";
                } 
                else if (world == 3) { 
                    let q = rand(1, 3); 
                    if (q === 2) q = 1; 
                    let val = q * 0.25; 
                    ans = val * 60;
                    op = `${val} h en min`;
                    instr = "Convertis :";
                    hint = "Un quart d'heure = 15 min.";
                } 
                else if (world == 4) { 
                    let m = rand(1, 5) * 10;
                    ans = 60 - m;
                    op = `1h - ${m} min`;
                    instr = "Reste en minutes :";
                    hint = "Compl√©ment √† 60.";
                } 
                else if (world == 5) { 
                    let m1 = rand(20, 50);
                    let m2 = rand(20, 50);
                    ans = m1 + m2;
                    op = `${m1}min + ${m2}min`;
                    instr = "Total minutes :";
                    hint = "Additionne simplement.";
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (SYST√àME D√âCIMAL) ---
                else if (world == 6) { 
                    let d = rand(1, 9);
                    n1 = d / 10;
                    ans = d * 6;
                    op = `${n1} h en min`;
                    instr = "Convertis :";
                    hint = "0.1 h = 6 minutes (un dixi√®me de 60).";
                } 
                else if (world == 7) { 
                    let n = rand(1, 2);
                    ans = n * 20;
                    op = `${n}/3 h en min`;
                    instr = "Convertis :";
                    hint = "Un tiers de 60 = 20.";
                } 
                else if (world == 8) { 
                    n1 = rand(0, 1) ? 1 : 5;
                    ans = n1 * 10;
                    op = `${n1}/6 h en min`;
                    instr = "Convertis :";
                    hint = "Un sixi√®me de 60 = 10.";
                } 
                else if (world == 9) { 
                    let startM = rand(45, 55);
                    let endM = rand(5, 25);
                    ans = (60 - startM) + endM;
                    let h = rand(8, 20);
                    op = `${h}h${startM} √† ${h + 1}h${endM}`;
                    instr = "Dur√©e en minutes :";
                    hint = "Finis l'heure, puis ajoute le reste.";
                } 
                else if (world == 10) { 
                    let startM = rand(10, 20);
                    let subM = rand(30, 50);
                    ans = (60 + startM) - subM;
                    op = `1h${startM} - ${subM} min`;
                    instr = "Reste en minutes :";
                    hint = "Convertis tout en minutes (1h = 60).";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (CONVERSIONS COMPLEXES) ---
                else if (world == 11) { 
                    let d = rand(1, 9);
                    n1 = parseFloat((1 + d / 10).toFixed(1));
                    ans = 60 + d * 6;
                    op = `${n1} h en min`;
                    instr = "Convertis :";
                    hint = "1h (60) + 0." + d + "h (" + d * 6 + ").";
                } 
                else if (world == 12) { 
                    let m = rand(1, 9) * 6; 
                    ans = parseFloat((m / 60).toFixed(1));
                    op = `${m} min en h`;
                    instr = "En heure d√©cimale :";
                    hint = "Divise par 60 (Table de 6).";
                } 
                else if (world == 13) { 
                    let n = rand(1, 4);
                    ans = n * 12;
                    op = `${n}/5 h en min`;
                    instr = "Convertis :";
                    hint = "1/5 de 60 = 12 minutes.";
                } 
                else if (world == 14) { 
                    let m = [15, 30, 45][rand(0, 2)];
                    ans = parseFloat((1 + m / 60).toFixed(2));
                    let mDisplay = (m === 30) ? "30" : m; 
                    op = `1h${mDisplay} en h`;
                    instr = "Heure d√©cimale :";
                    hint = "30min = 0.5, 15min = 0.25, 45min = 0.75.";
                } 
                else if (world == 15) { 
                    n1 = 0.05;
                    ans = 3;
                    op = `${n1} h en min`;
                    instr = "Convertis :";
                    hint = "La moiti√© de 0.1h (donc moiti√© de 6 min).";
                }
                // --- MONDES 16 √† 20 : LYC√âE (PI√àGES & SECONDES) ---
                else if (world == 16) { 
                    let h = rand(1, 3);
                    let centiemes = rand(1, 19) * 5; 
                    n1 = parseFloat((h + centiemes / 100).toFixed(2));
                    let minPart = centiemes * 0.6;
                    ans = h * 60 + minPart;
                    op = `${n1} h en min`;
                    instr = "Convertis :";
                    hint = `Attention : 0.${centiemes < 10 ? '0'+centiemes : centiemes}h = ${minPart} min.`;
                } 
                else if (world == 17) { 
                    n1 = 1.5;
                    let sub = rand(35, 55);
                    ans = 90 - sub;
                    op = `${n1} h - ${sub} min`;
                    instr = "Reste en minutes :";
                    hint = "1.5h = 90 minutes.";
                } 
                else if (world == 18) { 
                    n1 = 0.1;
                    ans = 360;
                    op = `${n1} h en s`;
                    instr = "En secondes :";
                    hint = "1h = 3600s. Prends le dixi√®me.";
                } 
                else if (world == 19) { 
                    n1 = 0.5;
                    ans = 30;
                    op = `${n1} min en s`;
                    instr = "En secondes :";
                    hint = "Moiti√© d'une minute.";
                } 
                else if (world == 20) { 
                    n1 = 0.2;
                    let m = 12;
                    ans = 24; 
                    op = `${n1} h + ${m} min`;
                    instr = "Total minutes :";
                    hint = "Convertis 0.2h (x6).";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (INDUSTRIEL) ---
                else if (world == 21) { 
                    let parts = [{t: "1/2", m: 30}, {t: "1/3", m: 20}, {t: "1/4", m: 15}, {t: "1/5", m: 12}, {t: "1/6", m: 10}, {t: "0.25", m: 15}, {t: "0.5", m: 30}, {t: "0.75", m: 45}, {t: "0.1", m: 6}];
                    let p1 = parts[rand(0, 8)];
                    let p2 = parts[rand(0, 8)];
                    ans = p1.m + p2.m;
                    op = `${p1.t} h + ${p2.t} h`;
                    instr = "Total minutes :";
                    hint = `${p1.m} min + ${p2.m} min.`;
                } 
                else if (world == 22) { 
                    let hVal = [0.1, 0.2, 0.01, 0.05][rand(0, 3)];
                    let mVal = [0.1, 0.2, 0.5, 0.25][rand(0, 3)];
                    let secFromH = hVal * 3600; 
                    let secFromM = mVal * 60; 
                    ans = secFromH + secFromM;
                    op = `${hVal} h + ${mVal} min`;
                    instr = "Total secondes :";
                    hint = `1h=3600s (${secFromH}) et 1min=60s (${secFromM}).`;
                } 
                else if (world == 23) { 
                    let h = rand(2, 12); 
                    let scenarios = [{dec: 0.5, min: 30}, {dec: 0.25, min: 15}, {dec: 0.75, min: 45}, {dec: 0.1, min: 6}];
                    let scene = scenarios[rand(0, 3)];
                    let subMin = scene.min - rand(1, 5) * 1; 
                    if (subMin < 0) subMin = 0;
                    ans = scene.min - subMin;
                    let displayMin = subMin < 10 ? "0" + subMin : subMin;
                    op = `${h + scene.dec} h - ${h}h${displayMin}`;
                    instr = "√âcart en minutes :";
                    hint = `${h + scene.dec} h = ${h}h${scene.min}.`;
                } 
                else if (world == 24) { 
                    n1 = 0.02;
                    ans = 1.2;
                    op = `${n1} h en min`;
                    instr = "Convertis (d√©cimal) :";
                    hint = "2 pourcent de 60 (6x2 divis√© par 10).";
                } 
                else if (world == 25) { 
                    n1 = 1.75;
                    let h2 = 1, m2 = 15;
                    ans = 3;
                    op = `${n1} h + ${h2}h${m2}`;
                    instr = "Total en Heure D√©cimale :";
                    hint = "Convertis 1h15 en 1.25h.";
                }
                else {
                    let c9_h = rand(1, 3);
                    let c9_m = rand(1, 59);
                    let c9_s = rand(1, 59);
                    ans = c9_h * 3600 + c9_m * 60 + c9_s;
                    op = `${c9_h}h ${c9_m}min ${c9_s}s en secondes`;
                    instr = "Conversion Totale :";
                    hint = "1h = 3600s. Courage.";
                }
                break;
case 10: // CARR√âS & RACINES
                // --- MONDES 1 √† 5 : BASES (PAR C≈íUR) ---
                if (world == 1) { 
                    n1 = rand(1, 5); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    instr = "Carr√© :"; 
                    hint = "Le nombre multipli√© par lui-m√™me."; 
                } 
                else if (world == 2) { 
                    n1 = rand(6, 9); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    instr = "Calcule :"; 
                    hint = "Table de multiplication."; 
                } 
                else if (world == 3) { 
                    n1 = rand(0, 1) ? 10 : 0; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    instr = "Calcule :"; 
                    hint = "Facile."; 
                } 
                else if (world == 4) { 
                    ans = rand(2, 9);
                    n1 = ans * ans;
                    op = `‚àö${n1}`;
                    instr = "Racine carr√©e :";
                    hint = "Quel nombre au carr√© donne √ßa ?";
                } 
                else if (world == 5) { 
                    n1 = rand(2, 9) * 10;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Calcule :";
                    hint = "Carr√© du chiffre + deux z√©ros.";
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (MEMORISATION) ---
                else if (world == 6) { 
                    n1 = rand(11, 12);
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Par c≈ìur :";
                    hint = "121 ou 144.";
                } 
                else if (world == 7) { 
                    n1 = rand(13, 14);
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Par c≈ìur :";
                    hint = "169 ou 196 (le 6 et 9 s'inversent).";
                } 
                else if (world == 8) { 
                    n1 = rand(0, 1) ? 15 : 25;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Se finit par 5 :";
                    hint = "225 ou 625.";
                } 
                else if (world == 9) { 
                    ans = rand(11, 15);
                    n1 = ans * ans;
                    op = `‚àö${n1}`;
                    instr = "Racine :";
                    hint = "Plus grand que 10.";
                } 
                else if (world == 10) { 
                    n1 = rand(16, 19);
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Le plus dur :";
                    hint = "Regarde le dernier chiffre (ex: 9x9=81 -> finit par 1).";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (SIGNES & D√âCIMAUX) ---
                else if (world == 11) { 
                    n1 = rand(2, 12);
                    ans = n1 * n1;
                    op = `(-${n1})¬≤`;
                    instr = "Signe :";
                    hint = "Un carr√© est toujours positif.";
                } 
                else if (world == 12) { 
                    let d = rand(1, 9);
                    n1 = d / 10;
                    ans = parseFloat((n1 * n1).toFixed(2));
                    op = `${n1}¬≤`;
                    instr = "Attention aux z√©ros :";
                    hint = "3x3=9 mais 0.3x0.3=0.09 (2 d√©cimales).";
                } 
                else if (world == 13) { 
                    ans = rand(2, 9) * 10; 
                    n1 = ans * ans; 
                    op = `‚àö${n1}`;
                    instr = "Racine :";
                    hint = "Racine du chiffre, moiti√© des z√©ros.";
                } 
                else if (world == 14) { 
                    let r = rand(1, 9);
                    ans = r / 10; 
                    n1 = parseFloat((ans * ans).toFixed(2)); 
                    op = `‚àö${n1}`;
                    instr = "Racine :";
                    hint = "Cherche la table (ex: 7x7=49).";
                } 
                else if (world == 15) { 
                    let bases = [2, 3, 4, 5, 6, 7, 8, 9, 11, 12, 15, 25]; 
                    let b = bases[rand(0, bases.length - 1)];
                    let p = rand(1, 2); 
                    let div = Math.pow(10, p);
                    n1 = b / div; 
                    ans = parseFloat((n1 * n1).toFixed(p * 2));
                    op = `${n1}¬≤`;
                    instr = "Calcule :";
                    hint = `${b}x${b} = ${b*b}, place ${p*2} chiffres apr√®s la virgule.`;
                }
                // --- MONDES 16 √† 20 : LYC√âE (IDENTIT√âS & ASTUCES) ---
                else if (world == 16) { 
                    let d = rand(3, 9);
                    n1 = d * 10 + 5;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Astuce en 5 :";
                    hint = `${d}x${d+1} et ajoute 25 √† la fin.`;
                } 
                else if (world == 17) { 
                    let d = rand(2, 6);
                    n1 = d * 10 + 1; 
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Identit√© remarquable :";
                    hint = `(${n1-1} + 1)¬≤.`;
                } 
                else if (world == 18) { 
                    let d = rand(2, 6);
                    n1 = d * 10 - 1; 
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Identit√© remarquable :";
                    hint = `(${n1+1} - 1)¬≤.`;
                } 
                else if (world == 19) { 
                    let a = rand(3, 10);
                    let b = a - 1;
                    ans = a*a - b*b; 
                    op = `${a}¬≤ - ${b}¬≤`;
                    instr = "Astuce :";
                    hint = "(a-b)(a+b). Ici l'√©cart est de 1.";
                } 
                else if (world == 20) { 
                    let type = rand(0, 2); 
                    let a, b;
                    if (type === 0) { 
                        let k = [1, 2, 3, 10][rand(0, 3)]; a = 3 * k; b = 4 * k;
                    } else if (type === 1) { 
                        if (rand(0, 1)) { a = 5; b = 12; } else { a = rand(1, 5); b = rand(1, 5); } 
                    } else {
                        a = rand(1, 9); b = 10;
                    }
                    if (rand(0, 1)) { let temp = a; a = b; b = temp; }
                    ans = a*a + b*b;
                    op = `${a}¬≤ + ${b}¬≤`;
                    instr = "Somme des carr√©s :";
                    hint = `Calcule ${a*a} + ${b*b}.`;
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (CALCUL MENTAL PUR) ---
                else if (world == 21) { 
                    n1 = rand(11, 15) * 10;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "Gros carr√© :";
                    hint = "Carr√© de 12...15 et deux z√©ros.";
                } 
                else if (world == 22) { 
                    let u = rand(1, 3);
                    n1 = u + 0.5;
                    ans = parseFloat((n1 * n1).toFixed(2));
                    op = `${n1}¬≤`;
                    instr = "D√©cimal :";
                    hint = "15¬≤ = 225, 25¬≤ = 625...";
                } 
                else if (world == 23) { 
                    n1 = rand(3, 9) * 10;
                    ans = n1 * n1 - 1;
                    op = `${n1}¬≤ - 1`;
                    instr = "Astuce :";
                    hint = `(${n1}-1)(${n1}+1).`;
                } 
                else if (world == 24) { 
                    ans = 0.04; n1 = 0.0016; op = `‚àö${n1}`;
                    if (rand(0, 1)) { ans = 0.09; n1 = 0.0081; }
                    instr = "Racine pr√©cise :";
                    hint = "4 d√©cimales deviennent 2.";
                } 
                else if (world == 25) { 
                    let d = rand(10, 12);
                    n1 = d * 10 + 5;
                    ans = n1 * n1;
                    op = `${n1}¬≤`;
                    instr = "CARR√â ULTIME :";
                    hint = `${d}x${d+1} et 25 √† la fin.`;
                }
                else {
                    // BOSS FINAL : Racine d'un produit
                    // Le joueur doit calculer l'int√©rieur pour trouver un carr√© parfait.
                    // Ex: ‚àö(20 x 80) = ‚àö1600 = 40
                    
                    // 1. On choisit la r√©ponse cible (10, 20, 30... jusqu'√† 90)
                    let root = rand(2, 9) * 10; 
                    let square = root * root; // ex: 3600
                    
                    // 2. On d√©compose ce carr√© en deux nombres (a * b)
                    // On cherche des facteurs simples (2, 3, 4, 5, 8, 9)
                    let factors = [];
                    [2, 3, 4, 5, 6, 8, 9].forEach(f => {
                        if (square % f === 0) factors.push(f);
                    });
                    
                    let a = factors[rand(0, factors.length - 1)];
                    let b = square / a;
                    
                    ans = root;
                    op = `‚àö(${a} √ó ${b})`;
                    
                    instr = "Racine compos√©e :";
                    hint = `Calcule d'abord ${a} √ó ${b} (√ßa donne un carr√© parfait).`;
                }
                break;

            case 11: // FRACTIONS
                // --- MONDES 1 √† 5 : BASES VISUELLES (PRIMAIRE) ---
                if (world == 1) { 
                    let m = rand(1, 5);
                    let num = 1 * m;
                    let den = 2 * m;
                    ans = 0.5;
                    op = `${num}/${den}`;
                    instr = "En d√©cimal :";
                    hint = "C'est la moiti√©.";
                } 
                else if (world == 2) { 
                    let k = [1, 2, 3, 5, 25][rand(0, 4)];
                    ans = 0.25;
                    op = `${1*k}/${4*k}`;
                    instr = "En d√©cimal :";
                    hint = "C'est un quart (0.25).";
                } 
                else if (world == 3) { 
                    let k = [1, 2, 10, 25][rand(0, 3)];
                    ans = 0.75;
                    op = `${3*k}/${4*k}`;
                    instr = "En d√©cimal :";
                    hint = "Trois fois 0.25.";
                } 
                else if (world == 4) { 
                    let k = rand(2, 20);
                    ans = 1;
                    op = `${k}/${k}`;
                    instr = "En entier :";
                    hint = "Un nombre divis√© par lui-m√™me.";
                } 
                else if (world == 5) { 
                    n1 = rand(1, 9);
                    ans = n1 / 10;
                    op = `${n1}/10`;
                    instr = "Convertis :";
                    hint = "0 virgule le nombre.";
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (DENOMINATEURS STANDARDS) ---
                else if (world == 6) { 
                    n1 = rand(1, 99);
                    ans = n1 / 100;
                    op = `${n1}/100`;
                    instr = "Convertis :";
                    hint = "Deux chiffres apr√®s la virgule.";
                } 
                else if (world == 7) { 
                    n1 = rand(1, 4);
                    ans = n1 * 0.2;
                    op = `${n1}/5`;
                    instr = "En d√©cimal :";
                    hint = "Multiplie par 2, divise par 10.";
                } 
                else if (world == 8) { 
                    let den = rand(2, 5);
                    ans = rand(2, 6);
                    n1 = ans * den;
                    op = `${n1}/${den}`;
                    instr = "Simplifie (Entier) :";
                    hint = "C'est une division qui tombe juste.";
                } 
                else if (world == 9) { 
                    n1 = rand(1, 9); 
                    ans = (n1 * 5) / 100;
                    op = `${n1}/20`;
                    instr = "En d√©cimal :";
                    hint = "Multiplie par 5 pour avoir /100.";
                } 
                else if (world == 10) { 
                    n1 = rand(1, 24);
                    ans = (n1 * 2) / 100;
                    op = `${n1}/50`;
                    instr = "En d√©cimal :";
                    hint = "Multiplie par 2 pour avoir /100.";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (IMPROPRES & N√âGATIFS) ---
                else if (world == 11) { 
                    let num = rand(3, 9);
                    if (num % 2 === 0) num++; 
                    ans = num / 2;
                    op = `${num}/2`;
                    instr = "D√©passe 1 :";
                    hint = "C'est " + (num-1)/2 + " et demi.";
                } 
                else if (world == 12) { 
                    n1 = rand(1, 10);
                    ans = (n1 * 4) / 100;
                    op = `${n1}/25`;
                    instr = "En d√©cimal :";
                    hint = "Multiplie par 4 pour avoir /100.";
                } 
                else if (world == 13) { 
                    n1 = rand(1, 3);
                    let den = [2, 4, 5, 10][rand(0, 3)];
                    ans = -(n1 / den);
                    op = `-${n1}/${den}`;
                    instr = "En d√©cimal :";
                    hint = "Juste le signe change.";
                } 
                else if (world == 14) { 
                    let num = rand(5, 9);
                    ans = num / 4;
                    op = `${num}/4`;
                    instr = "En d√©cimal :";
                    hint = "4/4 fait 1. Calcule le reste.";
                } 
                else if (world == 15) { 
                    let list = [{v: 0.5, d: 2, n: 1}, {v: 0.2, d: 5, n: 1}, {v: 0.25, d: 4, n: 1}, {v: 0.75, d: 4, n: 3}];
                    let item = list[rand(0, 3)];
                    ans = item.n;
                    op = `${item.v} = ?/${item.d}`;
                    instr = "Trouve le num√©rateur :";
                    hint = "Quelle fraction donne ce nombre ?";
                }
                // --- MONDES 16 √† 20 : LYC√âE (DENOMINATEURS COMPLEXES) ---
                else if (world == 16) { 
                    let k = [1, 2, 4, 10][rand(0, 3)];
                    ans = 0.125;
                    op = `${1*k}/${8*k}`;
                    instr = "3 d√©cimales :";
                    hint = "Moiti√© de 0.25 (simplify la fraction).";
                } 
                else if (world == 17) { 
                    n1 = rand(1, 2);
                    ans = parseFloat((n1 / 3).toFixed(2));
                    op = `${n1}/3`;
                    instr = "Arrondi 2 d√©cimales :";
                    hint = "0.33... ou 0.66...";
                } 
                else if (world == 18) { 
                    n1 = rand(0, 1) ? 3 : 5;
                    ans = n1 * 0.125;
                    op = `${n1}/8`;
                    instr = "En d√©cimal :";
                    hint = "1/8 = 0.125. Multiplie par " + n1 + ".";
                } 
                else if (world == 19) { 
                    n1 = rand(2, 12) * 2; 
                    ans = n1 / 40;
                    op = `${n1}/40`;
                    instr = "En d√©cimal :";
                    hint = "Divise par 4, puis d√©cale la virgule.";
                } 
                else if (world == 20) { 
                    let den = rand(5, 12);
                    let num = rand(1, den - 1);
                    ans = den - num;
                    op = `1 - ${num}/${den} = ?/${den}`;
                    instr = "Num√©rateur manquant :";
                    hint = "Pour faire un entier complet.";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (MENTAL PUR) ---
                else if (world == 21) { 
                    let vals = [{n: 2, v: 0.5}, {n: 4, v: 0.25}, {n: 5, v: 0.2}, {n: 10, v: 0.1}, {n: 20, v: 0.05}];
                    let i1 = rand(0, 4);
                    let i2 = rand(0, 4);
                    let f1 = vals[i1];
                    let f2 = vals[i2];
                    ans = parseFloat((f1.v + f2.v).toFixed(2));
                    op = `1/${f1.n} + 1/${f2.n}`;
                    instr = "Somme d√©cimale :";
                    hint = `${f1.v} + ${f2.v}`;
                } 
                else if (world == 22) { 
                    let numFrac = [{t: "1/2", v: 0.5}, {t: "1/4", v: 0.25}, {t: "1/5", v: 0.2}, {t: "1/10", v: 0.1}];
                    let divisors = [{t: "2", v: 2}, {t: "0.5", v: 0.5}];
                    let f = numFrac[rand(0, 3)];
                    let d = divisors[rand(0, 1)];
                    ans = f.v / d.v;
                    let symbol = rand(0,1) ? " / " : " √∑ ";
                    op = `(${f.t})${symbol}${d.t}`;
                    instr = "En d√©cimal :";
                    hint = d.v === 2 ? "Prends la moiti√©." : "Double le nombre.";
                } 
                else if (world == 23) { 
                    let k = rand(1, 4);
                    ans = k * 0.008;
                    let mult = rand(1, 2); 
                    op = `${k*mult}/${125*mult}`;
                    instr = "3 d√©cimales :";
                    hint = `1/125 = 0.008. Ici tu en as ${k}.`;
                } 
                else if (world == 24) { 
                    let k = rand(1, 3);
                    ans = k * 0.0625;
                    op = `${k}/16`;
                    instr = "4 d√©cimales :";
                    hint = `1/16 = 0.0625. Multiplie par ${k}.`;
                } 
                else if (world == 25) { 
                    let ent = rand(10, 50);
                    let list = [{n: 1, d: 2, v: 0.5}, {n: 1, d: 4, v: 0.25}, {n: 3, d: 4, v: 0.75}, {n: 2, d: 5, v: 0.4}, {n: 4, d: 5, v: 0.8}, {n: 1, d: 8, v: 0.125}];
                    let f = list[rand(0, 5)];
                    ans = ent + f.v;
                    op = `${ent} + ${f.n}/${f.d}`;
                    instr = "VALEUR D√âCIMALE :";
                    hint = "Colle la valeur de la fraction √† l'entier.";
                }
                else {
                    // BOSS FINAL : Assemblage D√©cimal (Conversion & Somme)
                    // M√©lange d'entiers et de fractions √† convertir.
                    
                    let ent = rand(0, 10);
                    
                    // Liste A : Fractions courantes (Quarts, Cinqui√®mes)
                    let listA = [
                        {t:"1/2", v:0.5}, {t:"1/4", v:0.25}, {t:"3/4", v:0.75},
                        {t:"1/5", v:0.2}, {t:"2/5", v:0.4}, {t:"3/5", v:0.6}, {t:"4/5", v:0.8}
                    ];
                    
                    // Liste B : Fractions de pr√©cision (Huiti√®mes, Vingti√®mes, 25√®mes)
                    let listB = [
                        {t:"1/8", v:0.125}, {t:"3/8", v:0.375}, 
                        {t:"1/20", v:0.05}, {t:"3/20", v:0.15}, 
                        {t:"1/25", v:0.04}, {t:"1/50", v:0.02}
                    ];

                    let fA = listA[rand(0, listA.length - 1)];
                    let fB = listB[rand(0, listB.length - 1)];
                    
                    ans = parseFloat((ent + fA.v + fB.v).toFixed(3));
                    
                    if (ent === 0) {
                        op = `${fA.t} + ${fB.t}`;
                    } else {
                        op = `${ent} + ${fA.t} + ${fB.t}`;
                    }
                    
                    instr = "Somme d√©cimale :";
                    hint = `Convertis : ${fA.t}=${fA.v} et ${fB.t}=${fB.v}.`;
                }
                break;

            case 12: // CONVERSIONS (UNIT√âS)
                // --- MONDES 1 √† 5 : BASES (SYST√àME M√âTRIQUE SIMPLE) ---
                if (world == 1) { 
                    n1 = rand(1, 15); 
                    ans = n1 * 1000; 
                    op = `${n1} km en m`; 
                    instr = "Convertis :"; 
                    hint = "Kilo = 1000."; 
                } 
                else if (world == 2) { 
                    n1 = rand(1, 25); 
                    ans = n1 * 100; 
                    op = `${n1} m en cm`; 
                    instr = "Convertis :"; 
                    hint = "Centi = 100 (ajoute 2 z√©ros)."; 
                } 
                else if (world == 3) { 
                    n1 = rand(1, 9); 
                    ans = n1 * 1000; 
                    op = `${n1} kg en g`; 
                    instr = "Convertis :"; 
                    hint = "1 kg = 1000 g."; 
                } 
                else if (world == 4) { 
                    n1 = rand(2, 50); 
                    ans = n1 * 10; 
                    op = `${n1} cm en mm`; 
                    instr = "Convertis :"; 
                    hint = "1 cm = 10 mm (r√®gle d'√©colier)."; 
                } 
                else if (world == 5) { 
                    n1 = rand(1, 9); 
                    ans = n1 * 1000; 
                    op = `${n1} L en mL`; 
                    instr = "Convertis :"; 
                    hint = "Milli = 1000 (ajoute 3 z√©ros)."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (D√âCIMAUX & INVERSES) ---
                else if (world == 6) { 
                    let u = rand(1, 9);
                    n1 = u + 0.5;
                    ans = n1 * 1000;
                    op = `${n1} km en m`;
                    instr = "Convertis :";
                    hint = "D√©cale la virgule de 3 rangs."; 
                } 
                else if (world == 7) { 
                    ans = rand(1, 9) + (rand(0, 1) ? 0.5 : 0);
                    n1 = ans * 1000;
                    op = `${n1} m en km`;
                    instr = "Convertis :";
                    hint = "Enl√®ve 3 z√©ros ou recule la virgule."; 
                } 
                else if (world == 8) { 
                    n1 = rand(120, 450);
                    ans = n1 / 100;
                    op = `${n1} cm en m`;
                    instr = "Convertis :";
                    hint = "Recule la virgule de 2 rangs."; 
                } 
                else if (world == 9) { 
                    n1 = rand(15, 95);
                    ans = n1 / 10;
                    op = `${n1} mm en cm`;
                    instr = "Convertis :";
                    hint = "10 mm font 1 cm."; 
                } 
                else if (world == 10) { 
                    let u = rand(1, 9);
                    n1 = u + (rand(1, 9) / 10);
                    ans = n1 * 1000;
                    op = `${n1} t en kg`;
                    instr = "Poids lourd :";
                    hint = "1 tonne = 1000 kg."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (SURFACES & PETITS VOLUMES) ---
                else if (world == 11) { 
                    n1 = parseFloat((rand(1, 5) + rand(1, 9)/10).toFixed(1));
                    ans = Math.round(n1 * 100);
                    op = `${n1} L en cL`;
                    instr = "Canette :";
                    hint = "Centi-litre = x100."; 
                } 
                else if (world == 12) { 
                    n1 = rand(2, 9);
                    ans = n1 * 100;
                    op = `${n1} m¬≤ en dm¬≤`;
                    instr = "Surface (Carr√©) :";
                    hint = "Le pas est double : x100."; 
                } 
                else if (world == 13) { 
                    n1 = rand(1, 5);
                    if (rand(0, 1)) n1 += 0.5;
                    ans = n1 * 10000;
                    op = `${n1} ha en m¬≤`;
                    instr = "Surface terrain :";
                    hint = "1 ha = 10 000 m¬≤ (carr√© de 100m)."; 
                } 
                else if (world == 14) { 
                    n1 = rand(1, 5);
                    ans = n1 * 1000;
                    op = `${n1} m¬≥ en L`;
                    instr = "Eau :";
                    hint = "Un cube d'un m√®tre contient 1000 litres."; 
                } 
                else if (world == 15) { 
                    n1 = [33, 50, 75, 25][rand(0, 3)];
                    ans = n1 / 100;
                    op = `${n1} cL en L`;
                    instr = "Convertis :";
                    hint = "Divise par 100."; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (PI√àGES DIMENSIONNELS) ---
                else if (world == 16) { 
                    n1 = rand(1, 5);
                    ans = n1 * 10000;
                    op = `${n1} m¬≤ en cm¬≤`;
                    instr = "Double saut :";
                    hint = "x100 pour dm¬≤, x100 pour cm¬≤ -> x10 000."; 
                } 
                else if (world == 17) { 
                    n1 = rand(5, 50);
                    ans = n1;
                    op = `${n1} dm¬≥ en L`;
                    instr = "√âquivalence :";
                    hint = "C'est la m√™me chose !"; 
                } 
                else if (world == 18) { 
                    n1 = rand(100, 500);
                    ans = n1;
                    op = `${n1} cm¬≥ en mL`;
                    instr = "Seringue :";
                    hint = "C'est la m√™me chose !"; 
                } 
                else if (world == 19) { 
                    n1 = rand(1, 5);
                    ans = n1 * 1000000;
                    op = `${n1} km en mm`;
                    instr = "Microscope :";
                    hint = "x1000 (m) puis x1000 (mm) -> 6 z√©ros."; 
                } 
                else if (world == 20) { 
                    let types = [rand(1, 9) * 50, rand(1, 99) * 100, rand(10, 50) * 1000];
                    n1 = types[rand(0, 2)]; 
                    ans = n1 / 10000;
                    op = `${n1} cm¬≤ en m¬≤`;
                    instr = "Recule de 4 rangs :";
                    hint = "Divise par 10 000 (d√©place la virgule de 4)."; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (SCIENTIFIQUE) ---
                else if (world == 21) { 
                    let v = rand(1, 9) / 10; 
                    n1 = v;
                    ans = Math.round(n1 * 1000000);
                    op = `${n1} m¬≥ en cm¬≥`;
                    instr = "Le Cube :";
                    hint = "Le pas est triple : x1 000 000."; 
                } 
                else if (world == 22) { 
                    n1 = rand(2, 9);
                    ans = n1 * 100;
                    op = `${n1} q en kg`;
                    instr = "Agriculture :";
                    hint = "Un quintal = 100 kg."; 
                } 
                else if (world == 23) { 
                    n1 = rand(5, 50);
                    ans = n1 * 100;
                    op = `${n1} hL en L`;
                    instr = "Cuve :";
                    hint = "Hecto = 100."; 
                } 
                else if (world == 24) { 
                    n1 = 0.05;
                    ans = 50;
                    op = `${n1} m en mm`;
                    instr = "Convertis :";
                    hint = "x1000. 1, 2, 3 rangs."; 
                } 
                else if (world == 25) { 
                    n1 = 0.005;
                    ans = 500;
                    if (rand(0, 1)) { n1 = 0.02; ans = 2000; }
                    op = `${n1} m¬≥ en cL`;
                    instr = "CONVERSION ULTIME :";
                    hint = "Passe par les Litres (x1000), puis cL (x100).";
                }
                else {
                    let c12_ms = rand(50, 300);
                    ans = c12_ms * 3.6;
                    op = `${c12_ms} m/s en km/h`;
                    instr = "Conversion Vitesse :";
                    hint = "Multiplie par 3.6 (x3 + x0.6).";
                }
                break;

            case 13: // OP√âRATIONS FRACTIONS
                // --- MONDES 1 √† 5 : BASES (D√âNOMINATEURS COMMUNS) ---
                if (world == 1) { 
                    let den = [4, 5, 10, 20][rand(0, 3)];
                    let n1 = rand(1, den - 1);
                    let n2 = rand(1, den - n1); 
                    ans = (n1 + n2) / den;
                    op = `${n1}/${den} + ${n2}/${den}`;
                    instr = "Additionne (d√©cimal) :"; 
                    hint = "Additionne les hauts, garde le bas."; 
                } 
                else if (world == 2) { 
                    let den = [2, 4, 5, 10][rand(0, 3)];
                    let n1 = rand(2, den - 1);
                    let n2 = rand(1, n1);
                    ans = (n1 - n2) / den;
                    op = `${n1}/${den} - ${n2}/${den}`;
                    instr = "Soustrais :"; 
                    hint = "Soustrais les num√©rateurs."; 
                } 
                else if (world == 3) { 
                    let denOk = [2, 4, 5, 8, 10, 20, 25, 50][rand(0, 7)];
                    let num = rand(1, denOk - 1);
                    ans = (denOk - num) / denOk;
                    op = `1 - ${num}/${denOk}`;
                    instr = "Le reste (d√©cimal) :"; 
                    hint = "Compl√®te pour faire un entier."; 
                } 
                else if (world == 4) { 
                    let ent = rand(1, 5);
                    let den = [2, 4, 5, 10][rand(0, 3)];
                    let num = rand(1, den - 1);
                    ans = ent + (num / den);
                    op = `${ent} + ${num}/${den}`;
                    instr = "Additionne :"; 
                    hint = "L'entier plus la valeur de la fraction."; 
                } 
                else if (world == 5) { 
                    let den = rand(2, 10);
                    let n1 = rand(1, den - 1);
                    let n2 = den - n1;
                    ans = 1;
                    op = `${n1}/${den} + ${n2}/${den}`;
                    instr = "Calcule :"; 
                    hint = "√áa reconstitue l'unit√©."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (MULTIPLICATION & RELATIFS) ---
                else if (world == 6) { 
                    let den = [2, 3, 4, 5, 10][rand(0, 4)];
                    let ent = rand(1, 5) * den; 
                    ans = ent / den;
                    op = `${ent} √ó 1/${den}`;
                    instr = "Multiplie :"; 
                    hint = `${ent} divis√© par ${den}.`; 
                } 
                else if (world == 7) { 
                    let den = [2, 4, 5, 10][rand(0, 3)];
                    let num = rand(1, 4);
                    let ent = rand(1, 4) * den;
                    ans = (ent * num) / den;
                    op = `${ent} √ó ${num}/${den}`;
                    instr = "Calcule :"; 
                    hint = "Divise l'entier par le bas, multiplie par le haut."; 
                } 
                else if (world == 8) { 
                    let scenarios = [
                        {n1: "1/2", v1: 0.5, n2: "1/4", v2: 0.25}, {n1: "1/4", v1: 0.25, n2: "1/2", v2: 0.5}, 
                        {n1: "1/2", v1: 0.5, n2: "1/10", v2: 0.1}, {n1: "1/5", v1: 0.2, n2: "3/10", v2: 0.3}, 
                        {n1: "1/5", v1: 0.2, n2: "1/10", v2: 0.1}, {n1: "1/4", v1: 0.25, n2: "1/8", v2: 0.125}
                    ];
                    let s = scenarios[rand(0, scenarios.length - 1)];
                    ans = parseFloat((s.v1 + s.v2).toFixed(3));
                    op = `${s.n1} + ${s.n2}`;
                    instr = "Additionne (d√©cimal) :";
                    hint = "Mets au m√™me d√©nominateur.";
                } 
                else if (world == 9) { 
                    let ent = rand(2, 5);
                    ans = ent - 0.5;
                    op = `${ent} - 1/2`;
                    if (rand(0, 1)) { ans = ent - 0.25; op = `${ent} - 1/4`; }
                    instr = "Soustrais :"; 
                    hint = "Recule d'une fraction."; 
                } 
                else if (world == 10) { 
                    let den = [2, 3, 4, 5, 10][rand(0, 4)];
                    let target = rand(2, 8) * den;
                    ans = target / den;
                    op = `1/${den} de ${target}`;
                    instr = "Calcule :"; 
                    hint = "C'est une division."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (D√âCIMAUX & INVERSES) ---
                else if (world == 11) { 
                    let v = [0.5, 0.25, 0.75, 0.1][rand(0, 3)];
                    let fracText = (v == 0.5) ? "1/2" : (v == 0.25) ? "1/4" : (v == 0.75) ? "3/4" : "1/10";
                    ans = v + v;
                    op = `${fracText} + ${v}`;
                    instr = "Additionne :"; 
                    hint = "Convertis tout en d√©cimal."; 
                } 
                else if (world == 12) { 
                    let ent = rand(2, 8);
                    ans = ent * 2;
                    op = `${ent} √∑ 1/2`;
                    instr = "Calcule :"; 
                    hint = "Diviser par une moiti√© double le nombre."; 
                } 
                else if (world == 13) { 
                    let d1 = [2, 4, 5][rand(0, 2)];
                    let d2 = [2, 4, 5][rand(0, 2)];
                    ans = 1 / (d1 * d2);
                    op = `1/${d1} √ó 1/${d2}`;
                    instr = "D√©cimal :"; 
                    hint = `Cherche 1/${d1*d2}.`; 
                } 
                else if (world == 14) { 
                    let type = rand(0, 2);
                    if (type === 0) { op = "1/2 + 1/4 + 1/4"; ans = 1; } 
                    else if (type === 1) { op = "1/5 + 2/5 + 1/5"; ans = 0.8; } 
                    else { op = "1/2 + 1/10 + 1/10"; ans = 0.7; }
                    instr = "Additionne :";
                    hint = "Groupe les fractions identiques.";
                } 
                else if (world == 15) { 
                    let den = [3, 4, 5, 10][rand(0, 3)];
                    let num = rand(1, den - 1);
                    let valFrac = num / den;
                    ans = parseFloat((1 - valFrac).toFixed(2));
                    if (den === 3) { den = rand(0,1) ? 20 : 50; num = rand(1, den-1); valFrac = num/den; ans = parseFloat((1 - valFrac).toFixed(2)); }
                    op = `${num}/${den} + x = 1`;
                    instr = "Trouve x (d√©cimal) :";
                    hint = "Ce qu'il manque pour l'entier.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (ASTUCES & TIERS) ---
                else if (world == 16) { 
                    let k = rand(1, 5);
                    ans = k;
                    op = `${k*3} √ó 1/3`;
                    instr = "Simplifie :"; 
                    hint = "Divise par 3."; 
                } 
                else if (world == 17) { 
                    let scenarios = [
                        {op: "1/2 - 1/4", ans: 0.25}, {op: "3/4 - 1/2", ans: 0.25}, {op: "1/2 - 1/10", ans: 0.4},
                        {op: "4/5 - 1/2", ans: 0.3}, {op: "1 - 1/4", ans: 0.75}, {op: "1/2 - 1/5", ans: 0.3}
                    ];
                    let s = scenarios[rand(0, scenarios.length - 1)];
                    ans = s.ans;
                    op = s.op;
                    instr = "Soustrais :";
                    hint = "Convertis en d√©cimal ou m√™me d√©nominateur.";
                } 
                else if (world == 18) { 
                    let den = [3, 4, 5][rand(0, 2)];
                    let num = rand(2, den - 1);
                    let target = rand(2, 6) * den;
                    ans = (target / den) * num;
                    op = `${target} √ó ${num}/${den}`;
                    instr = "Calcule :"; 
                    hint = `Divise par ${den} puis multiplie par ${num}.`; 
                } 
                else if (world == 19) { 
                    let fracs = [{t: "1/2", v: 0.5}, {t: "1/4", v: 0.25}, {t: "1/5", v: 0.2}, {t: "2/5", v: 0.4}, {t: "1/10", v: 0.1}, {t: "3/10", v: 0.3}];
                    let f = fracs[rand(0, fracs.length - 1)];
                    ans = parseFloat((f.v * f.v).toFixed(4)); 
                    op = `(${f.t})¬≤`;
                    instr = "Au carr√© :";
                    hint = `${f.v} x ${f.v}`;
                } 
                else if (world == 20) { 
                    let ent = rand(2, 6) * 2;
                    ans = ent + ent/2;
                    op = `${ent} √ó (1 + 1/2)`;
                    instr = "Calcule :"; 
                    hint = "Une fois et demie le nombre."; 
                }
                // --- MONDES 21 √† 25 : EXPERT (MENTAL PUR) ---
                else if (world == 21) { 
                    let den = [10, 20, 40, 50, 100][rand(0, 4)];
                    ans = 2 / den;
                    op = `1/${den} + 1/${den}`;
                    instr = "Additionne :"; 
                    hint = `2/${den} -> simplifie.`; 
                } 
                else if (world == 22) { 
                    let n = rand(1, 3);
                    ans = n * 0.125 + 0.5;
                    op = `${n}/8 + 1/2`;
                    instr = "3 d√©cimales :"; 
                    hint = "1/8 = 0.125"; 
                } 
                else if (world == 23) { 
                    let f1_den = [2, 3, 4][rand(0, 2)];
                    let f2_den = [2, 4, 5][rand(0, 2)];
                    let multiplier = rand(1, 5);
                    let start = f1_den * f2_den * multiplier * 10; 
                    ans = start / (f1_den * f2_den);
                    op = `1/${f1_den} de 1/${f2_den} de ${start}`;
                    instr = "Calcule :";
                    hint = "Fais-le de droite √† gauche.";
                } 
                else if (world == 24) { 
                    let xChoices = [2, 4, 5, 10, 20, 100];
                    let x = xChoices[rand(0, 5)];
                    let displayedRes = 1 - (1/x);
                    displayedRes = parseFloat(displayedRes.toFixed(2));
                    ans = x;
                    op = `1 - 1/x = ${displayedRes}`;
                    instr = "Trouve x :";
                    hint = `1/x vaut ${parseFloat((1-displayedRes).toFixed(2))}.`;
                } 
                else if (world == 25) { 
                    let combos = [{op: "1/2 + 1/4 + 1/8", ans: 0.875}, {op: "1/2 + 1/5 + 1/10", ans: 0.8}, {op: "1/4 + 1/4 + 1/2", ans: 1}, {op: "1/2 + 1/4 + 1/20", ans: 0.8}, {op: "1/5 + 3/5 + 1/10", ans: 0.9}];
                    let c = combos[rand(0, combos.length - 1)];
                    ans = c.ans;
                    op = c.op;
                    instr = "CALCUL ULTIME :";
                    hint = "Additionne les valeurs d√©cimales.";
                }
                else {
                    let c13_n = rand(5, 20);
                    ans = parseFloat((1 / c13_n).toFixed(3));
                    op = `1/2 √ó 2/3 √ó ... √ó ${c13_n-1}/${c13_n}`;
                    instr = "Produit T√©lescopique (d√©cimal) :";
                    hint = `Tout se simplifie en diagonale. Il reste 1/${c13_n}.`;
                }
                break;

            case 14: // DIVISION COMPLEXE
                // --- MONDES 1 √† 5 : BASES (INVERSES SIMPLES) ---
                if (world == 1) { 
                    n1 = rand(2, 25);
                    ans = n1 * 10;
                    op = `${n1} √∑ 0.1`;
                    instr = "Divise :"; 
                    hint = "Diviser par un dixi√®me = Multiplier par 10."; 
                } 
                else if (world == 2) { 
                    n1 = rand(2, 12) * 2; 
                    ans = n1 * 2;
                    op = `${n1} √∑ 0.5`;
                    instr = "Divise :"; 
                    hint = "Combien de moiti√©s ? (x2)."; 
                } 
                else if (world == 3) { 
                    ans = rand(3, 15); 
                    n1 = parseFloat((ans / 2).toFixed(1)); 
                    op = `${n1} √∑ 0.5`;
                    instr = "Divise :"; 
                    hint = "Double le nombre."; 
                } 
                else if (world == 4) { 
                    n1 = rand(1, 15);
                    ans = n1 * 100;
                    op = `${n1} √∑ 0.01`;
                    instr = "Divise :"; 
                    hint = "Diviser par un centi√®me = Multiplier par 100."; 
                } 
                else if (world == 5) { 
                    n1 = rand(1, 10);
                    ans = n1 * 4;
                    op = `${n1} √∑ 0.25`;
                    instr = "Combien de quarts ?"; 
                    hint = "Diviser par 0.25 revient √† multiplier par 4."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (ASTUCES DE D√âCALAGE) ---
                else if (world == 6) { 
                    n1 = rand(6, 45);
                    ans = parseFloat((n1 * 2 / 10).toFixed(1));
                    op = `${n1} √∑ 5`;
                    instr = "Astuce :"; 
                    hint = "Double le nombre et divise par 10."; 
                } 
                else if (world == 7) { 
                    n1 = rand(11, 88) * 10;
                    ans = n1 / 50;
                    op = `${n1} √∑ 50`;
                    instr = "Astuce 50 :"; 
                    hint = "Coupe les z√©ros, divise par 5."; 
                } 
                else if (world == 8) { 
                    n1 = rand(2, 12);
                    ans = n1 * 5;
                    op = `${n1} √∑ 0.2`;
                    instr = "Combien de 0.2 ?"; 
                    hint = "Diviser par 0.2 revient √† multiplier par 5."; 
                } 
                else if (world == 9) { 
                    ans = rand(3, 15);
                    n1 = parseFloat((ans * 0.2).toFixed(1));
                    op = `${n1} √∑ 0.2`;
                    instr = "D√©cimal :"; 
                    hint = "Ignore les virgules (x10 des deux c√¥t√©s)."; 
                } 
                else if (world == 10) { 
                    ans = rand(2, 12);
                    n1 = ans * 500;
                    op = `${n1} √∑ 500`;
                    instr = "Gros paquets :"; 
                    hint = "Coupe deux z√©ros, divise par 5."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (D√âCIMAUX RELATIFS) ---
                else if (world == 11) { 
                    let table = rand(2, 9); 
                    let mult = rand(2, 9); 
                    let div = table / 10; 
                    n1 = parseFloat((div * mult).toFixed(1)); 
                    ans = mult;
                    op = `${n1} √∑ ${div}`;
                    instr = "Simplifie :"; 
                    hint = "Multiplie tout par 10 (ex: 6 √∑ 3)."; 
                } 
                else if (world == 12) { 
                    ans = rand(2, 9) * 5; 
                    n1 = (ans * 4) / 10;
                    op = `${n1} √∑ 0.4`;
                    instr = "Divise :"; 
                    hint = "Pense 20 √∑ 4."; 
                } 
                else if (world == 13) { 
                    let list = [{d:0.5, r:2}, {d:0.2, r:5}, {d:0.1, r:10}, {d:0.25, r:4}];
                    let item = list[rand(0, 3)];
                    n1 = 1;
                    ans = item.r;
                    op = `1 √∑ ${item.d}`;
                    instr = "L'inverse :"; 
                    hint = "Combien de fois √ßa rentre dans 1 ?"; 
                } 
                else if (world == 14) { 
                    let d = rand(2, 5) * 2;
                    n1 = d / 2;
                    ans = 0.5;
                    op = `${n1} √∑ ${d}`;
                    instr = "Fraction :"; 
                    hint = "Le premier est la moiti√© du second."; 
                } 
                else if (world == 15) { 
                    n1 = -rand(2, 10);
                    ans = n1 * 2;
                    op = `${n1} √∑ 0.5`;
                    instr = "Signe :"; 
                    hint = "Le r√©sultat reste n√©gatif. x2."; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (MAGNITUDE ET PI√àGES) ---
                else if (world == 16) { 
                    let digit = rand(1, 9);
                    let gap = rand(1, 2); 
                    let denom = digit / Math.pow(10, gap + 1); 
                    let num = digit / 10; 
                    num = parseFloat(num.toFixed(1));
                    denom = parseFloat(denom.toFixed(gap + 1));
                    ans = Math.pow(10, gap);
                    op = `${num} √∑ ${denom}`;
                    instr = "√âchelle :"; 
                    hint = "M√™me chiffre, juste un d√©calage de virgule."; 
                } 
                else if (world == 17) { 
                    let digit = rand(1, 9);
                    let gap = rand(1, 2);
                    let num = digit / Math.pow(10, gap + 1); 
                    let denom = digit / 10; 
                    num = parseFloat(num.toFixed(gap + 1));
                    denom = parseFloat(denom.toFixed(1));
                    ans = parseFloat((1 / Math.pow(10, gap)).toFixed(gap));
                    op = `${num} √∑ ${denom}`;
                    instr = "Fraction :"; 
                    hint = "Le premier est plus petit. (0.1 ou 0.01)"; 
                } 
                else if (world == 18) { 
                    ans = rand(2, 8);
                    n1 = parseFloat((ans * 2.5).toFixed(1));
                    op = `${n1} √∑ 2.5`;
                    instr = "Combien de 2.5 ?"; 
                    hint = "Double tout : " + (n1*2) + " √∑ 5."; 
                } 
                else if (world == 19) { 
                    ans = rand(2, 6);
                    n1 = parseFloat((ans * 1.5).toFixed(1));
                    op = `${n1} √∑ 1.5`;
                    instr = "Une fois et demie :"; 
                    hint = "Double tout : " + (n1*2) + " √∑ 3."; 
                } 
                else if (world == 20) { 
                    let scenarios = [
                        {n: 0.5, d: 2, a: 0.25}, {n: 0.25, d: 2, a: 0.125},
                        {n: 0.8, d: 4, a: 0.2}, {n: 0.6, d: 2, a: 0.3},
                        {n: 0.6, d: 3, a: 0.2}, {n: 0.9, d: 3, a: 0.3},
                        {n: 0.4, d: 2, a: 0.2}, {n: 0.5, d: 4, a: 0.125}
                    ];
                    let s = scenarios[rand(0, scenarios.length - 1)];
                    n1 = s.n;
                    let div = s.d;
                    ans = s.a;
                    op = `${n1} √∑ ${div}`;
                    instr = "Coupe :"; 
                    hint = "Divise le chiffre, garde la virgule."; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (MENTAL PUR) ---
                else if (world == 21) { 
                    n1 = rand(1, 5);
                    ans = n1 * 8;
                    op = `${n1} √∑ 0.125`;
                    instr = "Le huiti√®me :"; 
                    hint = "Diviser par 1/8 revient √† multiplier par 8."; 
                } 
                else if (world == 22) { 
                    let v = rand(1, 49); 
                    n1 = v / 100; 
                    ans = parseFloat((n1 * 2).toFixed(2));
                    op = `${n1} √∑ 0.5`;
                    instr = "Divise par un demi :";
                    hint = "Cela revient √† doubler le nombre (x2).";
                } 
                else if (world == 23) { 
                    n1 = rand(1, 9)/10;
                    ans = 1;
                    op = `${n1} √∑ ${n1}`;
                    instr = "R√©flexe :"; 
                    hint = "Un nombre divis√© par lui-m√™me."; 
                } 
                else if (world == 24) { 
                    let num = rand(1, 5);
                    let type = rand(0, 2); 
                    if (type === 0) { ans = num * 1000; op = `${num} √∑ 0.001`; } 
                    else if (type === 1) { ans = num * 10000; op = `${num} √∑ 0.0001`; } 
                    else { ans = (num / 2) * 1000; op = `${num} √∑ 0.002`; }
                    instr = "Gros r√©sultat :"; 
                    hint = "L'inverse des milli√®mes est 1000."; 
                } 
                else if (world == 25) { 
                    let list = [{n: 0.75, d: 0.25, r: 3}, {n: 1.25, d: 0.25, r: 5}, {n: 1.5, d: 0.75, r: 2}, {n: 0.12, d: 0.04, r: 3}];
                    let item = list[rand(0, 3)];
                    n1 = item.n;
                    ans = item.r;
                    op = `${n1} √∑ ${item.d}`;
                    instr = "RAPPORT :";
                    hint = "Pense en fractions (ex: 3 quarts divis√© par 1 quart).";
                }
                else {
                    let c14_div = [0.001, 0.002, 0.005, 0.0001][rand(0, 3)];
                    let c14_num = rand(1, 5);
                    ans = c14_num / c14_div;
                    op = `${c14_num} √∑ ${c14_div}`;
                    instr = "Fission nucl√©aire :";
                    hint = `L'inverse de ${c14_div} est grand.`;
                }
                break;
case 15: // POURCENTAGES
                // --- MONDES 1 √† 5 : BASES (50%, 100%, 0%) ---
                if (world == 1) { 
                    let n1 = rand(1, 15) * 2;
                    ans = n1 / 2;
                    op = `50% de ${n1}`;
                    instr = "La moiti√© :";
                    hint = "50% = 1/2.";
                } 
                else if (world == 2) { 
                    let n1 = rand(10, 200);
                    ans = n1;
                    op = `100% de ${n1}`;
                    instr = "Le tout :";
                    hint = "√áa ne change rien.";
                } 
                else if (world == 3) { 
                    let n1 = rand(2, 20) * 10;
                    ans = n1 / 10;
                    op = `10% de ${n1}`;
                    instr = "Le dixi√®me :";
                    hint = "Enl√®ve un z√©ro.";
                } 
                else if (world == 4) { 
                    let n1 = rand(5, 500);
                    ans = 0;
                    op = `0% de ${n1}`;
                    instr = "Rien du tout :";
                    hint = "C'est nul.";
                } 
                else if (world == 5) { 
                    let n1 = rand(2, 12);
                    ans = n1 * 2;
                    op = `200% de ${n1}`;
                    instr = "Le double :";
                    hint = "Deux fois le tout.";
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (QUARTS ET DIXI√àMES) ---
                else if (world == 6) { 
                    let ans_val = rand(2, 10);
                    let n1 = ans_val * 4;
                    ans = ans_val;
                    op = `25% de ${n1}`;
                    instr = "Le quart :";
                    hint = "Moiti√© de la moiti√©.";
                } 
                else if (world == 7) { 
                    let n1 = rand(11, 99);
                    ans = n1 / 10;
                    op = `10% de ${n1}`;
                    instr = "D√©cale la virgule :";
                    hint = "Divise par 10.";
                } 
                else if (world == 8) { 
                    let n1 = rand(2, 9) * 10;
                    ans = (n1 / 10) * 2;
                    op = `20% de ${n1}`;
                    instr = "Le cinqui√®me :";
                    hint = "10% x 2.";
                } 
                else if (world == 9) { 
                    let n1 = rand(2, 12) * 10; 
                    ans = (n1 / 10) / 2;
                    op = `5% de ${n1}`;
                    instr = "Petit pourcentage :";
                    hint = "Calcule 10% et prends la moiti√©.";
                } 
                else if (world == 10) { 
                    let q = rand(1, 5);
                    let n1 = q * 4;
                    ans = q * 3;
                    op = `75% de ${n1}`;
                    instr = "Trois quarts :";
                    hint = "25% x 3.";
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (1% ET ASTUCES) ---
                else if (world == 11) { 
                    let n1 = rand(2, 35) * 100;
                    ans = n1 / 100;
                    op = `1% de ${n1}`;
                    instr = "Centi√®me :";
                    hint = "Enl√®ve deux z√©ros.";
                } 
                else if (world == 12) { 
                    let n1 = rand(12, 98) * 10;
                    ans = n1 / 100;
                    op = `1% de ${n1}`;
                    instr = "Divise par 100 :";
                    hint = "D√©cale la virgule de 2 rangs.";
                } 
                else if (world == 13) { 
                    let n1 = rand(2, 12) * 2; 
                    ans = n1 * 1.5;
                    op = `150% de ${n1}`;
                    instr = "Une fois et demie :";
                    hint = "Le nombre + sa moiti√©.";
                } 
                else if (world == 14) { 
                    let k = rand(3, 9);
                    let n1 = rand(2, 10);
                    ans = n1 * k;
                    op = `${k}00% de ${n1}`;
                    instr = "Multiplie :";
                    hint = `C'est x${k}.`;
                } 
                else if (world == 15) { 
                    let res = rand(5, 20);
                    ans = res * 2;
                    n1 = res;
                    op = `50% de ? = ${n1}`;
                    instr = "Retrouve le total :";
                    hint = "Si la moiti√© vaut √ßa, le tout vaut le double.";
                }
                // --- MONDES 16 √† 20 : LYC√âE (ASTUCES COMMERCIALES) ---
                else if (world == 16) { 
                    let r = rand(1, 5);
                    let n1 = r * 8;
                    ans = r;
                    op = `12.5% de ${n1}`;
                    instr = "Le huiti√®me :";
                    hint = "1/8 de 100% = 12.5%. Divise par 8.";
                } 
                else if (world == 17) { 
                    let n1 = rand(2, 9) * 10; 
                    let add = n1 / 10; 
                    ans = n1 + add;
                    op = `${n1} + 10%`;
                    instr = "Augmentation :";
                    hint = `Ajoute ${add} au montant.`;
                } 
                else if (world == 18) { 
                    let n1 = rand(2, 9) * 10;
                    let rem = (n1 * 20) / 100; 
                    ans = n1 - rem;
                    op = `${n1} - 20%`;
                    instr = "Prix sold√© :";
                    hint = `Enl√®ve un cinqui√®me (${rem}).`;
                } 
                else if (world == 19) { 
                    let a = rand(3, 9);
                    let n1 = 25;
                    let p = a * 4; 
                    ans = (p * 25) / 100;
                    op = `${p}% de 25`;
                    instr = "Astuce sym√©trie :";
                    hint = "Calcule 25% de " + p + " (le quart).";
                } 
                else if (world == 20) { 
                    let n1 = rand(2, 9) * 200; 
                    ans = n1 / 200;
                    op = `0.5% de ${n1}`;
                    instr = "Tout petit :";
                    hint = "Divise par 100, puis par 2.";
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (MENTAL PUR) ---
                else if (world == 21) { 
                    let ht = rand(10, 80);
                    if (ht % 5 !== 0) ht = Math.ceil(ht/5)*5;
                    let tva = ht / 5;
                    ans = ht + tva;
                    op = `${ht} + 20%`;
                    instr = "Ajoute la TVA :";
                    hint = "Divise par 5 et ajoute.";
                } 
                else if (world == 22) { 
                    let res = rand(15, 95) / 10; 
                    ans = Math.round(res * 10);
                    n1 = res;
                    op = `10% de ? = ${n1}`;
                    instr = "Retrouve le total :";
                    hint = "Multiplie par 10.";
                } 
                else if (world == 23) { 
                    let n1 = rand(1, 9) * 30; 
                    ans = n1 / 3;
                    op = `33.33% de ${n1}`;
                    instr = "Le Tiers :";
                    hint = "Divise par 3.";
                } 
                else if (world == 24) { 
                    let capital = rand(1, 5) * 100; 
                    ans = capital * 1.21;
                    op = `${capital}‚Ç¨ + 10% sur 2 ans`;
                    instr = "Int√©r√™ts compos√©s :";
                    hint = "+10% la 1√®re ann√©e, puis +10% sur le nouveau total.";
                } 
                else if (world == 25) { 
                    let n = rand(2, 9) * 100;
                    ans = n * 0.1;
                    op = `50% de 20% de ${n}`;
                    instr = "CHA√éNE :";
                    hint = "50% de 20% font 10% au total.";
                }
                else {
                    let c15_start = rand(1, 5) * 100;
                    ans = c15_start * 1.44;
                    op = `${c15_start}‚Ç¨ +20% puis encore +20%`;
                    instr = "Taxe sur taxe :";
                    hint = "12 x 12 = 144. C'est x1.44 au total.";
                }
                break;

            case 16: // PRIORIT√âS OP√âRATOIRES
                // --- MONDES 1 √† 5 : BASES (MULTIPLICATION GAGNE) ---
                if (world == 1) { 
                    let a = rand(2, 9);
                    let b = rand(2, 6);
                    let c = rand(2, 9);
                    ans = a + (b * c);
                    op = `${a} + ${b} √ó ${c}`;
                    instr = "Priorit√© :"; 
                    hint = "La multiplication passe avant l'addition."; 
                } 
                else if (world == 2) { 
                    let a = rand(2, 9);
                    let b = rand(2, 9);
                    let c = rand(2, 10);
                    ans = (a * b) - c;
                    op = `${a} √ó ${b} - ${c}`;
                    instr = "Calcule :"; 
                    hint = "Multiplie d'abord."; 
                } 
                else if (world == 3) { 
                    let b = rand(2, 5);
                    let c = rand(2, 5);
                    let mult = b * c;
                    let a = mult + rand(1, 10); 
                    ans = a - mult;
                    op = `${a} - ${b} √ó ${c}`;
                    instr = "Attention :"; 
                    hint = "Ne fais pas la soustraction en premier !"; 
                } 
                else if (world == 4) { 
                    let a = rand(2, 5);
                    let b = rand(2, 5);
                    ans = (a * a) + (b * b);
                    op = `${a}¬≤ + ${b}¬≤`;
                    instr = "Priorit√© :"; 
                    hint = "Les puissances, puis l'addition."; 
                } 
                else if (world == 5) { 
                    let a = rand(3, 15);
                    ans = a;
                    op = `${a} + ${a} √ó 0`;
                    instr = "Pi√®ge classique :"; 
                    hint = "La multiplication par 0 annule le second terme."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (PARENTH√àSES) ---
                else if (world == 6) { 
                    let a = rand(2, 9);
                    let b = rand(2, 9);
                    let c = rand(2, 5);
                    ans = (a + b) * c;
                    op = `(${a} + ${b}) √ó ${c}`;
                    instr = "Parenth√®se :"; 
                    hint = "Calcule l'int√©rieur de la parenth√®se d'abord."; 
                } 
                else if (world == 7) { 
                    let c = rand(2, 9);
                    let a = rand(5, 12);
                    let b = rand(1, a - 1);
                    ans = c * (a - b);
                    op = `${c} √ó (${a} - ${b})`;
                    instr = "Calcule :"; 
                    hint = "La parenth√®se est prioritaire."; 
                } 
                else if (world == 8) { 
                    let a1 = rand(1, 5), a2 = rand(1, 5);
                    let b1 = rand(5, 9), b2 = rand(1, 4);
                    ans = (a1 + a2) * (b1 - b2);
                    op = `(${a1}+${a2}) √ó (${b1}-${b2})`;
                    instr = "Blocs :"; 
                    hint = "Calcule chaque bloc s√©par√©ment."; 
                } 
                else if (world == 9) { 
                    let sum = rand(2, 10);
                    let n1 = sum * rand(2, 9);
                    let a = rand(1, sum - 1);
                    let b = sum - a;
                    ans = n1 / sum;
                    op = `${n1} √∑ (${a} + ${b})`;
                    instr = "Divise le tout :"; 
                    hint = "Additionne le diviseur d'abord."; 
                } 
                else if (world == 10) { 
                    let a = rand(1, 4);
                    let b = rand(1, 4);
                    let sum = a + b;
                    ans = sum * sum;
                    op = `(${a} + ${b})¬≤`;
                    instr = "Calcule :"; 
                    hint = "Additionne, puis mets au carr√©."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (DIVISION & GAUCHE-DROITE) ---
                else if (world == 11) { 
                    let a = rand(2, 20);
                    let b = rand(2, 10) * 2; 
                    ans = a + (b / 2);
                    op = `${a} + ${b} √∑ 2`;
                    instr = "Priorit√© :"; 
                    hint = "La division gagne sur l'addition."; 
                } 
                else if (world == 12) { 
                    let b = rand(2, 8);
                    let div = rand(2, 5);
                    let num = b * div;
                    let a = b + rand(5, 15);
                    ans = a - (num / div);
                    op = `${a} - ${num} √∑ ${div}`;
                    instr = "Calcule :"; 
                    hint = "Divise d'abord."; 
                } 
                else if (world == 13) { 
                    let a = rand(2, 6);
                    let b = rand(2, 6);
                    let mult = a * b;
                    if (mult % 2 !== 0) { a = 2; mult = a*b; } 
                    ans = mult / 2;
                    op = `${a} √ó ${b} √∑ 2`;
                    instr = "Sens de lecture :"; 
                    hint = "De gauche √† droite."; 
                } 
                else if (world == 14) { 
                    let a = rand(2, 6) * 4 * 2; 
                    ans = (a / 4) / 2;
                    op = `${a} √∑ 4 √∑ 2`;
                    instr = "Attention au sens :"; 
                    hint = `Fais ${a}√∑4 d'abord.`; 
                } 
                else if (world == 15) { 
                    let a = rand(2, 5) * 2;
                    let b = rand(2, 5);
                    let c = rand(2, 5);
                    ans = (a / 2) + (b * c);
                    op = `${a} √∑ 2 + ${b} √ó ${c}`;
                    instr = "Deux blocs :"; 
                    hint = "Divise √† gauche, multiplie √† droite, puis additionne."; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (FACTORISATION & D√âCIMAUX) ---
                else if (world == 16) { 
                    let k = rand(11, 25);
                    let a = rand(1, 8);
                    let b = 10 - a; 
                    ans = k * 10;
                    op = `${k}√ó${a} + ${k}√ó${b}`;
                    instr = "Astuce :"; 
                    hint = `C'est ${k} fois (${a}+${b}).`; 
                } 
                else if (world == 17) { 
                    let k = rand(12, 19);
                    let a = rand(12, 15);
                    let b = a - 10; 
                    ans = k * 10;
                    op = `${k}√ó${a} - ${k}√ó${b}`;
                    instr = "Factorise :"; 
                    hint = `C'est ${k} fois (${a}-${b}).`; 
                } 
                else if (world == 18) { 
                    let a = rand(2, 10);
                    let b = rand(2, 10) * 2;
                    ans = a + (b * 0.5);
                    op = `${a} + ${b} √ó 0.5`;
                    instr = "Priorit√© :"; 
                    hint = "La multiplication par 0.5 (moiti√©) passe avant."; 
                } 
                else if (world == 19) { 
                    let a = rand(2, 9);
                    let b = rand(1, 5);
                    ans = a + (b * 10);
                    op = `${a} + ${b} √∑ 0.1`;
                    instr = "Calcule :"; 
                    hint = "Diviser par 0.1 = x10. C'est prioritaire."; 
                } 
                else if (world == 20) { 
                    let a = rand(2, 8);
                    let b = rand(3, 5);
                    let c = rand(3, 5);
                    ans = a - (b * c);
                    op = `${a} - ${b} √ó ${c}`;
                    instr = "Signe :"; 
                    hint = "La soustraction vient √† la fin."; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (PI√àGES COMPLEXES) ---
                else if (world == 21) { 
                    let a = rand(2, 5) * 2; 
                    let sum = rand(2, 4); 
                    let b = rand(1, sum - 1);
                    let c = sum - b;
                    ans = (a / 2) * sum;
                    op = `${a} √∑ 2 √ó (${b} + ${c})`;
                    instr = "Gauche √† droite !"; 
                    hint = "Division et Mult sont √©gaux : on lit de gauche √† droite."; 
                } 
                else if (world == 22) { 
                    let a = rand(15, 30);
                    let b = rand(2, 5);
                    ans = a - (b * b);
                    op = `${a} - ${b}¬≤`;
                    instr = "Carr√© prioritaire :"; 
                    hint = "Calcule le carr√© avant de soustraire."; 
                } 
                else if (world == 23) { 
                    let d1 = 2, d2 = 5;
                    ans = 10;
                    op = `100 √∑ (${d1} √ó ${d2})`;
                    instr = "D√©nominateur :"; 
                    hint = "Calcule le produit dans la parenth√®se d'abord."; 
                } 
                else if (world == 24) { 
                    let a = rand(2, 10);
                    let b = rand(2, 5);
                    let c = rand(2, 5);
                    ans = a + (b * c); 
                    op = `${a} - ${b} √ó (-${c})`;
                    instr = "Attention aux signes :"; 
                    hint = "Moins par Moins donne Plus."; 
                } 
                else if (world == 25) { 
                    let sq = rand(2, 4);
                    let square = sq * sq;
                    let mult = 2;
                    let start = square * mult;
                    let add = rand(1, 9);
                    ans = add;
                    op = `${start} - ${sq}¬≤ √ó ${mult} + ${add}`;
                    instr = "CHA√éNE ROYALE :";
                    hint = "Puissance > Mult > Addition/Soustraction (Gauche Droite).";
                }
                else {
                    // BOSS FINAL : Chaos Prioritaire
                    // Structure : A - B * 0.5 + C / 0.1
                    // Le pi√®ge est de faire les additions/soustractions avant.
                    // Rappel : *0.5 = /2   et   /0.1 = *10
                    
                    let start = rand(5, 15) * 10; // Ex: 100
                    let even = rand(4, 12) * 2;   // Ex: 12 (Pair pour diviser par 2)
                    let small = rand(2, 9);       // Ex: 3
                    
                    // Calcul : start - (even/2) + (small*10)
                    ans = start - (even * 0.5) + (small * 10);
                    
                    op = `${start} - ${even} √ó 0.5 + ${small} √∑ 0.1`;
                    
                    instr = "Chaos Prioritaire :";
                    hint = "√ó0.5 (Moiti√©) et √∑0.1 (x10) sont prioritaires.";
                }
                break;

            case 17: // R√àGLE DE 3 (PROPORTIONNALIT√â)
                // --- MONDES 1 √† 5 : BASES (LIN√âARIT√â) ---
                if (world == 1) { 
                    let unit = rand(2, 12);
                    n1 = 2;
                    ans = unit * 2;
                    op = `1 objet = ${unit}‚Ç¨, 2 objets = ?`;
                    instr = "Prix total :"; 
                    hint = "C'est le double."; 
                } 
                else if (world == 2) { 
                    let unit = rand(2, 9);
                    n1 = 3;
                    ans = unit * 3;
                    op = `1 objet = ${unit}‚Ç¨, 3 objets = ?`;
                    instr = "Prix total :"; 
                    hint = "C'est le triple."; 
                } 
                else if (world == 3) { 
                    let unit = rand(1, 9) + (rand(0, 1) ? 0.5 : 0);
                    ans = unit * 10;
                    op = `1 kg = ${unit}‚Ç¨, 10 kg = ?`;
                    instr = "Prix total :"; 
                    hint = "Multiplie par 10."; 
                } 
                else if (world == 4) { 
                    let total = rand(2, 12) * 2; 
                    let unit = total / 2;
                    ans = unit;
                    op = `2 objets = ${total}‚Ç¨, 1 objet = ?`;
                    instr = "Prix unitaire :"; 
                    hint = "La moiti√©."; 
                } 
                else if (world == 5) { 
                    let unit = rand(2, 9);
                    let total = unit * 3;
                    ans = unit;
                    op = `3 lots = ${total}‚Ç¨, 1 lot = ?`;
                    instr = "Prix unitaire :"; 
                    hint = "Divise par 3."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (PASSAGE PAR L'UNIT√â) ---
                else if (world == 6) { 
                    let unit = rand(2, 9);
                    let start = 2;
                    let val = unit * start;
                    let target = 3;
                    ans = unit * target;
                    op = `${start}kg = ${val}‚Ç¨, ${target}kg = ?`;
                    instr = "Proportionnalit√© :"; 
                    hint = `Cherche le prix de 1kg (${val}/2) puis multiplie par ${target}.`; 
                } 
                else if (world == 7) { 
                    let base = rand(1, 4) * 100;
                    ans = base / 2;
                    op = `4 pers = ${base}g, 2 pers = ?`;
                    instr = "Quantit√© :"; 
                    hint = "La moiti√© des invit√©s, donc moiti√© farine."; 
                } 
                else if (world == 8) { 
                    let speed = rand(4, 11) * 10;
                    let h = rand(2, 5);
                    ans = speed * h;
                    op = `1h = ${speed} km, ${h}h = ?`;
                    instr = "Distance :"; 
                    hint = "On multiplie la distance par le temps."; 
                } 
                else if (world == 9) { 
                    let unit = rand(2, 6);
                    let qty = 5;
                    let price = unit * qty;
                    ans = unit;
                    op = `${qty}kg = ${price}‚Ç¨, 1kg = ?`;
                    instr = "Prix au kilo :"; 
                    hint = "Divise le prix par le poids."; 
                } 
                else if (world == 10) { 
                    let p = rand(1, 9) * 10;
                    ans = p / 10;
                    op = `10 m = ${p}‚Ç¨, 1 m = ?`;
                    instr = "Prix au m√®tre :"; 
                    hint = "Divise par 10."; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (TEMPS & √âCHELLES) ---
                else if (world == 11) { 
                    let speed = rand(4, 12) * 10;
                    ans = speed / 2;
                    op = `1h = ${speed} km, 30 min = ?`;
                    instr = "Distance :"; 
                    hint = "30 min, c'est la moiti√© d'une heure."; 
                } 
                else if (world == 12) { 
                    let speed = rand(2, 8) * 4; 
                    ans = speed / 4;
                    op = `1h = ${speed} km, 15 min = ?`;
                    instr = "Distance :"; 
                    hint = "15 min, c'est un quart d'heure."; 
                } 
                else if (world == 13) { 
                    let scale = rand(1, 5) * 100;
                    let dist = rand(2, 5);
                    ans = scale * dist;
                    op = `1 cm = ${scale} m, ${dist} cm = ?`;
                    instr = "Distance r√©elle :"; 
                    hint = "Multiplie par l'√©chelle."; 
                } 
                else if (world == 14) { 
                    let a = rand(2, 5);
                    let b = rand(2, 6);
                    let k = rand(2, 5);
                    let c = a * k;
                    ans = b * k;
                    op = `${a}/${b} = ${c} / ?`;
                    instr = "Compl√®te :"; 
                    hint = `De ${a} √† ${c}, on fait x${k}. Fais pareil en bas.`; 
                } 
                else if (world == 15) { 
                    let val = rand(2, 8) * 2;
                    ans = val / 2;
                    op = `1 part = ${val}, 0.5 part = ?`;
                    instr = "Calcule :"; 
                    hint = "0.5, c'est la moiti√©."; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (ADDITIVIT√â & POURCENTAGES) ---
                else if (world == 16) { 
                    let k = rand(2, 6);
                    let v2 = 2 * k;
                    let v3 = 3 * k;
                    ans = v2 + v3;
                    op = `2kg=${v2}‚Ç¨, 3kg=${v3}‚Ç¨, 5kg=?`;
                    instr = "D√©duis :"; 
                    hint = "2kg + 3kg = 5kg. Additionne les prix."; 
                } 
                else if (world == 17) { 
                    let val = rand(2, 12) * 2; 
                    ans = val * 1.5;
                    op = `1 L = ${val}‚Ç¨, 1.5 L = ?`;
                    instr = "Prix :"; 
                    hint = "Une fois et demie le prix."; 
                } 
                else if (world == 18) { 
                    let rate = 1.2;
                    let amount = rand(2, 9) * 10;
                    ans = amount * rate;
                    op = `1‚Ç¨ = ${rate}$, ${amount}‚Ç¨ = ?`;
                    instr = "Change :"; 
                    hint = "Multiplie par 1.2 (ajoute un cinqui√®me)."; 
                } 
                else if (world == 19) { 
                    let speed = rand(1, 4) * 30; 
                    ans = speed / 3;
                    op = `1h = ${speed} km, 20 min = ?`;
                    instr = "Distance :"; 
                    hint = "20 min, c'est un tiers d'heure."; 
                } 
                else if (world == 20) { 
                    let total = rand(2, 9) * 10;
                    ans = total / 10;
                    op = `100% = ${total}, 10% = ?`;
                    instr = "Calcule :"; 
                    hint = "Divise par 10."; 
                }
                // --- MONDES 21 √† 25 : EXPERT (INVERSE & ABSTRAIT) ---
                else if (world == 21) { 
                    let k = rand(2, 5); 
                    let start = rand(2, 5);
                    let valStart = start * k;
                    let factor = 3;
                    let target = start * factor;
                    ans = valStart * factor;
                    op = `${start}kg = ${valStart}‚Ç¨, ${target}kg = ?`;
                    instr = "D√©duis :"; 
                    hint = `${target}kg, c'est 3 fois plus que ${start}kg.`; 
                } 
                else if (world == 22) { 
                    let unit = rand(2, 8) * 2; 
                    ans = unit * 2.5;
                    op = `1kg = ${unit}‚Ç¨, 2.5kg = ?`;
                    instr = "Prix :"; 
                    hint = "2 fois le prix + la moiti√©."; 
                } 
                else if (world == 23) { 
                    let v1 = 100;
                    let t1 = rand(2, 6); 
                    let v2 = 200; 
                    ans = t1 / 2;
                    op = `${v1}km/h = ${t1}h, ${v2}km/h = ?`;
                    instr = "Dur√©e trajet :"; 
                    hint = "Plus tu vas vite, moins tu mets de temps. (Inverse)"; 
                } 
                else if (world == 24) { 
                    let b = 5;
                    let d = 20; 
                    let a = rand(1, 9);
                    ans = a * 4;
                    op = `${a}/${b} = x/${d}`;
                    instr = "Trouve x :"; 
                    hint = "On passe de 5 √† 20 en faisant x4."; 
                } 
                else if (world == 25) { 
                    let conso = rand(4, 8) * 2;
                    ans = conso * 2.5;
                    op = `100km = ${conso}L, 250km = ?`;
                    instr = "Consommation :";
                    hint = "250km c'est 2 fois 100km plus la moiti√©.";
                }
                else {
                    // BOSS FINAL : R√®gle de 3 Inverse (Gestion du temps)
                    // Ex: 3 agents mettent 2h00. Combien de temps pour 4 agents ?
                    // Calcul : 3 * 120min = 360. 360 / 4 = 90 min.
                    
                    let m1 = rand(3, 6); // Nombre initial d'agents
                    let m2 = rand(2, 8); // Nombre cible
                    if (m1 === m2) m2++;
                    
                    // On g√©n√®re une r√©ponse qui tombe juste (en minutes)
                    let t_final = rand(20, 90); 
                    
                    // Ajustement : on s'assure que (t_final * m2) est divisible par m1
                    // Produit Constant = m2 * t_final = m1 * t_start
                    while ((t_final * m2) % m1 !== 0) {
                        t_final++;
                    }
                    
                    ans = t_final;
                    let total_work = t_final * m2;
                    let t_start = total_work / m1; // Temps initial en minutes
                    
                    // Conversion du temps de d√©part en Heures/Minutes pour corser la lecture
                    let t_str = t_start + " min";
                    if (t_start >= 60) {
                        let h = Math.floor(t_start / 60);
                        let m = t_start % 60;
                        t_str = `${h}h${m < 10 ? '0'+m : m}`;
                    }

                    op = `${m1} agents ‚ûî ${t_str}. ${m2} agents ‚ûî ? min`;
                    instr = "Travail d'√©quipe (Inverse) :";
                    hint = `Convertis en minutes. Produit constant : ${m1} √ó ${t_start} = ${total_work}. Divise par ${m2}.`;
                }
                break;

            case 18: // FINANCES
                // --- MONDES 1 √† 5 : BASES (ARGENT DE POCHE) ---
                if (world == 1) { 
                    let n1 = rand(2, 9) * 10;
                    let tip = n1 / 10;
                    ans = n1 + tip;
                    op = `${n1}‚Ç¨ + 10% (service)`;
                    instr = "Total √† payer :"; 
                    hint = "Ajoute le dixi√®me."; 
                } 
                else if (world == 2) { 
                    let n1 = rand(4, 20) * 2;
                    ans = n1 / 2;
                    op = `${n1}‚Ç¨ √† -50%`;
                    instr = "Prix sold√© :"; 
                    hint = "La moiti√©."; 
                } 
                else if (world == 3) { 
                    let p = rand(5, 15);
                    let q = rand(2, 5);
                    ans = p * q;
                    op = `${q} articles √† ${p}‚Ç¨`;
                    instr = "Total :"; 
                    hint = "Multiplication simple."; 
                } 
                else if (world == 4) { 
                    let n = rand(2, 5);
                    let share = rand(10, 30);
                    let total = share * n;
                    ans = share;
                    op = `${total}‚Ç¨ √† diviser en ${n}`;
                    instr = "Part par personne :"; 
                    hint = "Division simple."; 
                } 
                else if (world == 5) { 
                    let n1 = rand(2, 10) * 4;
                    ans = n1 * 0.75;
                    op = `${n1}‚Ç¨ √† -25%`;
                    instr = "Prix final :"; 
                    hint = "Il reste les 3/4 du prix."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE D√âBUT (SOLDES & TAXES) ---
                else if (world == 6) { 
                    let n1 = rand(2, 9) * 10;
                    let tva = n1 / 5;
                    ans = n1 + tva;
                    op = `${n1}‚Ç¨ HT (TVA 20%)`;
                    instr = "Prix TTC :"; 
                    hint = "Ajoute un cinqui√®me."; 
                } 
                else if (world == 7) { 
                    let n1 = rand(1, 5) * 100;
                    let aug = n1 * 0.05;
                    ans = n1 + aug;
                    op = `${n1}‚Ç¨ + 5%`;
                    instr = "Nouveau prix :"; 
                    hint = "5% c'est la moiti√© de 10%."; 
                } 
                else if (world == 8) { 
                    let n1 = rand(2, 9) * 10;
                    ans = n1 * 0.7;
                    op = `${n1}‚Ç¨ √† -30%`;
                    instr = "Prix sold√© :"; 
                    hint = "Fais x7 (car il reste 70%)."; 
                } 
                else if (world == 9) { 
                    let cap = rand(1, 5) * 1000;
                    let rate = 3; 
                    ans = (cap * rate) / 100;
                    op = `3% de ${cap}‚Ç¨`;
                    instr = "Int√©r√™ts gagn√©s :"; 
                    hint = "3‚Ç¨ pour chaque 100‚Ç¨."; 
                } 
                else if (world == 10) { 
                    let red = rand(0, 1) ? 70 : 80;
                    let n1 = rand(2, 10) * 10;
                    let coef = (100 - red) / 100; 
                    ans = Math.round(n1 * coef);
                    op = `${n1}‚Ç¨ √† -${red}%`;
                    instr = "Prix cass√© :"; 
                    hint = `Il ne reste que ${100-red}% du prix.`; 
                }
                // --- MONDES 11 √† 15 : COLL√àGE FIN (B√âN√âFICES & COEFFS) ---
                else if (world == 11) { 
                    let n1 = rand(2, 9) * 10;
                    ans = n1 * 0.8;
                    op = `${n1}‚Ç¨ √ó 0.8`;
                    instr = "Prix apr√®s rabais :"; 
                    hint = "Cela correspond √† -20%."; 
                } 
                else if (world == 12) { 
                    let n1 = rand(1, 4) * 30; 
                    ans = n1 * (2/3);
                    op = `${n1}‚Ç¨ moins 1/3`;
                    instr = "Prix pay√© :"; 
                    hint = "Il reste 2/3 du prix."; 
                } 
                else if (world == 13) { 
                    let buy = rand(2, 8) * 5;
                    let sell = buy + rand(1, 5) * 5;
                    ans = sell - buy;
                    op = `Achat ${buy}‚Ç¨, Vente ${sell}‚Ç¨`;
                    instr = "B√©n√©fice :"; 
                    hint = "Vente moins Achat."; 
                } 
                else if (world == 14) { 
                    let kg = rand(2, 5);
                    let price = kg * rand(3, 9);
                    ans = price / kg;
                    op = `${kg}kg co√ªtent ${price}‚Ç¨`;
                    instr = "Prix au kg :"; 
                    hint = "Division simple."; 
                } 
                else if (world == 15) { 
                    let solde = rand(3, 9) * 10;
                    let debit = solde + rand(1, 5) * 10;
                    ans = solde - debit;
                    op = `Solde ${solde}‚Ç¨, D√©bit ${debit}‚Ç¨`;
                    instr = "Nouveau solde :"; 
                    hint = "Tu es √† d√©couvert (n√©gatif)."; 
                }
                // --- MONDES 16 √† 20 : LYC√âE (REVERSE & MARCH√âS) ---
                else if (world == 16) { 
                    let finalP = rand(2, 10) * 10;
                    ans = finalP * 2;
                    op = `? - 50% = ${finalP}‚Ç¨`;
                    instr = "Prix initial :"; 
                    hint = "C'√©tait le double."; 
                } 
                else if (world == 17) { 
                    let start = rand(1, 2) * 100; 
                    let p1 = 10;
                    let p2 = rand(1, 3) * 10; 
                    let step1 = start + (start * p1 / 100);
                    ans = step1 + (step1 * p2 / 100);
                    n1 = start;
                    op = `${start}‚Ç¨ +${p1}% puis +${p2}%`;
                    instr = "Prix final :"; 
                    hint = `Calcule ${step1}‚Ç¨, puis ajoute ${p2}%.`; 
                } 
                else if (world == 18) { 
                    let rate = 1.2;
                    let euros = rand(2, 8) * 10;
                    ans = euros * rate;
                    op = `1‚Ç¨ = 1.2$, ${euros}‚Ç¨ = ?`;
                    instr = "En dollars :"; 
                    hint = "Ajoute 20% (un cinqui√®me)."; 
                } 
                else if (world == 19) { 
                    let p = [10, 20, 30, 50][rand(0, 3)];
                    let start = 100; 
                    let multiplier = 1 - Math.pow(p/100, 2);
                    ans = start * multiplier;
                    let sign1 = rand(0, 1) ? "+" : "-";
                    let sign2 = (sign1 === "+") ? "-" : "+";
                    op = `${start}‚Ç¨ ${sign1}${p}% puis ${sign2}${p}%`;
                    instr = "Valeur finale :"; 
                    hint = `Tu perds le carr√© de ${p/10} (soit ${Math.pow(p/10, 2)}‚Ç¨).`; 
                } 
                else if (world == 20) { 
                    let cap = rand(1, 5) * 2000;
                    ans = cap * 0.005;
                    op = `Frais 0.5% sur ${cap}‚Ç¨`;
                    instr = "Montant frais :"; 
                    hint = "1% c'est deux z√©ros en moins. Prends la moiti√©."; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (FINANCE AVANC√âE) ---
                else if (world == 21) { 
                    let ht = rand(1, 8) * 10; 
                    let ttc = ht * 1.2;
                    ans = ht;
                    op = `Prix TTC ${ttc}‚Ç¨ (TVA 20%)`;
                    instr = "Prix HT :"; 
                    hint = "Divise par 1.2 (ou par 6 puis x5)."; 
                } 
                else if (world == 22) { 
                    let cap = rand(1, 3) * 1000;
                    ans = cap * 1.21;
                    op = `${cap}‚Ç¨ √† 10% sur 2 ans`;
                    instr = "Capital final :"; 
                    hint = "Les int√©r√™ts produisent des int√©r√™ts (+21% au total)."; 
                } 
                else if (world == 23) { 
                    let cout = rand(2, 8) * 8; 
                    ans = cout / 0.8;
                    op = `Co√ªt ${cout}‚Ç¨, Marge 20%`;
                    instr = "Prix de vente :"; 
                    hint = "Le co√ªt repr√©sente 80% du prix final. Divise par 0.8."; 
                } 
                else if (world == 24) { 
                    let amount = rand(1, 6) * 1200;
                    ans = amount / 12;
                    op = `Emprunt ${amount}‚Ç¨ sur 1 an`;
                    instr = "Mensualit√© :"; 
                    hint = "Divise par 12."; 
                } 
                else if (world == 25) { 
                    let brut = rand(20, 40) * 100;
                    let charges = (brut * 24) / 100;
                    ans = brut - charges;
                    op = `Brut ${brut}‚Ç¨, Charges 24%`;
                    instr = "Salaire Net :";
                    hint = "Calcule 25% (un quart) et rajoute 1% (le centi√®me).";
                }
                else {
                    let c18_loyer = rand(5, 15) * 100;
                    ans = c18_loyer * 12 * 30;
                    op = `${c18_loyer}‚Ç¨/mois pendant 30 ans`;
                    instr = "Une vie de loyer :";
                    hint = "x12 mois = an. x30 ans = x360 mois.";
                }
                break;

            case 19: // ALG√àBRE
                // --- MONDES 1 √† 5 : BASES (TROUVER L'INCONNUE) ---
                if (world == 1) { 
                    let add = rand(2, 9);
                    ans = rand(2, 9);
                    let res = ans + add;
                    op = `x + ${add} = ${res}`;
                    instr = "Trouve x :"; 
                    hint = "L'inverse de + est -."; 
                } 
                else if (world == 2) { 
                    let sub = rand(2, 9);
                    ans = rand(5, 15);
                    let res = ans - sub;
                    op = `x - ${sub} = ${res}`;
                    instr = "Trouve x :"; 
                    hint = "L'inverse de - est +."; 
                } 
                else if (world == 3) { 
                    let a = rand(2, 9);
                    ans = rand(2, 9);
                    let res = a * ans;
                    op = `${a}x = ${res}`;
                    instr = "Trouve x :"; 
                    hint = "Divise le r√©sultat par le coefficient."; 
                } 
                else if (world == 4) { 
                    let a = rand(2, 5);
                    let res = rand(2, 10);
                    ans = res * a;
                    op = `x / ${a} = ${res}`;
                    instr = "Trouve x :"; 
                    hint = "L'inverse de la division est la multiplication."; 
                } 
                else if (world == 5) { 
                    let start = rand(10, 20);
                    ans = rand(2, 9);
                    let res = start - ans;
                    op = `${start} - x = ${res}`;
                    instr = "Trouve x :"; 
                    hint = "C'est l'√©cart entre les deux nombres."; 
                }
                // --- MONDES 6 √† 10 : COLL√àGE (DEUX √âTAPES & N√âGATIFS) ---
                else if (world == 6) { 
                    let a = rand(2, 5);
                    let b = rand(1, 9);
                    ans = rand(2, 9);
                    let res = a * ans + b;
                    op = `${a}x + ${b} = ${res}`;
                    instr = "Trouve x :"; 
                    hint = "Enl√®ve d'abord l'addition, puis divise."; 
                } 
                else if (world == 7) { 
                    let add = rand(10, 20);
                    let res = rand(1, 5);
                    ans = res - add;
                    op = `x + ${add} = ${res}`;
                    instr = "N√©gatif :"; 
                    hint = "Le nombre cherch√© est n√©gatif."; 
                } 
                else if (world == 8) { 
                    let a = rand(2, 5);
                    ans = -rand(2, 9);
                    let res = -a * ans; 
                    op = `-${a}x = ${res}`;
                    instr = "Signe :"; 
                    hint = "Divise par un nombre n√©gatif."; 
                } 
                else if (world == 9) { 
                    let a = rand(2, 4);
                    let b = rand(1, 3);
                    ans = rand(2, 6);
                    let res = a * (ans + b);
                    op = `${a}(x + ${b}) = ${res}`;
                    instr = "Parenth√®se :"; 
                    hint = "Divise par le nombre devant la parenth√®se d'abord."; 
                } 
                else if (world == 10) { 
                    let target = rand(1, 9); 
                    let coeff = rand(2, 5);
                    ans = target;
                    op = `${coeff}x = ${coeff-1}x + ${ans}`;
                    instr = "Groupe les x :"; 
                    hint = "Passe les x du m√™me c√¥t√©."; 
                }
                // --- MONDES 11 √† 15 : LYC√âE D√âBUT (DECIMAUX, CARR√âS, SYST√àMES) ---
                else if (world == 11) { 
                    ans = rand(4, 20) * 2; 
                    let res = ans / 2;
                    op = `0.5x = ${res}`;
                    instr = "Le demi-x :"; 
                    hint = "Multiplier par 2 annule le 0.5."; 
                } 
                else if (world == 12) { 
                    ans = rand(2, 9) * 10;
                    let res = ans / 10;
                    op = `0.1x = ${res}`;
                    instr = "Le dixi√®me :"; 
                    hint = "Multiplie par 10."; 
                } 
                else if (world == 13) { 
                    ans = rand(2, 12);
                    let res = ans * ans;
                    op = `x¬≤ = ${res}`;
                    instr = "Trouve x positif :"; 
                    hint = "Racine carr√©e."; 
                } 
                else if (world == 14) { 
                    ans = rand(1, 9);
                    let bad = rand(1, 9);
                    op = `(x - ${ans})(x + ${bad}) = 0`;
                    instr = "x positif ?"; 
                    hint = "Un des facteurs doit √™tre nul."; 
                } 
                else if (world == 15) { 
                    ans = rand(2, 9);
                    let y = 2 * ans;
                    op = `y = 2x  et  y = ${y}`;
                    instr = "Trouve x :"; 
                    hint = "Remplace y par sa valeur."; 
                }
                // --- MONDES 16 √† 20 : PREMI√àRE / TERMINALE (FONCTIONS & INVERSES) ---
                else if (world == 16) { 
                    ans = rand(2, 9);
                    let num = ans * rand(2, 5);
                    op = `${num} / x = ${num/ans}`;
                    instr = "Inverse :"; 
                    hint = "√âchange x et le r√©sultat."; 
                } 
                else if (world == 17) { 
                    let r = rand(2, 9);
                    ans = r * r;
                    op = `‚àöx = ${r}`;
                    instr = "Trouve x :"; 
                    hint = "Mets au carr√©."; 
                } 
                else if (world == 18) { 
                    ans = rand(1, 4);
                    let res = Math.pow(10, ans);
                    op = `10^x = ${res}`;
                    instr = "Exposant :"; 
                    hint = "Compte les z√©ros."; 
                } 
                else if (world == 19) { 
                    ans = rand(1, 6); 
                    let res = Math.pow(2, ans);
                    op = `2^x = ${res}`;
                    instr = "En binaire :"; 
                    hint = "Combien de fois x2 ?"; 
                } 
                else if (world == 20) { 
                    ans = rand(1, 5);
                    let b = 2 * ans;
                    let c = ans * ans;
                    op = `x¬≤ - ${b}x + ${c} = 0`;
                    instr = "Racine double :"; 
                    hint = `C'est (x - ${ans})¬≤ = 0.`; 
                }
                // --- MONDES 21 √† 25 : EXPERT / TERMINALE (MENTAL MATH PUR) ---
                else if (world == 21) { 
                    let x = rand(3, 10);
                    let y = rand(1, x-1);
                    let s = x + y;
                    let d = x - y;
                    ans = x;
                    op = `x+y=${s}, x-y=${d}`;
                    instr = "Trouve x :"; 
                    hint = "Additionne les deux √©quations : 2x = ..."; 
                } 
                else if (world == 22) { 
                    ans = rand(2, 12); 
                    let sub = rand(2, 25); 
                    let res = (ans * ans) - sub; 
                    op = `x¬≤ - ${sub} = ${res}`;
                    instr = "Trouve x positif :"; 
                    hint = `Isole x¬≤ (cela fait ${res+sub}), puis trouve la racine.`; 
                } 
                else if (world == 23) { 
                    ans = rand(2, 9); 
                    let c = rand(2, 5); 
                    let a = c + rand(2, 4); 
                    let b = rand(1, 10); 
                    let d = (a * ans) + b - (c * ans);
                    op = `${a}x + ${b} = ${c}x + ${d}`;
                    instr = "Trouve x :";
                    hint = `Groupe les x : ${(a-c)}x = ${d-b}.`;
                } 
                else if (world == 24) { 
                    ans = rand(2, 9);
                    let a = rand(3, 6); 
                    let c = a - 2; 
                    let gap = 2 * ans; 
                    let b = rand(1, 20); 
                    let d = gap - b; 
                    op = `${a}x - ${b} = ${c}x + ${d}`;
                    instr = "R√©sous :"; 
                    hint = "Groupe les x √† gauche, les nombres √† droite."; 
                } 
                else if (world == 25) { 
                    ans = rand(1, 4) * 4;
                    let res = (ans / 2) + (ans / 4);
                    op = `x/2 + x/4 = ${res}`;
                    instr = "√âQUATION TOTALE :";
                    hint = "Pense en d√©cimal (0.5x + 0.25x = 0.75x).";
                }
                else {
                    // BOSS FINAL : Identit√© Remarquable (a¬≤ - b¬≤) Vari√©e
                    // Formule : (a-b) * (a+b)
                    
                    let subtype = rand(0, 2);
                    let val_a, val_b;
                    
                    if (subtype === 0) {
                        // Variante 1 : Somme = 100 (Ex: 53¬≤ - 47¬≤)
                        // Calcul : (Difference) x 100
                        let k = rand(2, 9);
                        val_a = 50 + k;
                        val_b = 50 - k;
                    } 
                    else if (subtype === 1) {
                        // Variante 2 : Diff√©rence = 10 (Ex: 65¬≤ - 55¬≤)
                        // Calcul : 10 x (Somme)
                        let base = rand(2, 8) * 10; // 20 √† 80
                        let unit = rand(1, 9);
                        val_a = base + unit;       // ex: 35
                        val_b = val_a - 10;        // ex: 25
                    } 
                    else {
                        // Variante 3 : Diff√©rence = 2 (Ex: 31¬≤ - 29¬≤)
                        // Calcul : 2 x (Somme qui est un multiple de 10)
                        let center = rand(2, 9) * 10; // 20, 30... 90
                        val_a = center + 1; // ex: 31
                        val_b = center - 1; // ex: 29
                    }

                    ans = (val_a * val_a) - (val_b * val_b);
                    op = `${val_a}¬≤ - ${val_b}¬≤`;
                    instr = "IDENTIT√â ULTIME :";
                    hint = `Calcule (${val_a} - ${val_b}) √ó (${val_a} + ${val_b}).`;
                }
                break;
     














  

// ==============================================
// ‚¨ÜÔ∏è FIN DE LA PARTIE 2 ‚¨ÜÔ∏è
// ==============================================
        }

        // CORRECTION VALIDATION : On accepte 6 d√©cimales pour la pr√©cision du mode God
        if (typeof ans === 'number' && !Number.isInteger(ans)) ans = parseFloat(ans.toFixed(6));
        if(ans === undefined) { ans=10; op="5+5"; instr="Bonus"; hint="Erreur."; }
        if (themeIdx === 11) { format = 'decimal'; instr += " (en d√©cimal)"; }
        return { q: op, a: ans, instr: instr, hint: hint, format: format };
    }

    const WORLDS_CONFIG = [
        { img: "biome1.jpg", name: "Le Quartier des Quarts" }, { img: "biome2.jpg", name: "Le Centre Circulaire" }, { img: "biome3.jpg", name: "L'Autoroute des Angles" }, { img: "biome4.jpg", name: "La Zone des Unit√©s" }, { img: "biome5.jpg", name: "Le Port des Parall√®les" },
        { img: "biome6.jpg", name: "Les Plaines du Plus" }, { img: "biome7.jpg", name: "La For√™t des Fractions" }, { img: "biome8.jpg", name: "La Jungle G√©om√©trique" }, { img: "biome9.jpg", name: "La Savane des Sommes" }, { img: "biome10.jpg", name: "Le Canyon des Carr√©s" },
        { img: "biome11.jpg", name: "Le D√©sert des D√©cimales" }, { img: "biome12.jpg", name: "Le Marais des Moins" }, { img: "biome13.jpg", name: "Le Glacier des Graphiques" }, { img: "biome14.jpg", name: "La Caverne des Cubes" }, { img: "biome15.jpg", name: "Le Volcan des Volumes" },
        { img: "biome16.jpg", name: "Le Pic de Pythagore" }, { img: "biome17.jpg", name: "Le Nuage des Nombres" }, { img: "biome18.jpg", name: "La Cit√© des Cylindres" }, { img: "biome19.jpg", name: "Le Temple de Thal√®s" }, { img: "biome20.jpg", name: "La Stratosph√®re des Sph√®res" },
        { img: "biome21.jpg", name: "La Lune des Losanges" }, { img: "biome22.jpg", name: "Les Anneaux d'Alg√®bre" }, { img: "biome23.jpg", name: "La N√©buleuse N√©gative" }, { img: "biome24.jpg", name: "L'Espace √âquation" }, { img: "biome25.jpg", name: "L'Inconnue X" },
        { img: "biome26.jpg", name: "L'Univers Parall√®le" } 
    ];

    let savedData = localStorage.getItem('mq_2d');
    window.gameState = savedData ? JSON.parse(savedData) : { unlocked: 1, stars: {}, maxWorld: 1, prestige: false };
    if (!window.gameState.maxWorld) { window.gameState.maxWorld = Math.ceil(window.gameState.unlocked / 20); if(window.gameState.maxWorld < 1) window.gameState.maxWorld = 1; }
    if (!window.gameState.settings) window.gameState.settings = { vib: true, creative: false };

    const MAX_LIVES = 5;
    const REGEN_DELAY = 15 * 60 * 1000; 

    if (typeof window.gameState.lives === 'undefined') window.gameState.lives = MAX_LIVES;
    if (typeof window.gameState.lastLifeTime === 'undefined') window.gameState.lastLifeTime = Date.now();

    let currentSession = null; let currentScore = 0; let targetScore = 20; let timerInterval = null; let totalTimeAllowed = 100; let timeLeft = 100;
    function getTotalStars() { return Object.values(window.gameState.stars).reduce((a, b) => a + b, 0); }
    function formatText(txt) { let s = txt.replace(/([0-9x]+)\/([0-9x]+)/g, '<span class="frac"><sup>$1</sup><sub>$2</sub></span>'); let parts = s.split(/(<[^>]*>)/); for (let i = 0; i < parts.length; i++) { if (!parts[i].startsWith('<')) { parts[i] = parts[i].replace(/x/g, '<span class="var-x">x</span>'); } } return parts.join(''); }

    function isWorldFullyCompleted(wIndex) {
        if (wIndex <= 1) return true;
        let prevWorld = wIndex - 1;
        let maxLvl = prevWorld * 20;
        let minLvl = (prevWorld - 1) * 20 + 1;
        for (let i = minLvl; i <= maxLvl; i++) { if (!window.gameState.stars[i] || window.gameState.stars[i] < 1) return false; }
        return true;
    }

    function getStarsRequired(targetWorld) { 
        if (targetWorld === 26) return 0;
        if (targetWorld <= 1) return 0;
        let totalNeeded = 0; 
        for (let w = 1; w < targetWorld; w++) { let difficulty = 33 + (w * 2); if (difficulty > 55) difficulty = 55; totalNeeded += difficulty; } 
        return totalNeeded; 
    }

    function updateLivesSystem() {
        if (window.gameState.prestige) {
            document.getElementById('ui-hearts').innerHTML = "<span class='infinity-lives'>‚àû</span>";
            document.getElementById('ui-life-timer').innerText = "GOD MODE";
            document.getElementById('ui-life-timer').style.color = "#FFD700";
            return;
        }

        let now = Date.now();
        if (window.gameState.lives < MAX_LIVES) {
            let timePassed = now - window.gameState.lastLifeTime;
            if (timePassed >= REGEN_DELAY) {
                let livesGained = Math.floor(timePassed / REGEN_DELAY);
                window.gameState.lives = Math.min(MAX_LIVES, window.gameState.lives + livesGained);
                window.gameState.lastLifeTime = now - (timePassed % REGEN_DELAY);
                localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
            }
        } else { window.gameState.lastLifeTime = now; }

        let hContainer = document.getElementById('ui-hearts');
        let tContainer = document.getElementById('ui-life-timer');
        let heartsHTML = "";
        for(let i=0; i<MAX_LIVES; i++) { 
            if(i < window.gameState.lives) {
                heartsHTML += "‚ù§Ô∏è"; 
            } else {
                heartsHTML += "<span class='heart-lost'>‚ù§Ô∏è</span>"; 
            }
        }
        hContainer.innerHTML = heartsHTML;

        if (window.gameState.lives >= MAX_LIVES) { tContainer.innerText = "MAX"; tContainer.style.color = "#00b894"; } 
        else {
            let timeRemaining = REGEN_DELAY - (now - window.gameState.lastLifeTime);
            let m = Math.floor(timeRemaining / 60000);
            let s = Math.floor((timeRemaining % 60000) / 1000);
            tContainer.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            tContainer.style.color = "#fab1a0";
        }
    }
    setInterval(updateLivesSystem, 1000);

    function showResultModal(type, starsWon, hintText) {
        const modal = document.getElementById('result-modal');
        const title = document.getElementById('res-title');
        const sub = document.getElementById('res-sub');
        const emoji = document.getElementById('res-emoji');
        const btn = document.getElementById('res-btn');
        const hintBox = document.getElementById('res-hint');
        hintBox.innerText = ""; hintBox.classList.remove('show');

        if (type === 'win') {
            title.innerText = "NIVEAU R√âUSSI !"; title.style.color = "#55efc4";
            let starText = "";
            if(starsWon === 3) { emoji.innerText = "ü§©"; starText = "PERFECT ! +3 ‚≠ê"; }
            else if(starsWon === 2) { emoji.innerText = "üòé"; starText = "BIEN JOU√â ! +2 ‚≠ê"; }
            else { emoji.innerText = "üòÖ"; starText = "JUSTE ! +1 ‚≠ê"; if(hintText) { hintBox.innerText = "üí° Conseil : " + hintText; hintBox.classList.add('show'); } }
            sub.innerText = starText; btn.innerText = "CONTINUER"; btn.className = "btn-modal";
            if(window.gameState.settings.vib && navigator.vibrate) navigator.vibrate([100,50,100,50,200]);
        } else {
            title.innerText = "√âCHEC..."; title.style.color = "#ff7675"; emoji.innerText = "üíÄ";
            if(hintText) { hintBox.innerText = "üí° Conseil : " + hintText; hintBox.classList.add('show'); }
            if(window.gameState.prestige) { sub.innerText = "Essaie encore (Vie Infinie)"; btn.innerText = "R√âESSAYER"; }
            else if(window.gameState.lives > 0) { sub.innerText = "Essaie encore ! (-1 ‚ù§Ô∏è)"; btn.innerText = "R√âESSAYER"; } 
            else { sub.innerText = "Plus de vies... Repose-toi."; btn.innerText = "MENU PRINCIPAL"; }
            btn.className = "btn-modal fail";
            if(window.gameState.settings.vib && navigator.vibrate) navigator.vibrate([400]);
        }
        modal.classList.add('active');
    }

    // --- VICTOIRE (ANIMATION) ---
    window.triggerVictorySequence = function() {
        const screen = document.getElementById('victory-screen');
        if(!screen) return;
        screen.classList.add('active');
        if(window.gameState.settings.vib && navigator.vibrate) navigator.vibrate([200,100,500,100,200]);
        launchVictoryStars();
    }

    window.finishGame = function() {
        window.gameState.prestige = true; 
        window.gameState.maxWorld = 26; 
        window.gameState.unlocked = 501; 
        localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
        location.reload(); 
    };

    function launchVictoryStars() {
        const canvas = document.getElementById('victory-canvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let stars = [];
        const colors = ['#FFD700', '#FFFFFF', '#FFA500', '#F0E68C'];
        
        for(let i=0; i<300; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 15 + 5;
            stars.push({
                x: canvas.width / 2, y: canvas.height / 2,
                vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
                radius: Math.random() * 4 + 2,
                color: colors[Math.floor(Math.random() * colors.length)],
                alpha: 1, decay: Math.random() * 0.02 + 0.005
            });
        }
        function draw() {
            if(!document.getElementById('victory-screen').classList.contains('active')) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'lighter';
            for(let i = stars.length - 1; i >= 0; i--) {
                let p = stars[i];
                p.x += p.vx; p.y += p.vy; p.alpha -= p.decay;
                if(p.alpha <= 0) { stars.splice(i, 1); continue; }
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${parseInt(p.color.slice(1,3),16)}, ${parseInt(p.color.slice(3,5),16)}, ${parseInt(p.color.slice(5,7),16)}, ${p.alpha})`;
                ctx.fill();
            }
            if(stars.length > 0) requestAnimationFrame(draw);
        }
        draw();
    }

    let secretTapCount = 0; let secretTapTimer = null;
    window.settings = {
        open: () => { 
            document.getElementById('settings-screen').classList.add('active'); 
            document.getElementById('toggle-vib').checked = window.gameState.settings.vib; 
            const backup = localStorage.getItem('mq_2d_backup');
            const btnExit = document.getElementById('btn-exit-dev');
            if (backup) { btnExit.style.display = 'block'; btnExit.innerText = "QUITTER LE MODE TEST"; } 
            else { btnExit.style.display = 'none'; }
        },
        triggerSecret: () => {
            secretTapCount++;
            if(secretTapTimer) clearTimeout(secretTapTimer);
            secretTapTimer = setTimeout(() => { secretTapCount = 0; }, 1000);
            if(secretTapCount >= 5) {
                let password = prompt("üïµÔ∏è MODE D√âVELOPPEUR\nEntrez le code d'acc√®s :");
                if(password === "4321") { window.settings.openDevTools(); } 
                else if (password !== null) { alert("‚õî Code incorrect."); }
                secretTapCount = 0;
            }
        },
        openDevTools: () => {
            if (!localStorage.getItem('mq_2d_backup')) { localStorage.setItem('mq_2d_backup', JSON.stringify(window.gameState)); }
            let lvlInput = prompt("1/3 - D√âBLOQUER JUSQU'AU NIVEAU (Max 500)", window.gameState.unlocked);
            if (lvlInput === null) return;
            let newLevel = parseInt(lvlInput) || 1;
            let totalStars = 0;
            if(window.gameState.stars) Object.values(window.gameState.stars).forEach(s => totalStars += s);
            let starsInput = prompt("2/3 - DONNER COMBIEN D'√âTOILES ? (Max 1500)", totalStars);
            if (starsInput === null) return;
            let targetStars = parseInt(starsInput) || 0;
            let maxWorldInput = prompt("3/3 - MONDE MAXIMUM VISIBLE (Mets 25)", window.gameState.maxWorld);
            if (maxWorldInput === null) return;
            let newMaxWorld = parseInt(maxWorldInput) || 1;

            window.gameState.unlocked = newLevel;
            window.gameState.maxWorld = newMaxWorld;
            window.gameState.settings.creative = false;
            window.gameState.stars = {};
            let starsGiven = 0;
            for(let i = 1; i <= 500; i++) { 
                if(starsGiven < targetStars) { 
                    let give = Math.min(3, targetStars - starsGiven); 
                    window.gameState.stars[i] = give; 
                    starsGiven += give; 
                } 
            }
            localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
            window.settings.close();
            renderMainMenu();
        },
        exitDevMode: () => {
            let backup = localStorage.getItem('mq_2d_backup');
            if (backup) { 
                window.gameState = JSON.parse(backup); 
                localStorage.setItem('mq_2d', backup); 
                localStorage.removeItem('mq_2d_backup'); 
                document.body.classList.remove('prestige-mode');
                window.settings.close(); 
                renderMainMenu(); 
            }
        },
        save: () => { window.gameState.settings.vib = document.getElementById('toggle-vib').checked; localStorage.setItem('mq_2d', JSON.stringify(window.gameState)); },
        close: () => { document.getElementById('settings-screen').classList.remove('active'); secretTapCount = 0; },
        resetData: () => { if(confirm("Tout effacer ?")) { localStorage.removeItem('mq_2d'); localStorage.removeItem('mq_2d_backup'); location.reload(); } }
    };

    function calculateTimeForLevel(lvl) { let world = Math.ceil(lvl / 20); return (window.gameState.settings.creative ? 2 : 20) * (5 + world); }
    function startTimer() { if(timerInterval) clearInterval(timerInterval); const bar = document.getElementById('g-timer-bar'); bar.className = "timer-bar-fill"; bar.style.width = "100%"; timerInterval = setInterval(() => { timeLeft--; let pct = (timeLeft / totalTimeAllowed) * 100; bar.style.width = pct + "%"; if(pct < 30) bar.className = "timer-bar-fill low"; else if(pct < 60) bar.className = "timer-bar-fill medium"; if(timeLeft <= 0) { clearInterval(timerInterval); window.game.gameOver(); } }, 1000); }
    
    window.triggerUnlock = function(w, e) {
        if(e) e.stopPropagation(); 
        if (window.gameState.settings.vib && navigator.vibrate) navigator.vibrate([100, 50, 100]);
        const flash = document.getElementById('flash-effect');
        flash.classList.add('active');
        setTimeout(() => {
            window.gameState.maxWorld = w;
            let firstLevel = (w - 1) * 20 + 1;
            if (window.gameState.unlocked < firstLevel) window.gameState.unlocked = firstLevel;
            localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
            renderMainMenu();
            enterWorld(w);
            setTimeout(() => { flash.classList.remove('active'); }, 500);
        }, 300);
    }

    window.game = {
        closeWorld: () => { document.getElementById('world-detail-screen').classList.remove('active'); renderMainMenu(); },
        open: (lvl) => {
            if (!window.gameState.settings.creative && !window.gameState.prestige) { 
                if (window.gameState.lives <= 0) { alert("üíî PLUS DE VIES !"); return; } 
            }
            targetScore = window.gameState.settings.creative ? 2 : 20;
            currentScore = 0; totalTimeAllowed = calculateTimeForLevel(lvl); timeLeft = totalTimeAllowed;
            document.getElementById('g-target-txt').innerText = targetScore;
            window.game.updateUI(0); window.game.nextQuestion(lvl); document.getElementById('g-lvl-num').innerText = lvl;
            document.getElementById('game-screen').classList.add('active');
            startTimer();
        },
        nextQuestion: (lvl) => {
            if(typeof generateProblem === "function") {
                let pb = generateProblem(lvl); currentSession = { lvl: lvl, ...pb };
                document.getElementById('g-quest').innerHTML = formatText(currentSession.q);
                document.getElementById('g-instr').innerText = currentSession.instr || ""; 
                document.getElementById('g-inp').innerText = "";
            }
        },
        updateUI: (score) => { document.getElementById('g-prog-bar').style.width = (score / targetScore) * 100 + "%"; document.getElementById('g-prog-txt').innerText = score; },
        gameOver: () => { 
            if (!window.gameState.settings.creative && !window.gameState.prestige) {
                if (window.gameState.lives > 0) {
                    window.gameState.lives--;
                    if (window.gameState.lives === MAX_LIVES - 1) { window.gameState.lastLifeTime = Date.now(); }
                    localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
                    updateLivesSystem();
                }
            }
            if(timerInterval) clearInterval(timerInterval);
            showResultModal('loose', 0, currentSession.hint);
        },
        close: () => { if(timerInterval) clearInterval(timerInterval); document.getElementById('game-screen').classList.remove('active'); currentSession = null; let currentWorld = Math.ceil((parseInt(document.getElementById('g-lvl-num').innerText))/20); enterWorld(currentWorld); },
        closeFromModal: () => { document.getElementById('result-modal').classList.remove('active'); window.game.close(); },
        tap: (k) => { 
            if(window.gameState.settings.vib && navigator.vibrate) navigator.vibrate(10); 
            if(k === ',') k = '.'; 
            let d = document.getElementById('g-inp'); if(!d) return; 
            if(k === 'DEL') d.innerText = d.innerText.slice(0, -1); else if(d.innerText.length < 8) d.innerText += k; 
        },
        validate: () => {
            if(!currentSession) return; 
            let d = document.getElementById('g-inp'); let screen = document.getElementById('game-screen'); let rawInput = d.innerText;
            if (currentSession.format === 'decimal' && rawInput.includes('/')) { d.classList.add('shake'); screen.classList.add('error-flash'); setTimeout(() => { d.classList.remove('shake'); screen.classList.remove('error-flash'); }, 1000); return; }
            let userAns; if(rawInput.includes('/')) { let parts = rawInput.split('/'); userAns = parts.length === 2 ? parseFloat(parts[0]) / parseFloat(parts[1]) : NaN; } else { userAns = parseFloat(rawInput.replace(',','.')); } 
            
            // CORRECTION VALIDATION
            if(!isNaN(userAns)) userAns = parseFloat(userAns.toFixed(6));
            
            if(userAns === currentSession.a) {
                currentScore++; window.game.updateUI(currentScore);
                if(currentScore >= targetScore) {
                    clearInterval(timerInterval); 
                    let ratio = timeLeft / totalTimeAllowed; 
                    let starsWon = ratio > 0.6 ? 3 : (ratio > 0.3 ? 2 : 1);
                    
                    if(currentSession.lvl === window.gameState.unlocked) window.gameState.unlocked++;
                    if(starsWon > (window.gameState.stars[currentSession.lvl] || 0)) window.gameState.stars[currentSession.lvl] = starsWon;
                    localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
                    setTimeout(() => { showResultModal('win', starsWon, currentSession.hint); }, 200);
                } else { window.game.nextQuestion(currentSession.lvl); }
            } else { 
                let currentWorld = Math.ceil(currentSession.lvl / 20);
                let penalty = 1.0 + (currentWorld - 1) * 0.1;
                penalty = parseFloat(penalty.toFixed(1));
                timeLeft -= penalty;
                let floater = document.createElement('div');
                floater.className = 'penalty-float';
                floater.innerText = `-${penalty}s`;
                screen.appendChild(floater);
                setTimeout(() => floater.remove(), 800);
                let bar = document.getElementById('g-timer-bar');
                let pct = (timeLeft / totalTimeAllowed) * 100;
                if (pct < 0) pct = 0;
                bar.style.width = pct + "%";
                d.classList.add('shake'); screen.classList.add('error-flash'); 
                setTimeout(() => { d.classList.remove('shake'); screen.classList.remove('error-flash'); window.game.nextQuestion(currentSession.lvl); }, 400); 
            }
        }
    };

    window.enterWorld = function(w) {
        const detailScreen = document.getElementById('world-detail-screen');
        const scrollArea = document.getElementById('detail-scroll-area');
        scrollArea.innerHTML = "";
        let wConfig = WORLDS_CONFIG[w-1];
        if(wConfig && wConfig.img) detailScreen.style.backgroundImage = `url('${wConfig.img}')`;
        
        let line = document.createElement('div'); line.className = 'path-line-detail'; scrollArea.appendChild(line);
        let maxLvl = w * 20; let minLvl = (w - 1) * 20 + 1;
        let isCreative = window.gameState.settings.creative;

        for(let i = maxLvl; i >= minLvl; i--) {
            let btn = document.createElement('div'); btn.className = 'lvl-btn';
            
            // --- LOGIQUE MONDE 26 (PRESTIGE) ---
            if (w === 26) {
                btn.classList.add('legend');
                let isLocked = (i > window.gameState.unlocked) && !isCreative;
                
                if (isLocked) {
                    btn.classList.add('locked');
                    btn.innerHTML = `<div style="font-size:1.2rem; opacity:0.5;">üîí</div>`;
                } else {
                    btn.innerHTML = `<span style="z-index:2">LEGEND</span>`;
                    let stars = window.gameState.stars[i] || 0;
                    if (stars > 0) { 
                        btn.classList.add('completed'); 
                        btn.innerHTML += `<div class="stars-icon">üëë</div>`; 
                    } else if (i === window.gameState.unlocked) {
                        btn.classList.add('current');
                        btn.id = 'current-level-btn-detail'; 
                    }
                    btn.onclick = () => window.game.open(i);
                }
            } 
            // --- LOGIQUE STANDARD (MONDES 1-25) ---
            else {
                let stars = window.gameState.stars[i] || 0;
                let isLocked = (i > window.gameState.unlocked) && !isCreative;
                
                if (isLocked) { 
                    btn.classList.add('locked'); 
                    btn.innerHTML = `<div style="font-size:1.2rem; opacity:0.5;">üîí</div>`; 
                } else {
                    btn.innerHTML = `<span style="z-index:2">${i}</span>`;
                    if(stars > 0) { 
                        btn.innerHTML += `<div class="stars-icon">${"‚≠ê".repeat(stars)}</div>`; 
                        btn.classList.add('completed'); 
                    }
                    if(i === window.gameState.unlocked && !isCreative) { 
                        btn.classList.add('current'); 
                        btn.id = 'current-level-btn-detail'; 
                    }
                    btn.onclick = () => window.game.open(i);
                }
            }
            scrollArea.appendChild(btn);
        }
        
        detailScreen.classList.add('active');
        setTimeout(() => { 
            const currentBtn = document.getElementById('current-level-btn-detail'); 
            if(currentBtn) currentBtn.scrollIntoView({block: "center", behavior: "smooth"}); 
            else { scrollArea.scrollTop = scrollArea.scrollHeight; } 
        }, 100);
    }

    function renderMainMenu() {
        const container = document.getElementById('grid-container');
        if(!container) return;
        container.innerHTML = "";
        let totalStars = getTotalStars();
        let isCreative = window.gameState.settings.creative;
        let currentMaxWorld = window.gameState.maxWorld;
        let isPrestige = window.gameState.prestige;

        let visibleLimit = isPrestige ? 26 : Math.min(25, currentMaxWorld + 1);
        let hasUnlockReady = false; 

        // --- BOUTON VERS L'INFINI ---
        if (!isPrestige && currentMaxWorld >= 25) {
            let gate = document.createElement('div');
            gate.className = 'energy-gate';
            if (totalStars >= 1500) {
                gate.classList.add('ready');
                gate.innerHTML = `<div class="energy-title">VERS L'INFINI</div><div class="energy-val">ENTRER</div>`;
                gate.onclick = window.triggerVictorySequence; 
                document.body.classList.add('ready-for-ascension');
            } else {
                gate.classList.add('locked');
                gate.innerHTML = `<div class="energy-title">√âNERGIE REQUISE</div><div class="energy-val">${totalStars} / 1500 ‚≠ê</div>`;
            }
            container.appendChild(gate);
        }

        // --- BOUCLE DES MONDES ---
        for(let w = visibleLimit; w >= 1; w--) {
            let worldCard = document.createElement('div'); worldCard.className = 'world-card-global';
            let isUnlocked = (w <= currentMaxWorld) || isCreative || isPrestige;
            
            if (!isUnlocked) worldCard.classList.add('locked-next');
            let wConfig = WORLDS_CONFIG[w-1];
            if(wConfig && wConfig.img) worldCard.style.backgroundImage = `url('${wConfig.img}')`;
            
            let infoDiv = document.createElement('div'); infoDiv.className = 'world-info-global';
            let title = document.createElement('div'); title.className = 'world-title-global';
            let worldName = (wConfig && wConfig.name) ? wConfig.name : `MONDE ${w}`;
            title.innerHTML = `<span style="font-size:0.7em; opacity:0.8; display:block; margin-bottom:5px;">MONDE ${w}</span>${worldName}`;
            infoDiv.appendChild(title);
            
            if (isUnlocked) {
                let worldStars = 0; let maxLvl = w * 20; let minLvl = (w - 1) * 20 + 1;
                for(let k = minLvl; k <= maxLvl; k++) worldStars += (window.gameState.stars[k] || 0);
                let status = document.createElement('div'); status.className = 'world-status-global'; status.innerText = `${worldStars} / 60 ‚≠ê`;
                infoDiv.appendChild(status); worldCard.appendChild(infoDiv); worldCard.onclick = () => enterWorld(w);
            } else {
                let starsNeeded = getStarsRequired(w); let prevLevelsDone = isWorldFullyCompleted(w); let canUnlock = (totalStars >= starsNeeded && prevLevelsDone);
                if (canUnlock) hasUnlockReady = true;
                let gate = document.createElement('div'); gate.className = 'gate-locked';
                let btn = document.createElement('div'); btn.className = 'btn-unlock-world';
                let mainText = "ZONE INCONNUE"; let starIcon = "‚òÖ";
                if (canUnlock) { mainText = "D√âBLOQUER"; starIcon = "‚≠ê"; btn.classList.add('ready'); btn.onclick = (e) => window.triggerUnlock(w, e); } 
                else if (!prevLevelsDone && totalStars >= starsNeeded) { mainText = "FINIR MONDE PR√âC√âDENT"; }
                btn.innerHTML = `<span style="z-index:2">${mainText}</span><span class="req-stars" style="z-index:2">${totalStars} / ${starsNeeded} ${starIcon}</span>`;
                gate.appendChild(btn); worldCard.appendChild(gate);
            }
            container.appendChild(worldCard);
        }
        document.getElementById('ui-stars').innerText = totalStars;
        if (hasUnlockReady) document.body.classList.add('unlock-mode'); else document.body.classList.remove('unlock-mode');
    }

    // GESTION CLAVIER PHYSIQUE
    document.addEventListener('keydown', (e) => {
        if(currentSession) {
            if(e.key >= '0' && e.key <= '9') window.game.tap(e.key); 
            // MODIFICATION ICI : On accepte le point (.) ET la virgule (,)
            else if(e.key === '.' || e.key === ',') window.game.tap('.'); 
            else if(e.key === '/' || e.key === ':') window.game.tap('/'); 
            else if(e.key === 'Backspace') window.game.tap('DEL'); 
            else if(e.key === 'Enter') window.game.validate();
        }
        if(e.key === 'Escape') {
            if(document.getElementById('game-screen').classList.contains('active')) { window.game.close(); return; }
            if(document.getElementById('world-detail-screen').classList.contains('active')) { window.game.closeWorld(); return; }
            if(document.getElementById('settings-screen').classList.contains('active')) { window.settings.close(); return; }
            window.settings.open(); 
        }
    });

    (function() {
        const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d'); let width, height;
        let particles = []; const particleCount = 60; class Particle { constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.vx = (Math.random() - 0.5) * 0.15; this.vy = (Math.random() - 0.5) * 0.15; this.radius = Math.random() * 1.5 + 0.5; } update() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > width) this.vx *= -1; if (this.y < 0 || this.y > height) this.vy *= -1; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fill(); } }
        let shootingStars = []; class ShootingStar { constructor() { this.x = Math.random() * width; this.y = Math.random() * height * 0.4; this.length = Math.random() * 100 + 100; this.speed = Math.random() * 2 + 1; this.angle = Math.PI / 4 + (Math.random()-0.5)*0.2; this.opacity = 1; const colors = ['0,255,255', '255,200,50', '200,100,255']; this.colorBase = colors[Math.floor(Math.random() * colors.length)]; } update() { this.x += Math.cos(this.angle) * this.speed; this.y += Math.sin(this.angle) * this.speed; this.opacity -= 0.005; } draw() { if(this.opacity <= 0) return; const tailX = this.x - Math.cos(this.angle) * this.length; const tailY = this.y - Math.sin(this.angle) * this.length; const gradient = ctx.createLinearGradient(this.x, this.y, tailX, tailY); gradient.addColorStop(0, `rgba(${this.colorBase}, ${this.opacity})`); gradient.addColorStop(1, `rgba(${this.colorBase}, 0)`); ctx.shadowBlur = 15; ctx.shadowColor = `rgb(${this.colorBase})`; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tailX, tailY); ctx.strokeStyle = gradient; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke(); ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fillStyle = `rgba(255,255,255, ${this.opacity})`; ctx.fill(); ctx.shadowBlur = 0; } }
        let celestialObjects = []; class CelestialObject { constructor() { this.x = Math.random() * width; this.y = height + 300; this.radius = Math.random() * 400 + 300; this.vy = (Math.random() * 0.1 + 0.05) * -1; this.opacity = 0; this.fadeIn = true; const palettes = [ {c1:'50, 0, 100', c2:'0, 50, 150'}, {c1:'100, 50, 0', c2:'150, 50, 0'}, {c1:'0, 100, 100', c2:'0, 50, 150'} ]; this.palette = palettes[Math.floor(Math.random() * palettes.length)]; } update() { this.y += this.vy; if(this.fadeIn) { this.opacity += 0.001; if(this.opacity >= 0.25) this.fadeIn = false; } else { this.opacity -= 0.0002; } } draw() { if(this.opacity <= 0) return; ctx.globalCompositeOperation = 'lighter'; const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius); gradient.addColorStop(0, `rgba(${this.palette.c1}, ${this.opacity})`); gradient.addColorStop(0.6, `rgba(${this.palette.c2}, ${this.opacity*0.5})`); gradient.addColorStop(1, `rgba(0,0,0,0)`); ctx.fillStyle = gradient; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2); ctx.fill(); ctx.globalCompositeOperation = 'source-over'; } }
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; particles = []; for (let i = 0; i < particleCount; i++) particles.push(new Particle()); }
        window.addEventListener('resize', resize); resize();
        function animate() { ctx.clearRect(0, 0, width, height); if(Math.random() < 0.001) shootingStars.push(new ShootingStar()); if(celestialObjects.length === 0 && Math.random() < 0.0005) celestialObjects.push(new CelestialObject()); celestialObjects.forEach((obj, index) => { obj.update(); obj.draw(); if(obj.opacity <= 0 && !obj.fadeIn) celestialObjects.splice(index, 1); }); shootingStars.forEach((star, index) => { star.update(); star.draw(); if(star.opacity <= 0) shootingStars.splice(index, 1); }); for (let i = 0; i < particles.length; i++) { particles[i].update(); particles[i].draw(); for (let j = i + 1; j < particles.length; j++) { let dx = particles[i].x - particles[j].x; let dy = particles[i].y - particles[j].y; let dist = Math.sqrt(dx * dx + dy * dy); if (dist < 150) { ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.strokeStyle = `rgba(255,255,255,${0.4 * (1 - dist / 150)})`; ctx.lineWidth = 0.8; ctx.stroke(); } } } requestAnimationFrame(animate); }
        animate();
    })();

    // Lancer imm√©diatement la boucle de vie au d√©marrage et le rendu
    // Active le mode prestige si le jeu a d√©j√† √©t√© fini
    if (window.gameState.prestige) {
        document.body.classList.add('prestige-mode');
    }
    updateLivesSystem();
    renderMainMenu();
</script>
</body>
</html>